---
title: "Cloud coverage (`cld`)"
output:
  github_document:
    pandoc_args: --webtex
  html_document:
    df_print: paged
  pdf_document:
    extra_dependencies:
    - float
    - longtable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/cld-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 'latex' else 'pandoc'
})

# Set path to working directory
path <- "~/Desktop/iCloud/UoR/Data/CRU/4.04/"

`%>%` <- magrittr::`%>%`

ALPHA <- 0.25
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

```{r, eval = TRUE, echo = FALSE, cache = TRUE}
path <- "~/Desktop/iCloud/UoR/Data/CRU/4.04/"
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), "cld")$data
cld <- rowMeans(cld, dims = 2)
# sf <- 1 - cld / 100
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), "elv")$data
mi <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-mi.nc"), "mi")$data
Tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"), "tmp")$data
vpd <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-vpd-tmp-gs.nc"), "vpd")$data
# Apply ice mask
cld[codos:::ice_mask] <- NA
mi[codos:::ice_mask] <- NA
Tmp[codos:::ice_mask] <- NA
vpd[codos:::ice_mask] <- NA
lat <- codos::lat
lon <- codos::lon
lat_lon <- data.frame(i = seq_len(length(lon$data)),
                      j = rep(seq_along(lat$data), each = length(lon$data)))

# cld[Tmp < 5] <- NA
# mi[Tmp < 5] <- NA
# Tmp[Tmp < 5] <- NA
```

<!-- ## Create long vectors of `cld`, `MI`, `Tmp` and `VPD` -->
```{r, echo = FALSE}
# Cloud coverage
cld_cat <- 
  ifelse(is.na(cld), "UNK",
    ifelse(cld >= 0 & cld <= 10, "0-10",
      ifelse(cld > 10 & cld <= 20, "10-20",
        ifelse(cld > 20 & cld <= 30, "20-30",
          ifelse(cld > 30 & cld <= 40, "30-40",
            ifelse(cld > 40 & cld <= 50, "40-50",
              ifelse(cld > 50 & cld <= 60, "50-60",
                ifelse(cld > 60 & cld <= 70, "60-70",
                  ifelse(cld > 70 & cld <= 80, "70-80",
                    ifelse(cld > 80 & cld <= 90, "80-90", "90-100"))))))))))
cld_long <- matrix(cld, nrow = 1, byrow = TRUE)
cld_long_cat <- matrix(cld_cat, nrow = 1, byrow = TRUE)

# Moisture index
mi_cat <- ifelse(is.na(mi), "UNK", 
            ifelse(mi >= 0 & mi <= 0.5, "0-0.5",
              ifelse(mi > 0.5 & mi <= 1, "0.5-1",
                ifelse(mi > 1 & mi <= 1.5, "1-1.5",
                  ifelse(mi > 1.5 & mi < 2, "1.5-2", "2+")))))
mi_long <- matrix(mi, nrow = 1, byrow = TRUE)
mi_long_cat <- matrix(mi_cat, nrow = 1, byrow = TRUE)

# Temperature
Tmp_cat <- ifelse(is.na(Tmp), "UNK",
            ifelse(Tmp >= 0 & Tmp <= 5, "0-5",
              ifelse(Tmp > 5 & Tmp <= 10, "5-10",
                ifelse(Tmp > 10 & Tmp <= 15, "10-15",
                  ifelse(Tmp > 15 & Tmp <= 20, "15-20",
                    ifelse(Tmp > 20 & Tmp <= 25, "20-25",
                      ifelse(Tmp > 25 & Tmp <= 30, "25-30",
                        ifelse(Tmp > 30 & Tmp <= 35, "30-35", "35+"))))))))
Tmp_long <- matrix(Tmp, nrow = 1, byrow = TRUE)
Tmp_long_cat <- matrix(Tmp_cat, nrow = 1, byrow = TRUE)
vpd_long <- matrix(vpd, nrow = 1, byrow = TRUE)

# Assemble data frame
df <- tibble::tibble(CLD = cld_long[1, ],
                     MI = mi_long[1, ],
                     Tmp = Tmp_long[1, ], 
                     vpd = vpd_long[1, ],
                     cld = as.factor(cld_long_cat[1, ]),
                     mi = as.factor(mi_long_cat[1, ]),
                     tmp = factor(Tmp_long_cat[1, ], c("0-5", "5-10", "10-15", 
                                                     "15-20", "20-25", "25-30", 
                                                     "30-35", "35+", "UNK")))

# Filter rows with all NAs
df <- df %>%
  dplyr::filter(!is.na(CLD),
                !is.na(MI),
                !is.na(Tmp),
                !is.na(vpd))

# Print subset
# head(df) %>%
#   knitr::kable()
```

## Fit models

```{r}
# Subset data
set.seed(1)
idx <- sample(seq_len(nrow(df)), size = floor(nrow(df) * 0.7), replace = FALSE)
df_train <- df[idx, ]
df_test <- df[-idx, ]
```

### `cld` vs `vpd`

##### Linear regression
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# j <- 181
# i <- mi[, j] > mi_min & mi[, j] <= mi_max & !is.na(mi[, j])
# ip <- mi[, j + 1] > mi_min & mi[, j + 1] <= mi_max & !is.na(mi[, j + 1])
# 
# df_train <- data.frame(vpd = vpd[i, j], vpd = vpd[i, j])
# df_test <-  data.frame(vpd = vpd[ip, j + 1], vpd = vpd[ip, j + 1])

# Build the model
model <- lm(CLD ~ vpd, df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- 
  tibble::tibble(model = "lm", 
                 RMSE = caret::RMSE(predictions, df_test$CLD), 
                 R2 = caret::R2(predictions, df_test$CLD))
# model_summary <- model_summary  %>%
#   rbind(c("lm", 
#           caret::RMSE(predictions, df_test$CLD),
#           caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ x)

summary(model)
```

<!-- `r cat(paste0("$$cld = ", round(coefficients(model)[1], 4), ifelse(coefficients(model)[2] < 0, " - ", " + "), round(abs(coefficients(model)[2]), 4), " \\times vpd$$"))` -->

##### Polynomial regression
##### 2nd degree
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ poly(vpd, 2, raw = TRUE), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("poly - 2nd deg", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ poly(x, 2, raw = TRUE))

summary(model)
```

##### 3rd degree
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ poly(vpd, 3, raw = TRUE), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("poly - 3rd deg", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ poly(x, 3, raw = TRUE))

summary(model)
```

##### Log transformation
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ log(vpd), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))
model_summary <- model_summary  %>%
  rbind(c("log (ln)", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ log(x))

summary(model)
```

##### Spline regression
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ splines2::bSpline(vpd,df = 3), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))
model_summary <- model_summary  %>%
  rbind(c("spline", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ splines::bs(x, df = 3))

summary(model)
```

##### Generalized additive models (GAM)
```{r, echo = FALSE, eval = TRUE}
# Build the model
model <- mgcv::gam(CLD ~ s(vpd), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("GAM", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point() +
  # ggplot2::labs(title = main, x = xlab, y = ylab) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = "gam", formula = y ~ s(x, k = 100))

summary(model)
```

##### Summary
```{r, echo = FALSE}
knitr::kable(model_summary)
```

### `cld` vs `MI`

##### Linear regression
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ MI, df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- 
  tibble::tibble(model = "lm", 
                 RMSE = caret::RMSE(predictions, df_test$CLD), 
                 R2 = caret::R2(predictions, df_test$CLD))
# model_summary <- model_summary  %>%
#   rbind(c("lm", 
#           caret::RMSE(predictions, df_test$CLD),
#           caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(MI, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ x)

summary(model)
```

<!-- `r cat(paste0("$$cld = ", round(coefficients(model)[1], 4), ifelse(coefficients(model)[2] < 0, " - ", " + "), round(abs(coefficients(model)[2]), 4), " \\times MI$$"))` -->
  
##### Polynomial regression
##### 2nd degree
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ poly(MI, 2, raw = TRUE), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("poly - 2nd deg", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(MI, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ poly(x, 2, raw = TRUE))

summary(model)
```

##### 3rd degree
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ poly(MI, 3, raw = TRUE), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("poly - 3rd deg", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(MI, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ poly(x, 3, raw = TRUE))

summary(model)
```

##### Log transformation
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ log(MI + 1), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))
model_summary <- model_summary  %>%
  rbind(c("log (ln [x + 1])", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(MI, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ log(x + 1))

summary(model)
```

##### Spline regression
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ splines2::bSpline(MI,df = 3), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))
model_summary <- model_summary  %>%
  rbind(c("spline", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(MI, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ splines::bs(x, df = 3))

summary(model)
```

##### Generalized additive models (GAM)
```{r, echo = FALSE, eval = TRUE}
# Build the model
model <- mgcv::gam(CLD ~ s(MI), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("GAM", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(MI, CLD)) +
  ggplot2::geom_point() +
  # ggplot2::labs(title = main, x = xlab, y = ylab) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = "gam", formula = y ~ s(x, k = 100))

summary(model)
```

##### Summary
```{r, echo = FALSE}
knitr::kable(model_summary)
```

### `cld` vs `vpd` and `Tmp`

##### Linear regression
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ vpd + Tmp, df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- 
  tibble::tibble(model = "lm", 
                 RMSE = caret::RMSE(predictions, df_test$CLD), 
                 R2 = caret::R2(predictions, df_test$CLD))

vpd_test <- seq(0, max(df$vpd), 1)
tmp_test <- c(2.5, 7.5, 12.5, 17.5, 22.5, 27.5, 32.5)
tmp_labs <- c("0-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30-35")

co <- coefficients(model)
df2 <- 
  tibble::tibble(x = rep(vpd_test, length(tmp_test)),
                 y = purrr::map(tmp_test,
                                ~ co[1] + co[2] * vpd_test + co[3] * .x) %>% purrr::flatten_dbl(),
                 z = rep(tmp_labs,
                          each = length(vpd_test))) %>%
  dplyr::filter(y >= 0)

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(ggplot2::aes(colour = tmp), alpha = ALPHA) +
  ggplot2::geom_line(data = df2, ggplot2::aes(x = x, y = y, color = z)) +
  ggplot2::geom_point(data = df2, ggplot2::aes(x = x, y = y)) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::labs(title = paste0("cld = ",
                               round(co[1], 3),
                               ifelse(co[2] >= 0, " + ", " - "),
                               abs(round(co[2], 3)),
                               " vpd ",
                               ifelse(co[3] >= 0, " + ", " - "),
                               abs(round(co[3], 3)),
                               " Tmp"),
                x = "vpd [hPa]", y = "cld [%]") +
  # ggplot2::scale_color_brewer(name = "Tmp [°C]", 
  #                             palette = "Spectral", 
  #                             direction = -1) +
  ggplot2::scale_color_brewer(name = "Tmp [°C]",
                              palette = "Set1") +
  ggplot2::theme_bw()

summary(model)
```

##### Polynomial regression
##### 2nd degree
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ poly(vpd, 2, raw = TRUE), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("poly - 2nd deg", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ poly(x, 2, raw = TRUE))

summary(model)
```

##### 3rd degree
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ poly(vpd, 3, raw = TRUE), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("poly - 3rd deg", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ poly(x, 3, raw = TRUE))

summary(model)
```

##### Log transformation
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ log(vpd), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))
model_summary <- model_summary  %>%
  rbind(c("log (ln)", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ log(x))

summary(model)
```

##### Spline regression
```{r, echo = FALSE, eval = TRUE, cache = TRUE}
# Build the model
model <- lm(CLD ~ splines2::bSpline(vpd,df = 3), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))
model_summary <- model_summary  %>%
  rbind(c("spline", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point(alpha = ALPHA) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = lm, formula = y ~ splines::bs(x, df = 3))

summary(model)
```

##### Generalized additive models (GAM)
```{r, echo = FALSE, eval = TRUE}
# Build the model
model <- mgcv::gam(CLD ~ s(vpd), data = df_train)
# Make predictions
predictions <- predict(model, df_test)
# Model performance
knitr::kable(data.frame(
  RMSE = caret::RMSE(predictions, df_test$CLD),
  R2 = caret::R2(predictions, df_test$CLD)
))

model_summary <- model_summary  %>%
  rbind(c("GAM", 
          caret::RMSE(predictions, df_test$CLD),
          caret::R2(predictions, df_test$CLD)))

ggplot2::ggplot(df_train, ggplot2::aes(vpd, CLD)) +
  ggplot2::geom_point() +
  # ggplot2::labs(title = main, x = xlab, y = ylab) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_color_brewer(palette = "Set1") +
  ggplot2::theme_bw() +
  ggplot2::stat_smooth(method = "gam", formula = y ~ s(x, k = 100))

summary(model)
```

##### Summary
```{r, echo = FALSE}
knitr::kable(model_summary)
```


### `cld` vs `MI` and `Tmp`

```{r, echo = FALSE, eval = FALSE}
lmod1 <- lm(CLD ~ vpd, data = df_train)

## Start with a simple model to find the start points
lmod <- lm(log(vpd) ~ Tmp * MI,# poly(Tmp, 2) + poly(MI, 2),
           data = df_train)

model1 <- nls(vpd ~ a * exp(kTmp * Tmp - kMI * MI + kMITmp * MI * Tmp) + b,
              df_train,
              start = list(a = exp(coef(lmod)[1]),
                           kTmp = coef(lmod)[2],
                           kMI = coef(lmod)[3],
                           kMITmp = coef(lmod)[4],
                           b = 0),
              control = list(maxiter = 200))


a <- coef(model1)[1]
kTmp <- coef(model1)[2]
kMI <- coef(model1)[3]
kMITmp <- coef(model1)[4]
b <- coef(model1)[5]
```
