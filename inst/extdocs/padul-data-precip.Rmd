---
title: "Padul Data: MI and Precip. corrections"
output: 
  pdf_document:
    extra_dependencies: ["float", "longtable"]
    latex_engine: xelatex
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 600, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/padul-mi-pr-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

options(knitr.kable.NA = '',
        knitr.kable.format = "pandoc")

# Set path to working directory
path <- "~/OneDrive - University of Reading/UoR/Data/CRU/4.04/"
`%>%` <- magrittr::`%>%`
`%$%` <- magrittr::`%$%`
options(warn = 1) 
# Load padul data
# padul <- readr::read_csv("~/Desktop/iCloud/UoR/Data/padul.csv")
padul <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/padul.csv") %>%
  magrittr::set_colnames(c("age_cal_yr_BP", colnames(.)[-1]))

ref_idx <- 5:9 # -40 < age < -10

theme_pet <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey20"),
                 panel.grid = ggplot2::element_line(colour = "grey92"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey85",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "white", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")

theme_pet_black <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey2"),
                 panel.grid = ggplot2::element_line(colour = "grey20"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "grey2", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

## Calculate daily temperature (modern)

CRU TS 4.04 daily interpolations from monthly data:

```{r, eval = FALSE}
path <- "/path/to/CRU/4.04/"
tmin <- file.path(path, "cru_ts4.04.1901.2019.tmn.dat-clim-1961-1990-int.nc")
tmax <- file.path(path, "cru_ts4.04.1901.2019.tmx.dat-clim-1961-1990-int.nc")
output_filename <- file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp.nc")
codos::daily_temp(tmin = list(filename = tmin, id = "tmn"),
                  tmax = list(filename = tmax, id = "tmx"),
                  output_filename = output_filename)
```

##### Output file
```
"cru_ts4.04-clim-1961-1990-daily.tmp.nc"
```

## Calculate mean growing season for daily temperature (`tmp`)
```{r, eval = FALSE}
codos::nc_gs("cru_ts4.04-clim-1961-1990-daily.tmp.nc", "tmp", thr = 0, cpus = 10)
```

##### Output file
```
"cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"
```

Padul location: 37.0108, -3.6039

```{r}
Tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "tmp")
lat <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "lat")
lon <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "lon")
idx_y <- which.min(abs(lat$data - 37.0108))
idx_x <- which.min(abs(lon$data + 3.6039))

aux <- Tmp$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(aux) <- lat$data[c(idx_y, idx_y - 1)]
colnames(aux) <- lon$data[c(idx_x, idx_x + 1)]
aux
(modern_tmp <- mean(aux))
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Reconstruct past temperature from `T_djf` and `T_jja`:
```{r, eval = FALSE}
padul <- readr::read_csv("/path/to/padul.csv")
```

#### Calculate daily mean temperature
```{r}
padul_tmp <- rowMeans(padul[, c("T_djf", "T_jja")])
```

## Obtain past CO2 from (Bereiter et al. 2015)

```{r}
past_co2 <- purrr::map_dbl(padul$age_cal_yr_BP, codos::past_co2)
```

## Obtain modern CO2 from (Bereiter et al. 2015)

```{r}
modern_co2 <- tibble::tibble(age = 1950 - c(1961:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %>%
  .$co2 %>%
  median()
```

```{r modern_co2_20th, echo = FALSE}
modern_co2_20th <- tibble::tibble(age = 1950 - c(1901:1990),
                                  co2 = purrr::map_dbl(age, codos::past_co2)) %>%
  .$co2 %>%
  median()
```

## Assemble the Padul data
```{r}
padul2 <- tibble::tibble(age_calBP = padul$age_cal_yr_BP,
                         past_temp = padul_tmp,
                         past_co2 = past_co2,
                         modern_co2 = modern_co2, # 340,
                         present_t = padul_tmp, # modern_tmp, 
                         recon_mi = padul$MI)
```

## Find the corrected `MI`
```{r}
padul2$corr_mi <- codos::corrected_mi(padul2$present_t,
                                           padul2$past_temp,
                                           padul2$recon_mi,
                                           padul2$modern_co2,
                                           padul2$past_co2)
```

```{r, echo = FALSE}
padul2$corr_mi_20th <- codos::corrected_mi(padul2$present_t,
                                           padul2$past_temp,
                                           padul2$recon_mi,
                                           modern_co2_20th,
                                           padul2$past_co2)
# Small subset
knitr::kable(head(padul2, 5),
             col.names = c("age cal yr BP",
                           "past temp",
                           "past co2",
                           "modern co2",
                           "present temp",
                           "recon. MI",
                           "corr. MI",
                           "corr. MI (20th)"))
```

Check out and download the entire dataset in [Appendix A5](#a5-padul-data).

## Find the corrected Annual Precipitation, `P_ann`

<!-- Approximated as the ratios of potential evapotranspiration (`Ep`) and moisture index (`MI`), multiplied by the reconstructed annual precipitation, $\text{P}_\text{ann, 0}$: -->

<!-- $$\text{P}_\text{ann, 1} = \frac{\text{MI}_1}{\text{MI}_0} \times \frac{\text{Ep}_1}{\text{Ep}_0} \times \text{P}_\text{ann, 0}$$ -->
<!-- The ratio of evapotranspiration (`Ep`) is given by -->
<!-- $$\frac{\text{Ep}_1}{\text{Ep}_0} = \left(\frac{\text{vpd}_1}{\text{vpd}_0}\right) \times \frac{[(1 + \text{MI}_0^\omega)^{(1 / \omega)} - \text{MI}_0]}{[(1 + \text{MI}_1^\omega)^{(1 / \omega)} - \text{MI}_1]}$$ -->

<!--   where: -->

<!--   - $\text{vpd}_0$ and $\text{vpd}_1$ are the values of vapour pressure deficit (reconstructed and corrected, respectively) -->
<!--   - $\text{MI}_0$ amd $\text{MI}_1$ are the values of moisture index (reconstructed and corrected, respectively) -->
<!--   - $\omega$ is a constant equals to `3`. -->


```{r, echo = FALSE, eval = FALSE}
MI0 <- padul2$recon_mi
MI1 <- padul2$corr_mi
vpd0 <- codos:::vpd_internal(padul2$past_temp, MI0)
vpd1 <- codos:::vpd_internal(padul2$present_t, MI1)
o <- 3
ep_ratio <- (vpd1 / vpd0) * ((1 + MI0 ^ o)^(1 / o) - MI0) / ((1 + MI1 ^ o)^(1 / o) - MI1)
mi_ratio <- MI1 / MI0
padul2$corr_P_ann <- padul$P_ann * ep_ratio * mi_ratio
```

Approximated as the ratio

$$\text{MI}_\text{ratio}= \frac{\text{corrected}}{\text{reconstructed}}$$
multiplied by reconstructed `P_ann`.

```{r}
mi_ratio <- padul2$corr_mi / padul2$recon_mi
padul2$corr_P_ann <- padul$P_ann * mi_ratio
```

```{r, echo = FALSE}
padul2$corr_P_ann_20th <- padul$P_ann * padul2$corr_mi_20th / padul2$recon_mi
```

```{r, echo = TRUE}
padul2 %>% 
  write.csv(file = "padul-with-corrected-mi.csv",
            row.names = FALSE)

# Small subset
knitr::kable(head(padul2, 13),
             col.names = c("age cal yr BP",
                           "past temp",
                           "past co2",
                           "modern co2",
                           "present temp",
                           "recon. MI",
                           "corr. MI",
                           "corr. MI (20th)",
                           "corr. Pann",
                           "corr. Pann (20th)"))
```

Check out and download the entire dataset in [Appendix A5](#a5-padul-data).

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- # Modern PET -->

```{r, echo = FALSE}
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), 
                          "elv")
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), 
                          "cld")$data
tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.daily.tmp.nc"), 
                          "tmp")$data
pre <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.pre.dat-new-clim-1961-1990-int.nc"),
                          "pre")$data
sf <- 1 - cld / 100

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - 37.0108))
idx_x <- which.min(abs(codos::lon$data + 3.6039))

# Extract elevation subset
padul_elv <- elv$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(padul_elv) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_elv) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_elv <- mean(padul_elv)

# Extract sunshine fraction subset
padul_sf <- sf[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_sf) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_sf) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_sf <- colMeans(padul_sf, dims = 2)

# Extract cloud coverage subset
padul_cld <- cld[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_cld) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_cld) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_cld <- colMeans(padul_cld, dims = 2)

# Extract temperature subset
padul_tmp <- tmp[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_tmp) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_tmp) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_tmp <- colMeans(padul_tmp, dims = 2)

# Extract precipitation subset
padul_pre <- pre[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_pre) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_pre) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_pre <- colMeans(padul_pre, dims = 2)
```

```{r, echo = FALSE}
# Delete large objects from the environment
rm(elv, cld, pre, sf, tmp)
```

```{r, echo = FALSE}
year <- 1961
padul_pet_modern <- seq_len(365) %>%
  purrr::map_dbl(function(i) {
    splash::calc_daily_evap(lat = 37.0108,
                            n = i,
                            elv = padul_elv,
                            y = year,
                            sf = padul_sf[i],
                            tc = padul_tmp[i])$pet_mm
 })
```


```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_modern[1][[1]],
                     padul_pet_modern[169][[1]],
                     padul_pet_modern[272][[1]]),
               age = rep(c(padul$age_cal_yr_BP[1],
                           padul$age_cal_yr_BP[169], 
                           padul$age_cal_yr_BP[272]),
                         each = 365) %>%
                 as.factor()) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line(ggplot2::aes(colour = age)) +
  ggplot2::scale_colour_brewer("Age (cal yr BP)", palette = "Set1") +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  ggplot2::theme_bw()
``` 



```{r, echo = FALSE, eval = TRUE}
# tibble::tibble(x = seq_len(365),
#                y = padul_pet_modern) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y)) +
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = TRUE}
knitr::asis_output('\n\n\\newpage')
```

#### Comparison of modern CO2

```{r, echo = FALSE}
tibble::tibble(x = c("1901 - 2000", 
                     "1961 - 1990"),
               y = c(modern_co2_20th,
                     modern_co2)) %>%
  knitr::kable(col.names = c("Years", "avg. CO2"))

tibble::tibble(x = rep(padul2$age_calBP, 3), 
               y = c(padul2$recon_mi, padul2$corr_mi, padul2$corr_mi_20th), 
               var = rep(c("Reconstructed", "CO2: 1961-1990", "CO2: 1901-2000"), 
                         each = nrow(padul2))
               ) %>% 
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) + 
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "[cal yr BP]", y = "MI [-]") +
  theme_pet

tibble::tibble(x = rep(padul2$age_calBP, 3), 
               y = c(padul$P_ann, padul2$corr_P_ann, padul2$corr_P_ann_20th), 
               var = rep(c("Reconstructed", "CO2: 1961-1990", "CO2: 1901-2000"), 
                         each = nrow(padul2))
               ) %>% 
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) + 
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "[cal yr BP]", y = "P_ann [mm]") +
  theme_pet
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = TRUE}
knitr::asis_output('\n\n\\newpage')
```

# New corrections

## Calculate temperature anomalies

Using both $T_\text{djf}$ and $T_\text{jja}$ for each record, a sinusoidal curve
was fitted using the `int_sin` function.

```{r, echo = TRUE}
padul <- padul %>%
  dplyr::mutate(Tmean = (T_jja + T_djf) / 2) %>%
  dplyr::mutate(Tmax = Tmean + (T_jja - Tmean) / 0.9) %>%
  dplyr::mutate(Tmin = Tmean + (T_djf - Tmean) / 0.9)
```

```{r, echo = FALSE}
padul_modern <- padul %>%
  dplyr::slice(ref_idx) %>%
  dplyr::select(-1) %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean))
```

```{r, echo = FALSE, fig.height = 5}
codos::int_sin(padul_modern$Tmin, padul_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul_modern$T_djf),
                          ggplot2::aes(x, y, colour = "T_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul_modern$T_jja),
                          ggplot2::aes(x, y, colour = "T_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = "'Modern' padul (avg. for -10 < age < -40") +
      ggplot2::theme_bw()
```

Rows `r min(ref_idx)`:`r max(ref_idx)` were used as the baseline to calculate the temperature anomalies.

```{r, echo = FALSE}
padul %>%
  dplyr::slice(ref_idx) %>%
  rbind(c(NA, mean(.$MI), mean(.$P_ann), mean(.$T_djf), mean(.$T_jja), mean(.$Tmean), mean(.$Tmax), mean(.$Tmin))) %>%
  knitr::kable()
```

where
$$T_\text{mean} = (T_\text{jja} + T_\text{djf}) / 2$$
$$T_\text{max} = T_\text{mean} + (T_\text{jja} - T_\text{mean}) / 0.9$$
$$T_\text{min} = T_\text{mean} + (T_\text{djf} - T_\text{mean}) / 0.9$$

```{r, echo = TRUE}
padul_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map(~codos::int_sin(padul$Tmin[.x] - padul_modern$Tmin,
                             padul$Tmax[.x] - padul_modern$Tmax))
```                         

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: Anomaly for age = `r padul[169, 1]` cal yr BP
```{r, fig.height = 5, echo = FALSE}
codos::int_sin(padul$Tmin[169] - padul_modern$Tmin, 
               padul$Tmax[169] - padul_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[169] - padul_modern$T_djf),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[169] - padul_modern$T_jja),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      ggplot2::theme_bw()
```

Padul: Anomaly for age = `r padul[272, 1]` cal yr BP
```{r, fig.height = 5, echo = FALSE}
codos::int_sin(padul$Tmin[272] - padul_modern$Tmin, 
               padul$Tmax[272] - padul_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[272] - padul_modern$T_djf),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[272] - padul_modern$T_jja),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate potential evapotranspiration (PET)

Padul location: 37.0108, -3.6039

```{r pet-w-tmp-anomalies, cache = TRUE, echo = FALSE, eval = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet_tmp <- seq_along(padul_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf[i],
                                             tc = padul_tmp[i] + padul_anomalies[[k]][i])$pet_mm
                                             # tc = padul$Tmean[k] + 
                                             #   padul_anomalies[[k]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

<!-- #### Using SPLASH v2.0.0 -->
```{r, cache = TRUE, echo = FALSE, eval = FALSE}
year <- 1961
padul_lat <- 37.0108
oplan <- future::plan(future::multisession, workers = 5)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_sw <- seq_along(padul_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_solar(lat = padul_lat,
                                              n = i,
                                              elv = padul_elv,
                                              y = year,
                                              sf = padul_sf[i],
                                              tc = padul_tmp[i] + 
                                                padul_anomalies[[k]][i])$ra_j.m2 #rnl_w.m2
                   }) / 24 / 3600 # Divide by 24 hours, then 3600 seconds
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

##### Params (`splash::calc_daily_evap`)

- Latitude: `37.0108`
- Elevation: `r padul_elv`
- Year: `1961`
- Sunshine fraction: [`CRU TS 4.04`]
- Temperature: [`CRU TS 4.04`] $+ T_\text{anomalies}$
<!-- - Temperature: $T_\text{mean, i}$ (`r padul[169, "Tmean"]`) $+ T_\text{anomalies, i, day}$ -->

```{r, echo = FALSE}
padul_soil_data <-c(sand = 0, # sand(perc)
                    clay = 0, # clay(perc)
                    OM = 0, # organic matter(perc)
                    gravel = 0, # coarse-fragments-fraction(perc)
                    bulk_dens = NA, # bulk density(g cm-3), bd
                    maxdepth = 0) # depth
```

```{r, echo = FALSE, cache = TRUE, eval = FALSE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet_tmp <- seq_along(padul_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    # Create core time series object: solar radiation (sw), temperature(tc), and precipitation (pn)
    core <- tibble::tibble(
      time = lubridate::as_date(lubridate::ymd("1961-01-01"):lubridate::ymd("1961-12-31")),
      sw_in = padul_sw[[k]],
      tc = padul_tmp + padul_anomalies[[k]],
      pn = padul_pre
    ) %>%
      tidyr::pivot_longer(c(sw_in, tc, pn), "id") %>%
      tsbox::ts_xts()
    
    # Combine core data with soil data for Padul
    padul_data <- list(core = core,
                       lat = padul_lat,
                       elev = padul_elv,
                       slop = 0,
                       asp = 0,
                       soil_data = padul_soil_data,
                       Au = 0,
                       resolution = 250.)
    
    suppressWarnings({
    # Run SPLASH and return PET
    aux <- padul_data %$% 
      rsplash::splash.point(
        sw_in = core$sw_in,     # shortwave radiation W/m2
        tc = core$tc,		        # air temperature C
        pn = core$pn,           # precipitation mm
        lat = lat,		          # latitude deg
        elev = elev,		        # elevation masl
        slop = slop,	          # slope deg
        asp = asp,		          # aspect deg
        soil_data = soil_data, 	# soil data: sand,clay,som in w/w %. Gravel v/v %, bulk density g/cm3, and depth to the bedrock (m)**
        Au = Au,		            # upslope area m2
        resolution = resolution # resolution pixel dem used to get Au
      )
    })
    # aux
    aux$pet %>%
      as.numeric()
    # aux$aet %>%
    #   as.numeric())
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_tmp[169][[1]],
                     padul_pet_tmp[272][[1]],
                     padul_pet_modern),
               age = rep(c(padul$age_cal_yr_BP[169], 
                           padul$age_cal_yr_BP[272],
                           "[CRU TS 4.04]"),
                         each = 365) %>%
                 as.factor()) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line(ggplot2::aes(colour = age)) +
  ggplot2::scale_colour_brewer("Age (cal yr BP)", palette = "Set1") +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

<!-- Padul: PET for age = `r padul[2, 1]` cal yr BP -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_pet_tmp[2][[1]]) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

<!-- Padul: PET for age = `r padul[272, 1]` cal yr BP -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_pet_tmp[272][[1]]) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate corrected Precipitation

Using corrected MI and PET (calculated from modern temperature [CRU TS 4.04] and Padul temperature anomalies).

$$\text{corrected P}_\text{ann} = \text{MI} \times \text{PET}_\text{ann}$$

```{r, echo = FALSE}
padul_corrected_pr <- purrr::map_dbl(seq_along(padul_pet_tmp),
                                     ~sum(padul_pet_tmp[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
padul_corrected_pr_20th <- purrr::map_dbl(seq_along(padul_pet_tmp),
                                     ~sum(padul_pet_tmp[.x][[1]], na.rm = TRUE) * padul2$corr_mi_20th[.x])
```

```{r, echo = FALSE}
padul_corrected_pr2 <- purrr::map_dbl(seq_along(padul_pet_tmp),
                                      ~sum(padul_pet_tmp[.x][[1]], na.rm = TRUE) * padul$MI[.x])
```

```{r, echo = FALSE}
padul %>%
  dplyr::select(1:3) %>%
  dplyr::mutate(corr_mi = padul2$corr_mi,
                `corr_P_ann (MI ratio)` = padul2$corr_P_ann,
                `corr_P_ann (Tmp anomalies)` = padul_corrected_pr) %>%
  dplyr::slice(c(1:15), c(100:105), c(175:180), c(275:280), c(430:438)) %>%
  knitr::kable() # "pandoc", col.names = c(names(.)[1:5], "corrected MI", "corrected P_ann (MI ratio)", "corrected P_ann (Tmp anomalies)"))
```

<!-- ## Calculate MI -->

<!-- Using modern precipitation [CRU TS 4.04] and the PET (calculated from modern temperature [CRU TS 4.04] and the Padul temperature anomalies). -->

```{r, echo = FALSE}
pr <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.pre.dat-new-clim-1961-1990-int.nc"), "pre")$data

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - 37.0108))
idx_x <- which.min(abs(codos::lon$data + 3.6039))

# Extract precipitation subset
padul_pr <- pr[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_pr) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_pr) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_pr <- colMeans(padul_pr, dims = 2)

rm(pr)
padul_mi <- purrr::map_dbl(padul_pet_tmp,
                           ~sum(padul_pr, na.rm = TRUE) / sum(.x, na.rm = TRUE))
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate cloud coverage from corrected MI

```{r, eval = FALSE, echo = FALSE}
padul_cld_recon_mi <- padul$MI %>%
  purrr::map_dbl(codos::cld)
```

```{r}
padul_cld_corr_mi <- padul2$corr_mi %>%
  purrr::map_dbl(codos::cld)
```

Padul: cloud coverage
```{r, echo = FALSE}
tibble::tibble(x = padul$age_cal_yr_BP,
               y = padul_cld_corr_mi) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "Cloud coverage [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::theme_bw()
```


### Calculate cloud coverage anomalies

Rows `r min(ref_idx)`:`r max(ref_idx)` were used as the baseline to calculate the anomalies:

```{r, echo = FALSE}
ref_pdul_cld_corr_mi <- padul_cld_corr_mi %>%
  .[ref_idx] %>%
  mean()
```

```{r}
padul_cld_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map_dbl(~padul_cld_corr_mi[.x] - ref_pdul_cld_corr_mi)
```

Padul: cloud coverage anomalies
```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = padul$age_cal_yr_BP,
               y = padul_cld_anomalies) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "Cloud coverage anomalies [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::theme_bw()
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Re-calculate potential evapotranspiration (PET)

```{r pet-cld-only, cache = TRUE, echo = FALSE}
year <- 1961
padul_sf2 <- 1 - (padul_cld_corr_mi + padul_cld_anomalies) / 100

oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_cld_corr_mi))
padul_pet_cld <- 
  seq_along(padul_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
padul_corrected_pr_cld <- 
  purrr::map_dbl(seq_along(padul_pet_cld),
                 ~sum(padul_pet_cld[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
padul_corrected_pr_cld_20th <- 
  purrr::map_dbl(seq_along(padul_pet_cld),
                 ~sum(padul_pet_cld[.x][[1]], na.rm = TRUE) * padul2$corr_mi_20th[.x])
```

After including temperature and cloud coverage anomalies.

```{r pet-tmp-cld, cache = TRUE, echo = FALSE}
year <- 1961
padul_sf2 <- 1 - (padul_cld_corr_mi + padul_cld_anomalies) / 100

oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_cld_corr_mi))
padul_pet_tmp_cld <- 
  seq_along(padul_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i] +
                                               padul_anomalies[k][[1]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

Padul: PET for age = `r padul[169, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_modern,
                     padul_pet_tmp[169][[1]],
                     padul_pet_tmp_cld[169][[1]]),
               var = rep(c("[CRU TS 4.04]",
                           "Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_pet
``` 


Padul: PET for age = `r padul[272, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_modern,
                     padul_pet_tmp[272][[1]],
                     padul_pet_tmp_cld[272][[1]]),
               var = rep(c("[CRU TS 4.04]",
                           "Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_pet
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = TRUE}
knitr::asis_output('\n\n\\newpage')
```

## Re-calculate corrected precipitation

```{r}
padul_corrected_pr_tmp_cld <- purrr::map_dbl(seq_along(padul_pet_tmp_cld),
                                         ~sum(padul_pet_tmp_cld[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
```


```{r, echo = FALSE}
padul_corrected_pr_tmp_cld_20th <- purrr::map_dbl(seq_along(padul_pet_tmp_cld),
                                         ~sum(padul_pet_tmp_cld[.x][[1]], na.rm = TRUE) * padul2$corr_mi_20th[.x])
```

```{r, echo = FALSE}
padul2 %>%
  dplyr::mutate(corr_P_ann = padul_corrected_pr_tmp_cld) %>%
  dplyr::slice(c(1:5), 162:172, c(272:280)) %>%
  knitr::kable("pandoc")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- Padul: reconstructed MI vs MI with anomalies -->

```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$MI, 
                     padul_mi, 
                     padul_mi2),
               var = rep(c("Reconstructed", 
                           "With Tmp anomalies",
                           "With Tmp + cld anomalies"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```


## PET with orbital parameters
### Find orbital parameters

Selected samples and their orbital parameters:
```{r orbital-oarams, echo = FALSE, message = FALSE, fig.height = 10}
padul_years <- as.integer(padul$age_cal_yr_BP)
# Find orbital parameters
# padul_orb_params <- padul_years %>%
#   purrr::map_df(palinsol::astro, solution = palinsol::ber78, degree = TRUE)
# 
# # Append the years to the table with the orbital parameters
# padul_orb_params <- padul_orb_params %>%
#   dplyr::mutate(year = padul_years, .before = 1)

padul_orb_params <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/padul-orbital-params.csv")

# Print table with the first 10 rows
padul_orb_params %>%
  dplyr::slice(1:4, 113, 169, 272, 438) %>%
  knitr::kable()

padul_orb_params %>%
  tidyr::pivot_longer(cols = c(eps, ecc, varpi, epsp),
                      names_to = "var") %>%
  ggplot2::ggplot(ggplot2::aes(year / 1000, value)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::scale_x_reverse(breaks = seq(0, 200, 10),
                              labels = seq(0, 200, 10)) +
                              # scales::pretty_breaks(20)) +
  ggplot2::labs(x = "Age [kcal yrs BP]") +
  ggplot2::facet_wrap(facets = ~var, 
                      scales = "free",
                      labeller = ggplot2::labeller(var = c("ecc" = "Eccentricity (ecc)",
                                                           "eps" = "Obliquity (eps)",
                                                           "varpi" = "True Solar Longitude of the Perihelion (varpi)",
                                                           "epsp" = "(epsp)"))) +
  ggplot2::theme_bw()
```

```{r, cache = TRUE, echo = FALSE, eval = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet_orb_params <- seq_along(padul_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = padul_years[k],
                                             sf = padul_sf[i],
                                             tc = padul_tmp[i],
                                             ke = padul_orb_params$ecc[k],
                                             keps = padul_orb_params$eps[k],
                                             komega = padul_orb_params$varpi[k])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)

padul_corrected_pr_orb_params <- 
  purrr::map_dbl(seq_along(padul_pet_orb_params),
                 ~sum(padul_pet_orb_params[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
padul_corrected_pr_orb_params_20th <- 
  purrr::map_dbl(seq_along(padul_pet_orb_params),
                 ~sum(padul_pet_orb_params[.x][[1]], na.rm = TRUE) * padul2$corr_mi_20th[.x])
```


```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r, eval = FALSE, echo = FALSE}
padul_pet_orb_params_mean <- padul_pet_orb_params %>%
  purrr::map_dbl(~mean(.x, na.rm = TRUE))
tibble::tibble(x = rep(padul_years, 2),
               y = c(padul_pet_modern, padul_pet_orb_params_mean),
               var = c("[CRU TS 4.04]", "With orbitals")) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "PET", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "PET [mm]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- Padul: PET for age = `r padul[169, 1]` cal yr BP -->
```{r, echo = FALSE, eval = FALSE}
# tibble::tibble(x = rep(seq_len(365), 4),
#                y = c(padul_pet_modern,
#                      padul_pet_tmp[169][[1]],
#                      padul_pet_tmp_cld[169][[1]],
#                      padul_pet_orb_params[169][[1]]),
#                var = rep(c("[CRU TS 4.04]",
#                            "Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters",
#                                    "[CRU TS 4.04]"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::scale_colour_brewer(name = "Adjustment", palette = "Set1") + 
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_pet
``` 

<!-- Padul: PET for age = `r padul[272, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 4),
#                y = c(padul_pet_modern,
#                      padul_pet_tmp[272][[1]],
#                      padul_pet_tmp_cld[272][[1]],
#                      padul_pet_orb_params[272][[1]]),
#                var = rep(c("[CRU TS 4.04]",
#                            "Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters",
#                                    "[CRU TS 4.04]"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::scale_colour_brewer(name = "Adjustment", palette = "Set1") + 
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_pet
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ### PET change -->
<!-- Padul: PET for age = `r padul[169, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 3),
#                y = c(padul_pet_tmp[169][[1]] - padul_pet_modern,
#                      padul_pet_tmp_cld[169][[1]] - padul_pet_modern,
#                      padul_pet_orb_params[169][[1]] - padul_pet_modern),
#                var = rep(c("Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") + 
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_pet
``` 

<!-- Padul: PET for age = `r padul[272, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 3),
#                y = c(padul_pet_tmp[272][[1]] - padul_pet_modern,
#                      padul_pet_tmp_cld[272][[1]] - padul_pet_modern,
#                      padul_pet_orb_params[272][[1]] - padul_pet_modern),
#                var = rep(c("Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") + 
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_pet
``` 


```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ## PET with temperature and cloud coverage anomalies and orbital parameters  -->

```{r pet-ultimate, cache = TRUE, echo = FALSE, eval = TRUE}
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_cld_corr_mi))
padul_pet_ultimate <- 
  seq_along(padul_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i] +
                                               padul_anomalies[k][[1]][i],
                                             ke = padul_orb_params$ecc[k],
                                             keps = padul_orb_params$eps[k],
                                             komega = padul_orb_params$varpi[k])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)

padul_corrected_pr_ultimate <- purrr::map_dbl(seq_along(padul_pet_ultimate),
                                     ~sum(padul_pet_ultimate[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
padul_corrected_pr_ultimate_20th <- purrr::map_dbl(seq_along(padul_pet_ultimate),
                                     ~sum(padul_pet_ultimate[.x][[1]], na.rm = TRUE) * padul2$corr_mi_20th[.x])
```

<!-- Padul: PET for age = `r padul[169, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 5),
#                y = c(padul_pet_modern,
#                      padul_pet_tmp[169][[1]],
#                      padul_pet_tmp_cld[169][[1]],
#                      padul_pet_orb_params[169][[1]],
#                      padul_pet_ultimate[169][[1]]),
#                var = rep(c("[CRU TS 4.04]",
#                            "Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters",
#                            "Tmp + Cld anomalies & orbital params"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters",
#                                    "[CRU TS 4.04]",
#                                    "Tmp + Cld anomalies & orbital params"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   # ggsci::scale_colour_locuszoom(name = "") +
#   ggplot2::scale_colour_brewer(name = "", palette = "Set1") +
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_pet
#   # ggplot2::theme_bw()
``` 

<!-- Padul: PET for age = `r padul[272, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 5),
#                y = c(padul_pet_modern,
#                      padul_pet_tmp[272][[1]],
#                      padul_pet_tmp_cld[272][[1]],
#                      padul_pet_orb_params[272][[1]],
#                      padul_pet_ultimate[272][[1]]),
#                var = rep(c("[CRU TS 4.04]",
#                            "Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters",
#                            "Tmp + Cld anomalies & orbital params"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters",
#                                    "[CRU TS 4.04]",
#                                    "Tmp + Cld anomalies & orbital params"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   # ggsci::scale_colour_locuszoom(name = "") +
#   ggplot2::scale_colour_brewer(name = "", palette = "Set1") +
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_pet
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots
### Modern PET
Obtained from CRU TS 4.04
```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = seq_len(365),
               y = padul_pet_modern) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  ggplot2::theme_bw()
```

### PET changes
Padul: PET for age = `r padul[1, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 5),
               y = c(padul_pet_tmp[1][[1]] - padul_pet_modern,
                     padul_pet_cld[1][[1]] - padul_pet_modern,
                     padul_pet_tmp_cld[1][[1]] - padul_pet_modern,
                     padul_pet_orb_params[1][[1]] - padul_pet_modern,
                     padul_pet_ultimate[1][[1]] - padul_pet_modern),
               var = rep(c("Tmp anomalies",
                           "Cld anomalies",
                           "Tmp + Cld anomalies",
                           "Orbital parameters",
                           "Tmp + Cld anomalies & orbital params"),
                         each = 365) %>%
                 factor(levels = c("Tmp anomalies", 
                                   "Cld anomalies",
                                   "Orbital parameters",
                                   "Tmp + Cld anomalies", 
                                   "Tmp + Cld anomalies & orbital params"))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  # ggsci::scale_colour_locuszoom(name = "") +
  ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_pet
  # ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: PET for age = `r padul[169, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 5),
               y = c(padul_pet_tmp[169][[1]] - padul_pet_modern,
                     padul_pet_cld[169][[1]] - padul_pet_modern,
                     padul_pet_tmp_cld[169][[1]] - padul_pet_modern,
                     padul_pet_orb_params[169][[1]] - padul_pet_modern,
                     padul_pet_ultimate[169][[1]] - padul_pet_modern),
               var = rep(c("Tmp anomalies",
                           "Cld anomalies",
                           "Tmp + Cld anomalies",
                           "Orbital parameters",
                           "Tmp + Cld anomalies & orbital params"),
                         each = 365) %>%
                 factor(levels = c("Tmp anomalies", 
                                   "Cld anomalies",
                                   "Orbital parameters",
                                   "Tmp + Cld anomalies", 
                                   "Tmp + Cld anomalies & orbital params"))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  # ggsci::scale_colour_locuszoom(name = "") +
  ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_pet
  # ggplot2::theme_bw()
```

Padul: PET for age = `r padul[272, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 5),
               y = c(padul_pet_tmp[272][[1]] - padul_pet_modern,
                     padul_pet_cld[272][[1]] - padul_pet_modern,
                     padul_pet_tmp_cld[272][[1]] - padul_pet_modern,
                     padul_pet_orb_params[272][[1]] - padul_pet_modern,
                     padul_pet_ultimate[272][[1]] - padul_pet_modern),
               var = rep(c("Tmp anomalies",
                           "Cld anomalies",
                           "Tmp + Cld anomalies",
                           "Orbital parameters",
                           "Tmp + Cld anomalies & orbital params"),
                         each = 365) %>%
                 factor(levels = c("Tmp anomalies", 
                                   "Cld anomalies",
                                   "Orbital parameters",
                                   "Tmp + Cld anomalies", 
                                   "Tmp + Cld anomalies & orbital params"))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  # ggsci::scale_colour_locuszoom(name = "") +
  ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_pet
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- Padul: modern temperature [CRU TS 4.04] -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_tmp) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Temp [°C]") +
  ggplot2::theme_bw()
```

<!-- Padul: modern cloud coverage [CRU TS 4.04] -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = (1 - padul_sf) * 100) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Sunshine fraction [-]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `MI`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corr_mi,
                     padul2$corr_mi_20th),
               var = rep(c("Reconstructed", 
                           "Corrected",
                           "Corrected (20th century CO2)"), 
                         each = nrow(padul2))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

- `age < 5k`


```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corr_mi,
                     padul2$corr_mi_20th),
               var = rep(c("Reconstructed", 
                           "Corrected",
                           "Corrected (20th century CO2)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corr_mi),
               co2 = rep(padul2$past_co2 / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corr_mi),
               co2 = rep(padul2$past_co2 / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `P_ann`: Past CO2 calculated using `mean`

##### With MI ratio

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann,
                     padul2$corr_P_ann_20th),
               var = rep(c("Reconstructed", 
                           "Corrected",
                           "Corrected (20th century CO2)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", 
                  y = "Annual precipitation [mm/year]") +
    theme_pet
```

- `age < 5k`

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann,
                     padul2$corr_P_ann_20th),
               var = rep(c("Reconstructed", 
                           "Corrected",
                           "Corrected (20th century CO2)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", 
                  y = "Annual precipitation [mm/year]") +
    theme_pet
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ##### Padul: reconstructed annual precipitation vs corrected precipitation with temperature anomalies -->

##### With temperature anomalies

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr,
                     padul_corrected_pr_20th),
               var = rep(c("recon. P_ann", 
                           "With Tmp anomalies", 
                           "With Tmp anomalies (20th century CO2)"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr,
                     padul_corrected_pr_20th),
               var = rep(c("recon. P_ann", 
                           "With Tmp anomalies",
                           "With Tmp anomalies (20th century CO2)"), 
                         each = nrow(padul))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_pet
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### With cloud coverage anomalies

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_cld,
                     padul_corrected_pr_cld_20th),
               var = rep(c("recon. P_ann", 
                           "With Cld anomalies",
                           "With Cld anomalies (20th century CO2)"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_cld,
                     padul_corrected_pr_cld_20th),
               var = rep(c("recon. P_ann", 
                           "With Cld anomalies",
                           "With Cld anomalies (20th century CO2)"), 
                         each = nrow(padul))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_pet
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### With orbital parameters

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_orb_params,
                     padul_corrected_pr_orb_params_20th),
               var = rep(c("recon. P_ann", 
                           "With orbital params",
                           "With orbital params (20th century CO2)"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_orb_params,
                     padul_corrected_pr_orb_params_20th),
               var = rep(c("recon. P_ann", 
                           "With orbital params",
                           "With orbital params (20th century CO2)"), 
                         each = nrow(padul))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_pet
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### With temperature and cloud coverage anomalies

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_tmp_cld,
                     padul_corrected_pr_tmp_cld_20th),
               var = rep(c("recon. P_ann", 
                           "With Tmp + Cld anomalies",
                           "With Tmp + Cld anomalies (20th century CO2)"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_tmp_cld,
                     padul_corrected_pr_tmp_cld_20th),
               var = rep(c("recon. P_ann", 
                           "With Tmp + Cld anomalies",
                           "With Tmp + Cld anomalies (20th century CO2)"), 
                         each = nrow(padul))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_pet
```



```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### With temperature and cloud coverage anomalies and orbital parameters

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_ultimate,
                     padul_corrected_pr_ultimate_20th),
               var = rep(c("recon. P_ann", 
                           "With Tmp and Cld anomalies and orbital params",
                           "With Tmp and Cld anomalies and orbital params (20th century CO2)"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul_corrected_pr_ultimate,
                     padul_corrected_pr_ultimate_20th),
               var = rep(c("recon. P_ann", 
                           "With Tmp and Cld anomalies and orbital params",
                           "With Tmp and Cld anomalies and orbital params (20th century CO2)"),
                         each = nrow(padul))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_pet
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### All the approaches

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(age_cal_yr_BP = padul$age_cal_yr_BP,
               past_temp = padul2$past_temp,
               past_co2 = padul2$past_co2,
               modern_co2 = padul2$modern_co2,
               present_t = padul2$present_t,
               recon_mi = padul2$recon_mi,
               corr_mi = padul2$corr_mi,
               recon_P_ann = padul$P_ann,
               corr_P_ann_MI_ratio = padul2$corr_P_ann,
               corr_P_ann_Tmp_anomalies = padul_corrected_pr,
               corr_P_ann_Cld_anomalies = padul_corrected_pr_cld,
               corr_P_ann_Orbital_params = padul_corrected_pr_orb_params,
               corr_P_ann_Tmp_Cld_anomalies = padul_corrected_pr_tmp_cld,
               corr_P_ann_All = padul_corrected_pr_ultimate) %>%
  readr::write_excel_csv("padul-corrections-2021-06.csv", na = "")
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 7),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann,
                     padul_corrected_pr,
                     padul_corrected_pr_cld,
                     padul_corrected_pr_tmp_cld,
                     padul_corrected_pr_orb_params,
                     padul_corrected_pr_ultimate),
               var = factor(rep(c("reconstructed",
                                 "MI ratio",
                                 "With Tmp anomalies",
                                 "With Cld anomalies",
                                 "With Tmp + Cld anomalies",
                                 "With orbital parameters",
                                 "With Tmp + Cld anomalies and orbital params"), 
                         each = nrow(padul)),
                         levels = c("reconstructed",
                                    "MI ratio",
                                    "With Tmp anomalies",
                                    "With Cld anomalies",
                                    "With orbital parameters",
                                    "With Tmp + Cld anomalies",
                                    "With Tmp + Cld anomalies and orbital params"))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
  ggsci::scale_colour_locuszoom(name = "Precipitation") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet_black
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 7),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann,
                     padul_corrected_pr,
                     padul_corrected_pr_cld,
                     padul_corrected_pr_tmp_cld,
                     padul_corrected_pr_orb_params,
                     padul_corrected_pr_ultimate),
               var = factor(rep(c("reconstructed",
                                 "MI ratio",
                                 "With Tmp anomalies",
                                 "With Cld anomalies",
                                 "With Tmp + Cld anomalies",
                                 "With orbital parameters",
                                 "With Tmp + Cld anomalies and orbital params"), 
                         each = nrow(padul)),
                         levels = c("reconstructed",
                                    "MI ratio",
                                    "With Tmp anomalies",
                                    "With Cld anomalies",
                                    "With orbital parameters",
                                    "With Tmp + Cld anomalies",
                                    "With Tmp + Cld anomalies and orbital params"))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
    ggsci::scale_colour_locuszoom(name = "Precipitation") +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet_black
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### 20th century CO2

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 7),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann,
                     padul_corrected_pr_20th,
                     padul_corrected_pr_cld_20th,
                     padul_corrected_pr_tmp_cld_20th,
                     padul_corrected_pr_orb_params_20th,
                     padul_corrected_pr_ultimate_20th),
               var = factor(rep(c("reconstructed",
                                 "MI ratio",
                                 "With Tmp anomalies",
                                 "With Cld anomalies",
                                 "With Tmp + Cld anomalies",
                                 "With orbital parameters",
                                 "With Tmp + Cld anomalies and orbital params"), 
                         each = nrow(padul)),
                         levels = c("reconstructed",
                                    "MI ratio",
                                    "With Tmp anomalies",
                                    "With Cld anomalies",
                                    "With orbital parameters",
                                    "With Tmp + Cld anomalies",
                                    "With Tmp + Cld anomalies and orbital params"))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
  ggsci::scale_colour_locuszoom(name = "Precipitation") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet_black
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 7),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann,
                     padul_corrected_pr_20th,
                     padul_corrected_pr_cld_20th,
                     padul_corrected_pr_tmp_cld_20th,
                     padul_corrected_pr_orb_params_20th,
                     padul_corrected_pr_ultimate_20th),
               var = factor(rep(c("reconstructed",
                                 "MI ratio",
                                 "With Tmp anomalies",
                                 "With Cld anomalies",
                                 "With Tmp + Cld anomalies",
                                 "With orbital parameters",
                                 "With Tmp + Cld anomalies and orbital params"), 
                         each = nrow(padul)),
                         levels = c("reconstructed",
                                    "MI ratio",
                                    "With Tmp anomalies",
                                    "With Cld anomalies",
                                    "With orbital parameters",
                                    "With Tmp + Cld anomalies",
                                    "With Tmp + Cld anomalies and orbital params"))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
    ggsci::scale_colour_locuszoom(name = "Precipitation") +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet_black
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann_20th,
                     padul_corrected_pr_ultimate_20th),
               var = factor(rep(c("reconstructed",
                                 "MI ratio",
                                 "With Tmp + Cld anomalies and orbital params"), 
                         each = nrow(padul)),
                         levels = c("reconstructed",
                                    "MI ratio",
                                    "With Tmp + Cld anomalies and orbital params"))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
  # ggsci::scale_colour_locuszoom(name = "Precipitation") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

### `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$P_ann, 
                     padul2$corr_P_ann_20th,
                     padul_corrected_pr_ultimate_20th),
               var = factor(rep(c("reconstructed",
                                 "MI ratio",
                                 "With Tmp + Cld anomalies and orbital params"), 
                         each = nrow(padul)),
                         levels = c("reconstructed",
                                    "MI ratio",
                                    "With Tmp + Cld anomalies and orbital params"))) %>%
  dplyr::filter(x < 22000) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
  # ggsci::scale_colour_locuszoom(name = "Precipitation") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_pet
```

```{r, echo = FALSE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 6),
#                y = c(padul$P_ann, 
#                      padul2$corr_P_ann,
#                      padul_corrected_pr,
#                      padul_corrected_pr_tmp_cld,
#                      padul_corrected_pr_orb_params,
#                      padul_corrected_pr_ultimate),
#                var = factor(rep(c("reconstructed",
#                            "MI ratio",
#                            "With Tmp anomalies",
#                            "With Tmp + cld anomalies",
#                            "With orbital parameters",
#                            "With Tmp + cld anomalies and orbital params"), 
#                          each = nrow(padul)),
#                          levels = c("reconstructed",
#                                     "MI ratio",
#                                     "With Tmp anomalies",
#                                     "With Tmp + cld anomalies",
#                                     "With orbital parameters",
#                                     "With Tmp + cld anomalies and orbital params"))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
#   ggsci::scale_colour_locuszoom(name = "Precipitation") +
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   ggplot2::theme_bw()
```

# References

[1] Bereiter, B., Eggleston, S., Schmitt, J., Nehrbass‐Ahles, C., Stocker, T. F.,
Fischer, H., Kipfstuhl, S., and Chappellaz, J. (2015), Revision of the EPICA
Dome C CO2 record from 800 to 600 kyr before present, Geophys. Res. Lett., 
42, 542– 549, <doi:10.1002/2014GL061957>.

# Appendix

## A1. Find reconstructed `MI` using `loess`

```{r}
past_co2_loess <- function(age_calBP, ref = codos::ice_core) {
  # Extract the reference age and co2
  ref_age <- purrr::pluck(ref, 1)
  ref_co2 <- purrr::pluck(ref, 2)
  if (age_calBP < min(ref_age))
    return(ref_co2[which.min(ref_age)])
  
  if (age_calBP > max(ref_age))
    return(ref_co2[which.max(ref_age)])
  loessMod10 <- loess(co2 ~ age_calBP,
                      tibble::tibble(age_calBP = ref_age,
                                     co2 = ref_co2), span = 0.1)
  return(predict(loessMod10, age_calBP))
}

padul2$past_co2_loess <- purrr::map_dbl(padul2$age_calBP, 
                                        past_co2_loess)
padul2$corr_mi_loess <- codos::corrected_mi(padul2$present_t,
                                                 padul2$past_temp,
                                                 padul2$recon_mi,
                                                 padul2$modern_co2,
                                                 padul2$past_co2_loess)

head(padul2, 10) %>%
  dplyr::select(-c(past_co2, corr_mi, corr_P_ann)) %>%
  knitr::kable() %>%
  kableExtra::kable_styling()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A2. Plot reconstructed vs corrected `MI` both approaches

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corr_mi, 
                     padul2$corr_mi_loess),
               var = rep(c("reconstructed", 
                           "corrected (mean)", 
                           "corrected (loess)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corr_mi, 
                     padul2$corr_mi_loess),
               var = rep(c("reconstructed", 
                           "corrected (mean)", 
                           "corrected (loess)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A3. Reconstructed vs corrected `MI`: Past CO2 calculated using `loess`
#### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corr_mi_loess),
               co2 = rep(padul2$past_co2_loess / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corr_mi_loess),
               co2 = rep(padul2$past_co2_loess / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

## A4. Compare  `codos::ice_core` vs past CO2 calculate using `mean` and `loess`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$past_co2,
                     padul2$past_co2_loess),
               var = rep(c("Mean", 
                           "LOESS (span = 0.1)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= max(padul2$age_calBP), ],
                       ggplot2::aes(age_gas_calBP, 
                                    co2_ppm, 
                                    colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", 
                                 values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(10)) +
    ggplot2::labs(x = "Age [cal yrs BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
                     y = c(padul2$past_co2,
                           padul2$past_co2_loess),
                     var = rep(c("Mean", 
                                 "LOESS (span = 0.1)"), 
                               each = nrow(padul2))) %>%
  
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 5000, ],
                       ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

- `age < 500`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
                     y = c(padul2$past_co2,
                           padul2$past_co2_loess),
                     var = rep(c("Mean", 
                                 "LOESS (span = 0.1)"), 
                               each = nrow(padul2))) %>%
  
  .[.$x < 500, ] %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 500, ],
                       ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A5. Padul Data
Download the CSV file: [padul-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/padul-with-corrected-mi.csv)

```{r, echo = FALSE}
padul2 %>%
  dplyr::select(-dplyr::ends_with(("loess"))) %>%
  knitr::kable(longtable = TRUE)
```
