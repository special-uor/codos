---
title: "Padul Data"
output: 
  pdf_document:
    extra_dependencies: ["float", "longtable"]
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/padul-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 'latex' else 'pandoc'
})

# Set path to working directory
path <- "~/Desktop/iCloud/UoR/Data/CRU/4.04/"

# Load padul data
padul <- readr::read_csv("~/Desktop/iCloud/UoR/Data/padul.csv")

`%>%` <- magrittr::`%>%`
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

## Calculate temperature anomalies

Using both $T_\text{djf}$ and $T_\text{jja}$ for each record, a sinusoidal curve
was fitted using the `int_sin` function.

```{r, fig.height = 5}
codos::int_sin(padul$T_djf[1], padul$T_jja[1], plot = TRUE)
```

Row 1 was used as the baseline to calculate the temperature anomalies:
```{r}
padul_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map(~codos::int_sin(padul$T_djf[.x] - padul$T_djf[1],
                             padul$T_jja[.x] - padul$T_jja[1]))
```                      


Padul: Anomaly for age = `r padul[274, 1]` cal yr BP
```{r, fig.height = 5, echo = FALSE}
codos::int_sin(padul$T_djf[274] - padul$T_djf[1], 
               padul$T_jja[274] - padul$T_jja[1], plot = TRUE)
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate potential evapotranspiration (PET)

Padul location: 37.0108, -3.6039

```{r}
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), 
                          "elv")
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), 
                          "cld")$data
tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.daily.tmp.nc"), 
                          "tmp")$data
sf <- 1 - cld / 100

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - 37.0108))
idx_x <- which.min(abs(codos::lon$data + 3.6039))

# Extract elevation subset
padul_elv <- elv$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(padul_elv) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_elv) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_elv <- mean(padul_elv)

# Extract sunshine fraction subset
padul_sf <- sf[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_sf) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_sf) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_sf <- colMeans(padul_sf, dims = 2)

# Extract cloud coverage subset
padul_cld <- cld[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_cld) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_cld) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_cld <- colMeans(padul_cld, dims = 2)

# Extract temperature subset
padul_tmp <- tmp[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_tmp) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_tmp) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_tmp <- colMeans(padul_tmp, dims = 2)
```

```{r, echo = FALSE}
# Delete large objects from the environment
rm(elv, cld, sf, tmp)
```

```{r, cache = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 14)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet <- 
  padul_anomalies %>%
  furrr::future_map(~{
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf[i],
                                             tc = padul_tmp[i] + .x[i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: modern temperature [CRU TS 4.04]
```{r, echo = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_tmp) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Temp [Â°C]") +
  ggplot2::theme_bw()
```

Padul: modern cloud coverage [CRU TS 4.04]
```{r, echo = FALSE}
tibble::tibble(x = seq_len(365),
               y = (1 - padul_sf) * 100) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Sunshine fraction [-]") +
  ggplot2::theme_bw()
```

<!-- Padul: sunshine fraction [CRU TS 4.04] -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_sf) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Sunshine fraction [-]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- Padul: PET for age = `r padul[113, 1]` cal yr BP -->
Padul: PET for age = `r padul[2, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_pet[2][[1]]) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

Padul: PET for age = `r padul[274, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_pet[274][[1]]) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate Precipitation

Using reconstructed MI and PET (calculated from modern temperature [CRU TS 4.04] and Padul temperature anomalies).

```{r}
padul_recon_pr <- purrr::map_dbl(seq_along(padul_pet),
                                  ~sum(padul_pet[.x][[1]], na.rm = TRUE) * padul$MI[.x])
```

```{r, echo = FALSE}
padul %>%
  dplyr::mutate(recon_precip = padul_recon_pr) %>%
  dplyr::slice(c(1:10), c(270:280)) %>%
  knitr::kable("pandoc")
```

<!-- ## Calculate MI -->

<!-- Using modern precipitation [CRU TS 4.04] and the PET (calculated from modern temperature [CRU TS 4.04] and the Padul temperature anomalies). -->

```{r, echo = FALSE}
pr <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.pre.dat-new-clim-1961-1990-int.nc"), "pre")$data

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - 37.0108))
idx_x <- which.min(abs(codos::lon$data + 3.6039))

# Extract precipitation subset
padul_pr <- pr[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_pr) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_pr) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_pr <- colMeans(padul_pr, dims = 2)

rm(pr)
padul_mi <- purrr::map_dbl(padul_pet,
                           ~sum(padul_pr, na.rm = TRUE) / sum(.x, na.rm = TRUE))
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: annual precipitation vs reconstructed precipitation with temperature anomalies

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$`Age (cal yr BP)`, 2),
               y = c(padul$P_ann, 
                     padul_recon_pr),
               var = rep(c("P_ann", 
                           "With Tmp anomalies"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "Precip [mm/day]") +
  ggplot2::theme_bw()
```

### `age < 20k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$`Age (cal yr BP)`, 2),
               y = c(padul$P_ann, 
                     padul_recon_pr),
               var = rep(c("P_ann", 
                           "With Tmp anomalies"), 
                         each = nrow(padul))) %>%
  dplyr::filter(x < 20000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "Precip [mm/day]") +
    ggplot2::theme_bw()
```

<!-- Padul: modern precipitation [CRU TS 4.04] -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_pr) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Precipitation [mm/day]") +
  ggplot2::theme_bw()
```

<!-- Padul: reconstructed MI vs MI with temperature anomalies -->

```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(padul$`Age (cal yr BP)`, 2),
               y = c(padul$MI, 
                     padul_mi),
               var = rep(c("Reconstructed", 
                           "With Tmp anomalies"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate cloud coverage from reconstructed MI

<!-- ## Calculate cloud coverage from MI (with temperature anomalies) -->

```{r, eval = FALSE, echo = FALSE}
padul_cld_recon_mi <- padul$MI %>%
  purrr::map_dbl(codos::cld)
```

```{r}
padul_cld_recon_mi <- padul$MI %>%
  purrr::map_dbl(codos::cld)
```

Padul: cloud coverage
```{r, echo = FALSE}
tibble::tibble(x = padul$`Age (cal yr BP)`,
               y = padul_cld_recon_mi) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "Age [cal yr BP]",
                y = "Cloud coverage [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::theme_bw()
```

### Calculate cloud coverage anomalies

Row 1 was used as the baseline to calculate the anomalies:
```{r}
padul_cld_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map_dbl(~padul_cld_recon_mi[.x] - padul_cld_recon_mi[1])
```

Padul: cloud coverage anomalies
```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = padul$`Age (cal yr BP)`,
               y = padul_cld_anomalies) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "Age [cal yr BP]",
                y = "Cloud coverage anomalies [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::theme_bw()
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Re-calculate potential evapotranspiration (PET)

After including temperature and cloud coverage anomalies.

```{r, cache = TRUE}
year <- 1961
padul_sf2 <- 1 - (padul_cld_recon_mi + padul_cld_anomalies) / 100

oplan <- future::plan(future::multisession, workers = 14)
{p <- progressr::progressor(steps = length(padul_cld_recon_mi))
padul_pet2 <- 
  seq_along(padul_cld) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i] + 
                                               padul_anomalies[k][[1]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```


<!-- Padul: PET for age = `r padul[113, 1]` cal yr BP -->
Padul: PET for age = `r padul[2, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 2),
               y = c(padul_pet[2][[1]],
                     padul_pet2[2][[1]]),
               var = rep(c("Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: PET for age = `r padul[274, 1]` cal yr BP
```{r, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 2),
               y = c(padul_pet[274][[1]],
                     padul_pet2[274][[1]]),
               var = rep(c("Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

<!-- Padul: PET for age = `r padul[399, 1]` cal yr BP -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(seq_len(365), 2),
               y = c(padul_pet[399][[1]],
                     padul_pet2[399][[1]]),
               var = rep(c("Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ## Re-calculate MI -->

```{r, echo = FALSE, eval = FALSE}
padul_mi2 <- purrr::map_dbl(padul_pet2,
                            ~sum(padul_pr, na.rm = TRUE) / sum(.x, na.rm = TRUE))
```

```{r, echo = FALSE, eval = FALSE}
padul %>%
  dplyr::mutate(MI_w_Tmp_anomalies = padul_mi) %>%
  dplyr::mutate(MI_w_Tmp_cld_anomalies = padul_mi2) %>%
  dplyr::slice(c(1:10), c(270:280), c(350:359)) %>%
  knitr::kable("pandoc")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- Padul: reconstructed MI vs MI with anomalies -->

```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(padul$`Age (cal yr BP)`, 3),
               y = c(padul$MI, 
                     padul_mi, 
                     padul_mi2),
               var = rep(c("Reconstructed", 
                           "With Tmp anomalies",
                           "With Tmp + cld anomalies"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate daily temperature (modern)

CRU TS 4.04 daily interpolations from monthly data:

```{r, eval = FALSE}
path <- "/path/to/CRU/4.04/"
tmin <- file.path(path, "cru_ts4.04.1901.2019.tmn.dat-clim-1961-1990-int.nc")
tmax <- file.path(path, "cru_ts4.04.1901.2019.tmx.dat-clim-1961-1990-int.nc")
output_filename <- file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp.nc")
codos::daily_temp(tmin = list(filename = tmin, id = "tmn"),
                  tmax = list(filename = tmax, id = "tmx"),
                  output_filename = output_filename)
```

##### Output file
```
"cru_ts4.04-clim-1961-1990-daily.tmp.nc"
```

## Calculate mean growing season for daily temperature (`tmp`)
```{r, eval = FALSE}
codos::nc_gs("cru_ts4.04-clim-1961-1990-daily.tmp.nc", "tmp", thr = 0, cpus = 10)
```

##### Output file
```
"cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"
```

Padul location: 37.0108, -3.6039

```{r}
Tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "tmp")
lat <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "lat")
lon <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "lon")
idx_y <- which.min(abs(lat$data - 37.0108))
idx_x <- which.min(abs(lon$data + 3.6039))

aux <- Tmp$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(aux) <- lat$data[c(idx_y, idx_y - 1)]
colnames(aux) <- lon$data[c(idx_x, idx_x + 1)]
aux
(modern_tmp <- mean(aux))
```

## Reconstruct past temperature from `T_djf` and `T_jja`:
```{r, eval = FALSE}
padul <- readr::read_csv("/path/to/padul.csv")
```

#### Calculate daily mean temperature
```{r}
padul_tmp <- rowMeans(padul[, c("T_djf", "T_jja")])
```

## Obtain past CO2 from (Bereiter et al. 2015)

```{r}
past_co2 <- purrr::map_dbl(padul$`Age (cal yr BP)`, codos::past_co2)
```

## Obtain modern CO2 from (Bereiter et al. 2015)

```{r}
modern_co2 <- tibble::tibble(age = 1950 - c(1961:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %>%
  .$co2 %>%
  mean()
```

## Assemble the Padul data
```{r}
padul2 <- tibble::tibble(age_calBP = padul$`Age (cal yr BP)`,
                         past_temp = padul_tmp,
                         past_co2 = past_co2,
                         modern_co2 = modern_co2, # 340,
                         present_t = padul_tmp, # modern_tmp, 
                         recon_mi = padul$MI)

```

## Find the corrected `MI`
```{r}
padul2$corrected_mi <- codos::corrected_mi(padul2$present_t,
                                           padul2$past_temp,
                                           padul2$recon_mi,
                                           padul2$modern_co2,
                                           padul2$past_co2)
# Small subset
knitr::kable(head(padul2, 7))
```

Check out and download the entire dataset in [Appendix A5](#a5-padul-data).


## P_ann with tmp anomalies
```{r}
padul_recon_pr <- purrr::map_dbl(seq_along(padul_pet),
                                  ~sum(padul_pet[.x][[1]], na.rm = TRUE) * padul2$corrected_mi[.x])
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$`Age (cal yr BP)`, 2),
               y = c(padul$P_ann, 
                     padul_recon_pr),
               var = rep(c("P_ann", 
                           "With Tmp anomalies"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "Precip [mm/day]") +
  ggplot2::theme_bw()
```

## Find the corrected Annual Precipitation, `P_ann`

<!-- Approximated as the ratios of potential evapotranspiration (`Ep`) and moisture index (`MI`), multiplied by the reconstructed annual precipitation, $\text{P}_\text{ann, 0}$: -->

<!-- $$\text{P}_\text{ann, 1} = \frac{\text{MI}_1}{\text{MI}_0} \times \frac{\text{Ep}_1}{\text{Ep}_0} \times \text{P}_\text{ann, 0}$$ -->
<!-- The ratio of evapotranspiration (`Ep`) is given by -->
<!-- $$\frac{\text{Ep}_1}{\text{Ep}_0} = \left(\frac{\text{vpd}_1}{\text{vpd}_0}\right) \times \frac{[(1 + \text{MI}_0^\omega)^{(1 / \omega)} - \text{MI}_0]}{[(1 + \text{MI}_1^\omega)^{(1 / \omega)} - \text{MI}_1]}$$ -->

<!--   where: -->

<!--   - $\text{vpd}_0$ and $\text{vpd}_1$ are the values of vapour pressure deficit (reconstructed and corrected, respectively) -->
<!--   - $\text{MI}_0$ amd $\text{MI}_1$ are the values of moisture index (reconstructed and corrected, respectively) -->
<!--   - $\omega$ is a constant equals to `3`. -->


```{r, echo = FALSE, eval = FALSE}
MI0 <- padul2$recon_mi
MI1 <- padul2$corrected_mi
vpd0 <- codos:::vpd_internal(padul2$past_temp, MI0)
vpd1 <- codos:::vpd_internal(padul2$present_t, MI1)
o <- 3
ep_ratio <- (vpd1 / vpd0) * ((1 + MI0 ^ o)^(1 / o) - MI0) / ((1 + MI1 ^ o)^(1 / o) - MI1)
mi_ratio <- MI1 / MI0
padul2$corrected_P_ann <- padul$P_ann * ep_ratio * mi_ratio
```

Approximated as the ratio

$$\text{MI}_\text{ratio}= \frac{\text{corrected}}{\text{reconstructed}}$$
multiplied by reconstructed `P_ann`.

```{r}
mi_ratio <- padul2$corrected_mi / padul2$recon_mi
padul2$corrected_P_ann <- padul$P_ann * mi_ratio
```

```{r, echo = TRUE}
padul2 %>% 
  write.csv(file = "padul-with-corrected-mi.csv",
            row.names = FALSE)

# Small subset
knitr::kable(head(padul2, 20)) %>%
  kableExtra::kable_styling()
```

Check out and download the entire dataset in [Appendix A5](#a5-padul-data).

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots

#### Reconstructed vs corrected `MI`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(padul2))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

- `age < 5k`


```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi),
               co2 = rep(padul2$past_co2 / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [Â°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [Â°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi),
               co2 = rep(padul2$past_co2 / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [Â°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [Â°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `P_ann`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann),
               var = rep(c("reconstructed", 
                           "corrected"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann),
               var = rep(c("reconstructed", 
                           "corrected"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ### Constrast between two approaches to find corrected `P_ann` -->
```{r, echo = FALSE, eval = FALSE}
padul2$corrected_P_ann_old <- padul$P_ann * mi_ratio
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann,
                     padul2$corrected_P_ann_old),
               var = rep(c("reconstructed", 
                           "corrected (Ep * MI)",
                           "corrected (MI)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```

<!-- - `age < 5k` -->

```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann,
                     padul2$corrected_P_ann_old),
               var = rep(c("reconstructed", 
                           "corrected (Ep * MI)",
                           "corrected (MI)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann,
                     padul2$corrected_P_ann),
               co2 = rep(padul2$past_co2, 2),
               past_temp = rep(padul2$past_temp * 100, 2),
               var = rep(c("P_ann: reconstructed",
                           "P_ann: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2" = "gold",
                                        "Temp" = "black",
                                        "P_ann: reconstructed" = "#66C2A5",
                                        "P_ann: corrected" = "#FC8D62")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~. / 100,
                                                           name = "Temp [Â°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [Â°C] (black line)",
  y = "Annual precipitation [mm/year] and CO2 [ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann,
                     padul2$corrected_P_ann),
               co2 = rep(padul2$past_co2, 2),
               past_temp = rep(padul2$past_temp * 100, 2),
               var = rep(c("P_ann: reconstructed",
                           "P_ann: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2" = "gold",
                                        "Temp" = "black",
                                        "P_ann: reconstructed" = "#66C2A5",
                                        "P_ann: corrected" = "#FC8D62")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~. / 100,
                                                           name = "Temp [Â°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [Â°C] (black line)",
  y = "Annual precipitation [mm/year] and CO2 [ppm]") +
  ggplot2::theme_bw()
```

# References

[1] Bereiter, B., Eggleston, S., Schmitt, J., NehrbassâAhles, C., Stocker, T. F.,
Fischer, H., Kipfstuhl, S., and Chappellaz, J. (2015), Revision of the EPICA
Dome C CO2 record from 800 to 600 kyr before present, Geophys. Res. Lett., 
42, 542â 549, <doi:10.1002/2014GL061957>.

# Appendix

## A1. Find reconstructed `MI` using `loess`

```{r}
past_co2_loess <- function(age_calBP, ref = codos::ice_core) {
  # Extract the reference age and co2
  ref_age <- purrr::pluck(ref, 1)
  ref_co2 <- purrr::pluck(ref, 2)
  if (age_calBP < min(ref_age))
    return(ref_co2[which.min(ref_age)])
  
  if (age_calBP > max(ref_age))
    return(ref_co2[which.max(ref_age)])
  loessMod10 <- loess(co2 ~ age_calBP,
                      tibble::tibble(age_calBP = ref_age,
                                     co2 = ref_co2), span = 0.1)
  return(predict(loessMod10, age_calBP))
}

padul2$past_co2_loess <- purrr::map_dbl(padul2$age_calBP, 
                                        past_co2_loess)
padul2$corrected_mi_loess <- codos::corrected_mi(padul2$present_t,
                                                 padul2$past_temp,
                                                 padul2$recon_mi,
                                                 padul2$modern_co2,
                                                 padul2$past_co2_loess)

head(padul2, 10) %>%
  dplyr::select(-c(past_co2, corrected_mi, corrected_P_ann)) %>%
  knitr::kable() %>%
  kableExtra::kable_styling()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A2. Plot reconstructed vs corrected `MI` both approaches

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi, 
                     padul2$corrected_mi_loess),
               var = rep(c("reconstructed", 
                           "corrected (mean)", 
                           "corrected (loess)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi, 
                     padul2$corrected_mi_loess),
               var = rep(c("reconstructed", 
                           "corrected (mean)", 
                           "corrected (loess)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A3. Reconstructed vs corrected `MI`: Past CO2 calculated using `loess`
#### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi_loess),
               co2 = rep(padul2$past_co2_loess / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [Â°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [Â°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi_loess),
               co2 = rep(padul2$past_co2_loess / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [Â°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [Â°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

## A4. Compare  `codos::ice_core` vs past CO2 calculate using `mean` and `loess`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$past_co2,
                     padul2$past_co2_loess),
               var = rep(c("Mean", 
                           "LOESS (span = 0.1)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= max(padul2$age_calBP), ],
                       ggplot2::aes(age_gas_calBP, 
                                    co2_ppm, 
                                    colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", 
                                 values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(10)) +
    ggplot2::labs(x = "Age [cal yr BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
                     y = c(padul2$past_co2,
                           padul2$past_co2_loess),
                     var = rep(c("Mean", 
                                 "LOESS (span = 0.1)"), 
                               each = nrow(padul2))) %>%
  
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 5000, ],
                       ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

- `age < 500`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
                     y = c(padul2$past_co2,
                           padul2$past_co2_loess),
                     var = rep(c("Mean", 
                                 "LOESS (span = 0.1)"), 
                               each = nrow(padul2))) %>%
  
  .[.$x < 500, ] %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 500, ],
                       ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A5. Padul Data
Download the CSV file: [padul-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/padul-with-corrected-mi.csv)

```{r, echo = FALSE}
padul2 %>%
  dplyr::select(-dplyr::ends_with(("loess"))) %>%
  knitr::kable(longtable = TRUE)
```
