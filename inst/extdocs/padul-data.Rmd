---
title: "Padul Data"
output: 
  pdf_document:
    extra_dependencies: ["float", "longtable"]
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/padul-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 'latex' else 'pandoc'
})

# Set path to working directory
path <- "~/Desktop/iCloud/UoR/Data/CRU/4.04/"

# Load padul data
padul <- readr::read_csv("~/Desktop/iCloud/UoR/Data/padul.csv")

`%>%` <- magrittr::`%>%`
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

## Calculate daily temperature (modern)

CRU TS 4.04 daily interpolations from monthly data:

```{r, eval = FALSE}
path <- "/path/to/CRU/4.04/"
tmin <- file.path(path, "cru_ts4.04.1901.2019.tmn.dat-clim-1961-1990-int.nc")
tmax <- file.path(path, "cru_ts4.04.1901.2019.tmx.dat-clim-1961-1990-int.nc")
output_filename <- file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp.nc")
codos::daily_temp(tmin = list(filename = tmin, id = "tmn"),
                  tmax = list(filename = tmax, id = "tmx"),
                  output_filename = output_filename)
```

##### Output file
```
"cru_ts4.04-clim-1961-1990-daily.tmp.nc"
```

## Calculate mean growing season for daily temperature (`tmp`)
```{r, eval = FALSE}
codos::nc_gs("cru_ts4.04-clim-1961-1990-daily.tmp.nc", "tmp", thr = 0, cpus = 10)
```

##### Output file
```
"cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"
```

Padul location: 37.0108, -3.6039

```{r}
Tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "tmp")
lat <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "lat")
lon <- codos:::nc_var_get(file.path(path, "cru_ts4.04-clim-1961-1990-daily.tmp-gs.nc"),
                          "lon")
idx_y <- which.min(abs(lat$data - 37.0108))
idx_x <- which.min(abs(lon$data + 3.6039))

aux <- Tmp$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(aux) <- lat$data[c(idx_y, idx_y - 1)]
colnames(aux) <- lon$data[c(idx_x, idx_x + 1)]
aux
(modern_tmp <- mean(aux))
```

## Reconstruct past temperature from `T_djf` and `T_jja`:
```{r, eval = FALSE}
padul <- readr::read_csv("/path/to/padul.csv")
```

#### Calculate daily mean temperature
```{r}
padul_tmp <- rowMeans(padul[, c("T_djf", "T_jja")])
```

## Obtain past CO2 from (Bereiter et al. 2015)

```{r}
past_co2 <- purrr::map_dbl(padul$`Age (cal yr BP)`, codos::past_co2)
```

## Obtain modern CO2 from (Bereiter et al. 2015)

```{r}
modern_co2 <- tibble::tibble(age = 1950 - c(1961:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %>%
  .$co2 %>%
  mean()
```

## Assemble the Padul data
```{r}
padul2 <- tibble::tibble(age_calBP = padul$`Age (cal yr BP)`,
                         past_temp = padul_tmp,
                         past_co2 = past_co2,
                         modern_co2 = modern_co2, # 340,
                         present_t = padul_tmp, # modern_tmp, 
                         recon_mi = padul$MI)

```

## Find the corrected `MI`
```{r}
padul2$corrected_mi <- codos::corrected_mi(padul2$present_t,
                                           padul2$past_temp,
                                           padul2$recon_mi,
                                           padul2$modern_co2,
                                           padul2$past_co2)
# Small subset
knitr::kable(head(padul2, 7))
```

Check out and download the entire dataset in [Appendix A5](#a5-padul-data).

## Find the corrected Annual Precipitation, `P_ann`

<!-- Approximated as the ratios of potential evapotranspiration (`Ep`) and moisture index (`MI`), multiplied by the reconstructed annual precipitation, $\text{P}_\text{ann, 0}$: -->

<!-- $$\text{P}_\text{ann, 1} = \frac{\text{MI}_1}{\text{MI}_0} \times \frac{\text{Ep}_1}{\text{Ep}_0} \times \text{P}_\text{ann, 0}$$ -->
<!-- The ratio of evapotranspiration (`Ep`) is given by -->
<!-- $$\frac{\text{Ep}_1}{\text{Ep}_0} = \left(\frac{\text{vpd}_1}{\text{vpd}_0}\right) \times \frac{[(1 + \text{MI}_0^\omega)^{(1 / \omega)} - \text{MI}_0]}{[(1 + \text{MI}_1^\omega)^{(1 / \omega)} - \text{MI}_1]}$$ -->

<!--   where: -->

<!--   - $\text{vpd}_0$ and $\text{vpd}_1$ are the values of vapour pressure deficit (reconstructed and corrected, respectively) -->
<!--   - $\text{MI}_0$ amd $\text{MI}_1$ are the values of moisture index (reconstructed and corrected, respectively) -->
<!--   - $\omega$ is a constant equals to `3`. -->


```{r, echo = FALSE, eval = FALSE}
MI0 <- padul2$recon_mi
MI1 <- padul2$corrected_mi
vpd0 <- codos:::vpd_internal(padul2$past_temp, MI0)
vpd1 <- codos:::vpd_internal(padul2$present_t, MI1)
o <- 3
ep_ratio <- (vpd1 / vpd0) * ((1 + MI0 ^ o)^(1 / o) - MI0) / ((1 + MI1 ^ o)^(1 / o) - MI1)
mi_ratio <- MI1 / MI0
padul2$corrected_P_ann <- padul$P_ann * ep_ratio * mi_ratio
```

Approximated as the ratio

$$\text{MI}_\text{ratio}= \frac{\text{corrected}}{\text{reconstructed}}$$
multiplied by reconstructed `P_ann`.

```{r}
mi_ratio <- padul2$corrected_mi / padul2$recon_mi
padul2$corrected_P_ann <- padul$P_ann * mi_ratio
```

```{r, echo = TRUE}
padul2 %>% 
  write.csv(file = "padul-with-corrected-mi.csv",
            row.names = FALSE)

# Small subset
knitr::kable(head(padul2, 20)) %>%
  kableExtra::kable_styling()
```

Check out and download the entire dataset in [Appendix A5](#a5-padul-data).

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots

#### Reconstructed vs corrected `MI`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(padul2))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

- `age < 5k`


```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi),
               co2 = rep(padul2$past_co2 / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi),
               co2 = rep(padul2$past_co2 / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `P_ann`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann),
               var = rep(c("reconstructed", 
                           "corrected"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann),
               var = rep(c("reconstructed", 
                           "corrected"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ### Constrast between two approaches to find corrected `P_ann` -->
```{r, echo = FALSE, eval = FALSE}
padul2$corrected_P_ann_old <- padul$P_ann * mi_ratio
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann,
                     padul2$corrected_P_ann_old),
               var = rep(c("reconstructed", 
                           "corrected (Ep * MI)",
                           "corrected (MI)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```

<!-- - `age < 5k` -->

```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul$P_ann, 
                     padul2$corrected_P_ann,
                     padul2$corrected_P_ann_old),
               var = rep(c("reconstructed", 
                           "corrected (Ep * MI)",
                           "corrected (MI)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Set2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", 
                  y = "Annual precipitation [mm/year]") +
    ggplot2::theme_bw()
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann,
                     padul2$corrected_P_ann),
               co2 = rep(padul2$past_co2, 2),
               past_temp = rep(padul2$past_temp * 100, 2),
               var = rep(c("P_ann: reconstructed",
                           "P_ann: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2" = "gold",
                                        "Temp" = "black",
                                        "P_ann: reconstructed" = "#66C2A5",
                                        "P_ann: corrected" = "#FC8D62")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~. / 100,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "Annual precipitation [mm/year] and CO2 [ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul$P_ann,
                     padul2$corrected_P_ann),
               co2 = rep(padul2$past_co2, 2),
               past_temp = rep(padul2$past_temp * 100, 2),
               var = rep(c("P_ann: reconstructed",
                           "P_ann: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2" = "gold",
                                        "Temp" = "black",
                                        "P_ann: reconstructed" = "#66C2A5",
                                        "P_ann: corrected" = "#FC8D62")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~. / 100,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "Annual precipitation [mm/year] and CO2 [ppm]") +
  ggplot2::theme_bw()
```

# References

[1] Bereiter, B., Eggleston, S., Schmitt, J., Nehrbass‐Ahles, C., Stocker, T. F.,
Fischer, H., Kipfstuhl, S., and Chappellaz, J. (2015), Revision of the EPICA
Dome C CO2 record from 800 to 600 kyr before present, Geophys. Res. Lett., 
42, 542– 549, <doi:10.1002/2014GL061957>.

# Appendix

## A1. Find reconstructed `MI` using `loess`

```{r}
past_co2_loess <- function(age_calBP, ref = codos::ice_core) {
  # Extract the reference age and co2
  ref_age <- purrr::pluck(ref, 1)
  ref_co2 <- purrr::pluck(ref, 2)
  if (age_calBP < min(ref_age))
    return(ref_co2[which.min(ref_age)])
  
  if (age_calBP > max(ref_age))
    return(ref_co2[which.max(ref_age)])
  loessMod10 <- loess(co2 ~ age_calBP,
                      tibble::tibble(age_calBP = ref_age,
                                     co2 = ref_co2), span = 0.1)
  return(predict(loessMod10, age_calBP))
}

padul2$past_co2_loess <- purrr::map_dbl(padul2$age_calBP, 
                                        past_co2_loess)
padul2$corrected_mi_loess <- codos::corrected_mi(padul2$present_t,
                                                 padul2$past_temp,
                                                 padul2$recon_mi,
                                                 padul2$modern_co2,
                                                 padul2$past_co2_loess)

head(padul2, 10) %>%
  dplyr::select(-c(past_co2, corrected_mi, corrected_P_ann)) %>%
  knitr::kable() %>%
  kableExtra::kable_styling()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A2. Plot reconstructed vs corrected `MI` both approaches

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi, 
                     padul2$corrected_mi_loess),
               var = rep(c("reconstructed", 
                           "corrected (mean)", 
                           "corrected (loess)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 3),
               y = c(padul2$recon_mi, 
                     padul2$corrected_mi, 
                     padul2$corrected_mi_loess),
               var = rep(c("reconstructed", 
                           "corrected (mean)", 
                           "corrected (loess)"), 
                         each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A3. Reconstructed vs corrected `MI`: Past CO2 calculated using `loess`
#### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi_loess),
               co2 = rep(padul2$past_co2_loess / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corrected_mi_loess),
               co2 = rep(padul2$past_co2_loess / 100, 2),
               past_temp = rep(padul2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

## A4. Compare  `codos::ice_core` vs past CO2 calculate using `mean` and `loess`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$past_co2,
                     padul2$past_co2_loess),
               var = rep(c("Mean", 
                           "LOESS (span = 0.1)"), 
                         each = nrow(padul2))) %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= max(padul2$age_calBP), ],
                       ggplot2::aes(age_gas_calBP, 
                                    co2_ppm, 
                                    colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", 
                                 values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(10)) +
    ggplot2::labs(x = "Age [cal yr BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

- `age < 5k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
                     y = c(padul2$past_co2,
                           padul2$past_co2_loess),
                     var = rep(c("Mean", 
                                 "LOESS (span = 0.1)"), 
                               each = nrow(padul2))) %>%
  
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 5000, ],
                       ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

- `age < 500`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
                     y = c(padul2$past_co2,
                           padul2$past_co2_loess),
                     var = rep(c("Mean", 
                                 "LOESS (span = 0.1)"), 
                               each = nrow(padul2))) %>%
  
  .[.$x < 500, ] %>%
  ggplot2::ggplot() +
    ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 500, ],
                       ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
    ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
    # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
    ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]",
                  y = "CO2 [ppm]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## A5. Padul Data
Download the CSV file: [padul-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/padul-with-corrected-mi.csv)

```{r, echo = FALSE}
padul2 %>%
  dplyr::select(-dplyr::ends_with(("loess"))) %>%
  knitr::kable(longtable = TRUE)
```
