---
title: "El Cañizar de Villarquemado"
subtitle: "(40.514492, -1.288021)"
output: 
  pdf_document:
    extra_dependencies: ["float", "longtable"]
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
bibliography: ../../inst/references/references.bib
cls: ../../inst/references/proceedings-of-the-royal-society-a.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/el-canizar-de-villarquemado-co2-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

# options(knitr.table.format = function() {
#   if (knitr::is_latex_output()) 'latex' else 'pandoc'
# })

# Set path to working directory
path <- "~/Desktop/iCloud/UoR/Data/CRU/4.04/"

`%>%` <- magrittr::`%>%`
`%$%` <- magrittr::`%$%`

ZOOM <- 10e3

theme_bottom_legend <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey20"),
                 panel.grid = ggplot2::element_line(colour = "grey92"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey85",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "white", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

```{r, eval = TRUE, echo = FALSE}
# Execute the commands
suppressWarnings({
  suppressMessages({
    gdd0 <- readr::read_csv(here::here("inst/extdata/gdd0.csv"))
    mtco <- readr::read_csv(here::here("inst/extdata/mtco.csv"))
    recon_mi <- readr::read_csv(here::here("inst/extdata/recon_mi.csv"))
    mi_input <- readr::read_csv(here::here("inst/extdata/mi_input.csv"))
    mi_output <- readr::read_csv(here::here("inst/extdata/mi_output.csv"))
    
    # Drop rows missing from gdd0, mtc0, and recon_mi
    idx <- c(20:22, 46, 76, 82, 84, 87, 88, 95, 113, 123, 129, 135, 142, 146, 
             164:166, 174, 175, 189:191, 193:195, 260, 341)
    mi_input <- mi_input[-idx, ]
    mi_output <- mi_output[-idx, ]
  })
})
```

## Obtain modern CO2 from (Bereiter et al. 2015)
```{r}
modern_co2 <- tibble::tibble(age = 1950 - c(1961:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %$%
  median(co2)
```

## Obtain past CO2 from (Bereiter et al. 2015)

```{r}
palaeo_co2 <- purrr::map_dbl(mi_input$age, codos::past_co2)
```

## Assemble the input data
```{r}
villarquemado <- tibble::tibble(age_calBP = mi_input$age,
                                palaeo_co2 = palaeo_co2,
                                palaeo_MGS_temp = mi_input$past_temp,
                                modern_co2 = modern_co2,
                                modern_MGS_temp = mi_input$present_t,
                                recon_mi = mi_input$recon_mi)
```

## Find the corrected `MI`
```{r}
villarquemado$corrected_mi <- codos::corrected_mi(villarquemado$modern_MGS_temp,
                                                  villarquemado$palaeo_MGS_temp,
                                                  villarquemado$recon_mi,
                                                  villarquemado$modern_co2,
                                                  villarquemado$palaeo_co2)
```

```{r, echo = FALSE}
# Small subset
villarquemado %>%
  dplyr::slice(1:8) %>%
  knitr::kable(col.names = c("age [cal yrs BP]",
                             "palaeo CO2",
                             "palaeo MGS temperature",
                             "modern CO2",
                             "modern MGS temperature",
                             "recon. MI",
                             "corr. MI"))
# knitr::kable(head(villarquemado, 6)) %>%
#   kableExtra::kable_styling()
```

<!-- Check out and download the entire dataset in [Appendix A1](#a1-el-canizar-de-villarquemado-data). -->

```{r, echo = FALSE}
# villarquemado %>% 
#   write.csv(file = "villarquemado-corrected-mi.csv",
#             row.names = FALSE)
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Records for which the corrected MI is lower than the reconstructed MI, sorted from smallest to largest:
```{r, echo = FALSE}
villarquemado %>%
  dplyr::filter(corrected_mi < recon_mi) %>%
  dplyr::mutate(diff = abs(corrected_mi - recon_mi)) %>%
  dplyr::arrange(diff) %>%
  knitr::kable(col.names = c("age [cal yrs BP]",
                             "palaeo CO2",
                             "palaeo MGS temperature",
                             "modern CO2",
                             "modern MGS temperature",
                             "reconstructed MI",
                             "corrected MI",
                             "|$\\Delta$MI|"), escape = TRUE)
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

# Anomalous records
```{r, echo = FALSE}
idx <- which(villarquemado$corrected_mi - villarquemado$recon_mi < 0)
deltaT <- 2
aux <- villarquemado[idx, ] %>%
  dplyr::mutate(palaeo_MGS_temp2 = palaeo_MGS_temp + deltaT,
                palaeo_MGS_temp3 = palaeo_MGS_temp - deltaT)

corr_mi2 <- aux %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp2,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)
corr_mi3 <- aux %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp3,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)

aux_long <- aux %>%
  dplyr::select(-palaeo_MGS_temp2,
                -palaeo_MGS_temp3) %>%
  dplyr::mutate(corr_mi_Tmp_plus_1 = corr_mi2,
                corr_mi_Tmp_minus_1 = corr_mi3) %$% 
  tibble::tibble(age_calBP = rep(age_calBP, 3),
                 palaeo_co2 = rep(palaeo_co2, 3),
                 palaeo_MGS_temp = c(palaeo_MGS_temp,
                                     palaeo_MGS_temp,
                                     palaeo_MGS_temp),
                 modern_co2 = rep(modern_co2, 3),
                 modern_MGS_temp = rep(modern_MGS_temp, 3),
                 recon_mi = rep(recon_mi, 3),
                 corr_mi = c(corrected_mi,
                             corr_mi_Tmp_plus_1,
                             corr_mi_Tmp_minus_1),
                 cat = rep(c("Original", 
                             paste0("+", deltaT," °C"), 
                             paste0("-", deltaT," °C")), each = length(idx)))
```


These plots show the effect of increasing and decreasing the temperature by `r deltaT`°C on the corrections of MI:

## `age < 15k`
<!-- ## `age < 20` -->

```{r anomalous-records-15k-zoom_fig, echo = FALSE}
aux_long %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi,
                       corr_mi),
                 co2 = rep(palaeo_co2 / 100, 2),
                 palaeo_MGS_temp = rep(palaeo_MGS_temp / 5, 2),
                 Temperature = rep(cat, 2),
                 var = rep(c("MI: reconstructed",
                             "MI: corrected"),
                           each = length(corr_mi))) %>%
  dplyr::filter(x < 15e3) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var, linetype = Temperature)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(3e3, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_ribbon(ggplot2::aes(x, ymin = palaeo_MGS_temp - deltaT / 5, ymax = palaeo_MGS_temp + deltaT / 5), alpha = 0.5) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

## `age > 95k`
<!-- ## `age < 20` -->

```{r anomalous-records-95k-zoom_fig, echo = FALSE}
aux_long %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi,
                       corr_mi),
                 co2 = rep(palaeo_co2 / 100, 2),
                 palaeo_MGS_temp = rep(palaeo_MGS_temp / 5, 2),
                 Temperature = rep(cat, 2),
                 var = rep(c("MI: reconstructed",
                             "MI: corrected"),
                           each = length(corr_mi))) %>%
  dplyr::filter(x > 95e3) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var, linetype = Temperature)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(95e3, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_ribbon(ggplot2::aes(x, ymin = palaeo_MGS_temp - deltaT / 5, ymax = palaeo_MGS_temp + deltaT / 5), alpha = 0.5) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots

#### Reconstructed vs corrected `MI`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

Records with **smaller** reconstructed MI **only**.

- `age_calBP < 15k`

```{r corr-vs-recon-mi-diff-15k-zoom_fig, echo = FALSE}
villarquemado %>%
  dplyr::filter(corrected_mi < recon_mi) %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi, 
                       corrected_mi),
                 var = rep(c("Reconstructed", 
                             "Corrected"), 
                           each = length(age_calBP))) %>%
  dplyr::filter(x < 15000) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  theme_bottom_legend
```


- `age_calBP > 95k`

```{r corr-vs-recon-mi-diff-95k-zoom_fig, echo = FALSE}
villarquemado %>%
  dplyr::filter(corrected_mi < recon_mi) %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi, 
                       corrected_mi),
                 var = rep(c("Reconstructed", 
                             "Corrected"), 
                           each = length(age_calBP))) %>%
  dplyr::filter(x > 95000) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `MI`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r corr-vs-recon-mi_fig, echo = FALSE}
tibble::tibble(x = rep(villarquemado$age_calBP, 2),
               y = c(villarquemado$recon_mi, 
                     villarquemado$corrected_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(villarquemado))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  theme_bottom_legend
```

- `age_calBP <` `r ZOOM / 1e3``k`

```{r corr-vs-recon-mi-10k-zoom_fig, echo = FALSE}
tibble::tibble(x = rep(villarquemado$age_calBP, 2),
               y = c(villarquemado$recon_mi, 
                     villarquemado$corrected_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(villarquemado))) %>%
  .[.$x < ZOOM, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
    theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r corr-vs-recon-mi-with-co2-tmp_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(villarquemado$age_calBP, 2),
               y = c(villarquemado$recon_mi,
                     villarquemado$corrected_mi),
               co2 = rep(villarquemado$palaeo_co2 / 100, 2),
               palaeo_MGS_temp = rep(villarquemado$palaeo_MGS_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(villarquemado))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  theme_bottom_legend
```

- `age_calBP <` `r ZOOM / 1e3``k`

```{r corr-vs-recon-mi-with-co2-tmp-10k-zoom_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(villarquemado$age_calBP, 2),
               y = c(villarquemado$recon_mi,
                     villarquemado$corrected_mi),
               co2 = rep(villarquemado$palaeo_co2 / 100, 2),
               palaeo_MGS_temp = rep(villarquemado$palaeo_MGS_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(villarquemado))) %>%
  .[.$x < ZOOM, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yr BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Comparison of corrections for `MI`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r corr-mi-comparison_fig, echo = FALSE}
tibble::tibble(x = rep(villarquemado$age_calBP, 2),
               y = c(mi_output$result, 
                     villarquemado$corrected_mi),
               var = rep(c("Dongyang et al.", 
                           "New approach"), 
                         each = nrow(villarquemado))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Corrected MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  theme_bottom_legend
```

- `age_calBP <` `r ZOOM / 1e3``k`

```{r corr-mi-comparison-10k-zoom_fig, echo = FALSE}
tibble::tibble(x = rep(villarquemado$age_calBP, 2),
               y = c(mi_output$result, 
                     villarquemado$corrected_mi),
               var = rep(c("Dongyang et al.", 
                           "New approach"), 
                         each = nrow(villarquemado))) %>%
  .[.$x < ZOOM, ] %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Corrected MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yr BP]", y = "MI [-]") +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

# References

[1] Bereiter, B., Eggleston, S., Schmitt, J., Nehrbass‐Ahles, C., Stocker, T. F.,
Fischer, H., Kipfstuhl, S., and Chappellaz, J. (2015), Revision of the EPICA
Dome C CO2 record from 800 to 600 kyr before present, Geophys. Res. Lett., 
42, 542– 549, <doi:10.1002/2014GL061957>.

# Appendix

## A1. El Cañizar de Villarquemado Data
<!-- Download the CSV file: [padul-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/padul-with-corrected-mi.csv) -->

```{r, echo = FALSE}
villarquemado %>% 
  readr::write_excel_csv(file = "el-canizar-de-villarquemado-with-corr-mi.csv", 
                         na = "")

villarquemado %>%
  dplyr::mutate(corrected_mi_dongyang = mi_output$result, 
                .before = corrected_mi) %>%
  knitr::kable(longtable = TRUE,
               col.names = c("age [cal yr BP]",
                             "palaeo CO2 [umol/mol]",
                             "palaeo MGS temp [°C]",
                             "modern CO2 [umol/mol]",
                             "modern MGS temp [°C]",
                             "recon. MI [-]",
                             "corr. MI (Dongyang et al.) [-]",
                             "corr. MI (New approach) [-]"))
```
