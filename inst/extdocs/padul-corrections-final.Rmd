---
title: "Laguna de Padul Data: MI and P_ann corrections"
subtitle: "(37.0108, -3.6039)"
output: 
  pdf_document:
    extra_dependencies: ["float", "longtable"]
    latex_engine: xelatex
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 600, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/padul-corrections-final-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

options(knitr.kable.NA = '',
        knitr.kable.format = "pandoc")

# Set path to working directory
path <- "~/OneDrive - University of Reading/UoR/Data/CRU/4.04/"
`%>%` <- magrittr::`%>%`
`%$%` <- magrittr::`%$%`
options(warn = 1) 
# Load padul data
# padul <- readr::read_csv("~/Desktop/iCloud/UoR/Data/padul.csv")
padul <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/padul.csv") %>%
  magrittr::set_colnames(c("age_cal_yr_BP", colnames(.)[-1])) %>%
  dplyr::mutate(Tmean = (T_jja + T_djf) / 2,
                Tmax = Tmean + (T_jja - Tmean) / 0.9,
                Tmin = Tmean + (T_djf - Tmean) / 0.9,
                Tgs = list(Tmin, Tmax) %>%
                  purrr::pmap_dbl(function(Tmin, Tmax) {
                    aux <- codos::int_sin(Tmin, Tmax)
                    mean(aux[aux > 0])
                  }))

ref_idx <- 5:9 # -40 < age < -10
LAT <- 37.0108
LON <- -3.6039

theme_bottom_legend <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey20"),
                 panel.grid = ggplot2::element_line(colour = "grey92"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey85",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "white", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")

theme_bottom_legend_black <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey2"),
                 panel.grid = ggplot2::element_line(colour = "grey20"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "grey2", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

## Reconstruct past temperature from `T_djf` and `T_jja`:
```{r, eval = FALSE}
padul <- readr::read_csv("/path/to/padul.csv")
```

#### Calculate daily mean temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r}
padul_tmp <- rowMeans(padul[, c("T_djf", "T_jja")])
palaeo_MGS_temp <- padul$Tgs
```

```{r, echo = FALSE}
padul_modern_tmp <- padul$P_ann[ref_idx]
```

## Obtain past CO2 from (Bereiter et al. 2015)

```{r}
palaeo_co2 <- purrr::map_dbl(padul$age_cal_yr_BP, codos::past_co2)
```

## Obtain modern CO2 from (Bereiter et al. 2015)

```{r}
modern_co2 <- tibble::tibble(age = 1950 - c(1901:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %$%
  median(co2)
```

```{r temp-comparison_fig, echo = FALSE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 3),
               y = c(padul$T_djf,
                     padul$T_jja,
                     padul$Tgs),
               var = rep(c("T_djf", 
                           "T_jja", 
                           "Palaeo Mean Growing Season"), 
                         each = nrow(padul))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::geom_point(ggplot2::aes(0, 
                                   mean(palaeo_MGS_temp[ref_idx]), 
                                   colour = "Modern Mean Growing Season"),
                      size = 3) +
  ggsci::scale_color_jco(name = "") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", 
                y = "Temperature [°C]",
                title = "Temperatures comparison") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1),
                                                                    shape = c(19, NA, NA, NA)))) +
  theme_bottom_legend
```

## Assemble the _Laguna de Padul_ dataset
```{r}
padul2 <- tibble::tibble(age_calBP = padul$age_cal_yr_BP,
                         palaeo_co2 = palaeo_co2,
                         palaeo_MGS_temp = palaeo_MGS_temp,
                         modern_co2 = modern_co2,
                         modern_MGS_temp = mean(palaeo_MGS_temp[ref_idx]),
                         recon_mi = padul$MI,
                         recon_Pann = padul$P_ann)
```


```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Find the corrected `MI`
```{r, echo = FALSE}
# padul2$corr_mi <- codos::corrected_mi(padul2$modern_MGS_temp,
#                                       padul2$palaeo_MGS_temp,
#                                       padul2$recon_mi,
#                                       padul2$modern_co2,
#                                       padul2$palaeo_co2)
```

```{r find-corrected-mi}
corr_mi <- padul2 %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)
padul2 <- padul2 %>%
  dplyr::mutate(corr_mi = corr_mi)
```

Records for which the corrected MI is smaller than reconstructed MI
```{r, echo = FALSE}
# Find years for which the corrected MI is smaller than reconstructed
idx <- which(corr_mi - padul$MI < 0)

padul2 %>%
  dplyr::slice(c(idx)) %>%
  knitr::kable(col.names = c("age cal yr BP",
                             "palaeo co2",
                             "palaeo MGS temp",
                             "modern co2",
                             "modern MGS temp",
                             "recon. MI",
                             "recon. Pann",
                             "corr. MI"))
```


```{r, eval = FALSE, echo = FALSE}
padul3 <- tibble::tibble(age_calBP = padul$age_cal_yr_BP,
                         palaeo_co2 = palaeo_co2,
                         palaeo_MGS_temp = padul$Tgs,
                         modern_co2 = modern_co2,
                         modern_MGS_temp = mean(padul$Tgs[ref_idx]),
                         recon_mi = padul$MI)
padul3$corr_mi <- codos::corrected_mi(padul3$modern_MGS_temp,
                                      padul3$palaeo_MGS_temp,
                                      padul3$recon_mi,
                                      padul3$modern_co2,
                                      padul3$palaeo_co2)
plot(padul3$corr_mi, type = "l")
lines(padul2$corr_mi, col = "red")
lines(padul2$recon_mi, col = "blue")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

# Anomalous records
```{r, echo = FALSE}
idx <- which(corr_mi - padul$MI < 0)
deltaT <- 2
aux <- padul2[idx, ] %>%
  dplyr::mutate(palaeo_MGS_temp2 = palaeo_MGS_temp + deltaT,
                palaeo_MGS_temp3 = palaeo_MGS_temp - deltaT)

corr_mi2 <- aux %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp2,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)
corr_mi3 <- aux %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp3,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)

aux_long <- aux %>%
  dplyr::select(-palaeo_MGS_temp2,
                -palaeo_MGS_temp3) %>%
  dplyr::mutate(corr_mi_Tmp_plus_1 = corr_mi2,
                corr_mi_Tmp_minus_1 = corr_mi3) %$% 
  tibble::tibble(age_calBP = rep(age_calBP, 3),
                 palaeo_co2 = rep(palaeo_co2, 3),
                 palaeo_MGS_temp = c(palaeo_MGS_temp,
                                     palaeo_MGS_temp,
                                     palaeo_MGS_temp),
                 modern_co2 = rep(modern_co2, 3),
                 modern_MGS_temp = rep(modern_MGS_temp, 3),
                 recon_mi = rep(recon_mi, 3),
                 corr_mi = c(corr_mi,
                               corr_mi_Tmp_plus_1,
                               corr_mi_Tmp_minus_1),
                 cat = rep(c("Original", 
                             paste0("+", deltaT," °C"), 
                             paste0("-", deltaT," °C")), each = length(idx)))
```

<!-- ## `age < 10k` -->
<!-- ## `age < 20` -->

This plot shows the effect of increasing and decreasing the temperature by `r deltaT`°C on the corrections of MI:
```{r anomalous-records-10k-zoom_fig, echo = FALSE}
aux_long %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi,
                       corr_mi),
                 co2 = rep(palaeo_co2 / 100, 2),
                 palaeo_MGS_temp = rep(palaeo_MGS_temp / 5, 2),
                 Temperature = rep(cat, 2),
                 var = rep(c("MI: reconstructed",
                             "MI: corrected"),
                           each = length(corr_mi))) %>%
  dplyr::filter(x < 20) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var, linetype = Temperature)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(0, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_ribbon(ggplot2::aes(x, ymin = palaeo_MGS_temp - deltaT / 5, ymax = palaeo_MGS_temp + deltaT / 5), alpha = 0.5) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

<!-- ## `age > 80k` -->
```{r anomalous-records-80k-zoom_fig, echo = FALSE, eval = FALSE}
aux_long %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi,
                       corr_mi),
                 co2 = rep(palaeo_co2 / 100, 2),
                 palaeo_MGS_temp = rep(palaeo_MGS_temp / 5, 2),
                 Temperature = rep(cat, 2),
                 var = rep(c("MI: reconstructed",
                             "MI: corrected"),
                           each = length(corr_mi))) %>%
  dplyr::filter(x > 80000) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var, linetype = Temperature)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(80000, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ## Find the estimated Annual Precipitation, `P_ann` -->

<!-- Approximated as the ratio -->

<!-- $$\text{MI}_\text{ratio}= \frac{\text{corrected}}{\text{reconstructed}}$$ -->
<!-- multiplied by reconstructed `P_ann`. -->

```{r, echo = FALSE}
# mi_ratio <- padul2$corr_mi / padul2$recon_mi
# padul2$est_Pann <- padul$P_ann * mi_ratio
```

```{r, echo = FALSE}
# padul2 %>% 
#   write.csv(file = "padul-with-corrected-mi.csv",
#             row.names = FALSE)
```

```{r, echo = FALSE, eval = FALSE}
# Small subset
knitr::kable(head(padul2, 13),
             col.names = c("age [cal yr BP]",
                           "palaeo CO2 [umol/mol]",
                           "palaeo MGS temp [°C]",
                           "modern CO2 [umol/mol]",
                           "modern MGS temp [°C]",
                           "recon. MI [-]",
                           "recon. Pann [mm/day]",
                           "corr. MI [-]",
                           "est. Pann [mm/day]"))
```

<!-- Check out and download the entire dataset in [Appendix A1](#a1-laguna-de-padul-data). -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r, echo = FALSE}
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), 
                          "elv")
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), 
                          "cld")$data
tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.daily.tmp.nc"), 
                          "tmp")$data
pre <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.pre.dat-new-clim-1961-1990-int.nc"),
                          "pre")$data
sf <- 1 - cld / 100

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - LAT))
idx_x <- which.min(abs(codos::lon$data - LON))

# Extract elevation subset
padul_elv <- elv$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(padul_elv) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_elv) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_elv <- mean(padul_elv)

# Extract sunshine fraction subset
padul_sf <- sf[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_sf) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_sf) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_sf <- colMeans(padul_sf, dims = 2)

# Extract cloud coverage subset
padul_cld <- cld[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_cld) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_cld) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_cld <- colMeans(padul_cld, dims = 2)

# Extract temperature subset
padul_tmp <- tmp[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_tmp) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_tmp) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_tmp <- colMeans(padul_tmp, dims = 2)

# Extract precipitation subset
padul_pre <- pre[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_pre) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_pre) <- codos::lon$data[c(idx_x, idx_x + 1)]
# padul_pre <- colMeans(padul_pre, dims = 2)
padul_pre <- colSums(padul_pre, dims = 2)
```

```{r, echo = FALSE}
# Delete large objects from the environment
rm(elv, cld, pre, sf, tmp)
```

```{r, echo = FALSE}
year <- 1961
padul_pet_modern <- seq_len(365) %>%
  purrr::map_dbl(function(i) {
    splash::calc_daily_evap(lat = LAT,
                            n = i,
                            elv = padul_elv,
                            y = year,
                            sf = padul_sf[i],
                            tc = padul_tmp[i])$pet_mm
 })
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = TRUE}
knitr::asis_output('\n\n\\newpage')
```

```{r, out.width="1\\linewidth", include=TRUE, fig.align="center", echo=FALSE, eval = FALSE}
knitr::include_graphics("padul-corrections-step-by-step.pdf")
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

# New corrections

## Calculate temperature anomalies

Using both $T_\text{djf}$ and $T_\text{jja}$ for each record, a sinusoidal curve
was fitted using the `int_sin` function.

```{r, echo = TRUE}
padul <- padul %>%
  dplyr::mutate(Tmean = (T_jja + T_djf) / 2) %>%
  dplyr::mutate(Tmax = Tmean + (T_jja - Tmean) / 0.9) %>%
  dplyr::mutate(Tmin = Tmean + (T_djf - Tmean) / 0.9)
```

```{r, echo = FALSE}
padul_modern <- padul %>%
  dplyr::slice(ref_idx) %>%
  dplyr::select(-1) %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean))
```

```{r modern-temperature_fig, echo = FALSE, fig.height = 5}
codos::int_sin(padul_modern$Tmin, padul_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul_modern$T_djf),
                          ggplot2::aes(x, y, colour = "T_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul_modern$T_jja),
                          ggplot2::aes(x, y, colour = "T_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = "'Modern' padul (avg. for -10 < age < -40") +
      theme_bottom_legend
```

Rows `r min(ref_idx)`:`r max(ref_idx)` were used as the baseline to calculate the temperature anomalies.

```{r, echo = FALSE}
padul %>%
  dplyr::slice(ref_idx) %>%
  rbind(c(NA, mean(.$MI), mean(.$P_ann), mean(.$T_djf), mean(.$T_jja), mean(.$Tmean), mean(.$Tmax), mean(.$Tmin), mean(.$Tgs))) %>%
  knitr::kable()
```

where
$$T_\text{mean} = (T_\text{jja} + T_\text{djf}) / 2$$
$$T_\text{max} = T_\text{mean} + (T_\text{jja} - T_\text{mean}) / 0.9$$
$$T_\text{min} = T_\text{mean} + (T_\text{djf} - T_\text{mean}) / 0.9$$

```{r, echo = TRUE}
padul_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map(~codos::int_sin(padul$Tmin[.x] - padul_modern$Tmin,
                             padul$Tmax[.x] - padul_modern$Tmax))
```                         

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: Anomaly for age = `r padul[169, 1]` cal yr BP
```{r temperature-anomalies-ex1_fig, fig.height = 5, echo = FALSE}
codos::int_sin(padul$Tmin[169] - padul_modern$Tmin, 
               padul$Tmax[169] - padul_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[169] - padul_modern$T_djf),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[169] - padul_modern$T_jja),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      theme_bottom_legend
```

Padul: Anomaly for age = `r padul[272, 1]` cal yr BP
```{r temperature-anomalies-ex2_fig, fig.height = 5, echo = FALSE}
codos::int_sin(padul$Tmin[272] - padul_modern$Tmin, 
               padul$Tmax[272] - padul_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[272] - padul_modern$T_djf),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[272] - padul_modern$T_jja),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate potential evapotranspiration (PET)

```{r pet-w-tmp-anomalies, cache = FALSE, echo = FALSE, eval = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet_tmp <- seq_along(padul_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf[i],
                                             tc = padul_tmp[i] + padul_anomalies[[k]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

##### Params (`splash::calc_daily_evap`)

- Latitude: `r LAT`
- Elevation: `r padul_elv`
- Year: `1961`
- Sunshine fraction: [`CRU TS 4.04`]
- Temperature:  [`CRU TS 4.04`] $+ T_\text{anomalies}$

```{r pet-comparison_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_tmp[169][[1]],
                     padul_pet_tmp[272][[1]],
                     padul_pet_modern),
               age = rep(c(padul$age_cal_yr_BP[169], 
                           padul$age_cal_yr_BP[272],
                           "[CRU TS 4.04]"),
                         each = 365) %>%
                 as.factor()) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line(ggplot2::aes(colour = age)) +
  ggplot2::scale_colour_brewer("Age (cal yr BP)", palette = "Set1") +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  theme_bottom_legend
``` 

## Calculate corrected Precipitation

Using corrected MI and PET (calculated from modern temperature [CRU TS 4.04] and Padul temperature anomalies).

$$\text{corrected P}_\text{ann} = \text{MI} \times \text{PET}_\text{ann}$$

```{r, echo = FALSE}
padul_est_pr <- purrr::map_dbl(seq_along(padul_pet_tmp),
                               ~sum(padul_pet_tmp[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
```

```{r, echo = FALSE}
padul2 %>%
  dplyr::mutate(est_Pann = padul_est_pr) %>%
  dplyr::slice(c(1:15), c(100:105), c(175:180), c(275:280), c(430:438)) %>%
  knitr::kable(col.names = c("age [cal yr BP]",
                             "palaeo CO2 [umol/mol]",
                             "palaeo MGS temp [°C]",
                             "modern CO2 [umol/mol]",
                             "modern MGS temp [°C]",
                             "recon. MI [-]",
                             "recon. Pann [mm/day]",
                             "corrected MI [-]",
                             "estimated Pann [mm/day]"))
```

```{r, echo = FALSE}
# padul %>%
#   dplyr::select(1:3) %>%
#   dplyr::mutate(corr_mi = padul2$corr_mi,
#                 `est_Pann (MI ratio)` = padul2$est_Pann,
#                 `est_Pann (Tmp anomalies)` = padul_est_pr) %>%
#   dplyr::slice(c(1:15), c(100:105), c(175:180), c(275:280), c(430:438)) %>%
#   knitr::kable() # "pandoc", col.names = c(names(.)[1:5], "corrected MI", "corrected P_ann (MI ratio)", "corrected P_ann (Tmp anomalies)"))
```

<!-- ## Calculate MI -->

<!-- Using modern precipitation [CRU TS 4.04] and the PET (calculated from modern temperature [CRU TS 4.04] and the Padul temperature anomalies). -->

```{r, echo = FALSE, eval = FALSE}
pr <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.pre.dat-new-clim-1961-1990-int.nc"), "pre")$data

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - LAT))
idx_x <- which.min(abs(codos::lon$data - LON))

# Extract precipitation subset
padul_pr <- pr[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_pr) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_pr) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_pr <- colMeans(padul_pr, dims = 2)

rm(pr)
padul_mi <- purrr::map_dbl(padul_pet_tmp,
                           ~sum(padul_pr, na.rm = TRUE) / sum(.x, na.rm = TRUE))
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate cloud coverage from corrected MI

```{r}
padul_cld_corr_mi <- padul2$corr_mi %>%
  purrr::map_dbl(codos::cld)
```

Padul: cloud coverage
```{r cld_fig, echo = FALSE}
tibble::tibble(x = padul$age_cal_yr_BP,
               y = padul_cld_corr_mi) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "Cloud coverage [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  theme_bottom_legend
```


### Calculate cloud coverage anomalies

Rows `r min(ref_idx)`:`r max(ref_idx)` were used as the baseline to calculate the anomalies:

```{r, echo = FALSE}
ref_cld_corr_mi <- padul_cld_corr_mi %>%
  .[ref_idx] %>%
  mean()
```

```{r}
padul_cld_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map_dbl(~padul_cld_corr_mi[.x] - ref_cld_corr_mi)
```

Padul: cloud coverage anomalies
```{r cld-anomalies_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = padul$age_cal_yr_BP,
               y = padul_cld_anomalies) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "Cloud coverage anomalies [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  theme_bottom_legend
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Re-calculate potential evapotranspiration (PET)

```{r pet-cld-only, cache = FALSE, echo = FALSE}
year <- 1961
padul_sf2 <- 1 - (padul_cld_corr_mi + padul_cld_anomalies) / 100

oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_cld_corr_mi))
padul_pet_cld <- 
  seq_along(padul_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
padul_est_pr_cld <- 
  purrr::map_dbl(seq_along(padul_pet_cld),
                 ~sum(padul_pet_cld[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
```

After including temperature and cloud coverage anomalies.

```{r pet-tmp-cld, cache = FALSE, echo = FALSE}
year <- 1961
padul_sf2 <- 1 - (padul_cld_corr_mi + padul_cld_anomalies) / 100

oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_cld_corr_mi))
padul_pet_tmp_cld <- 
  seq_along(padul_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i] +
                                               padul_anomalies[k][[1]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

Padul: PET for age = `r padul[169, 1]` cal yr BP
```{r pet-ex1_fig, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_modern,
                     padul_pet_tmp[169][[1]],
                     padul_pet_tmp_cld[169][[1]]),
               var = rep(c("[CRU TS 4.04]",
                           "Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_bottom_legend
``` 


Padul: PET for age = `r padul[272, 1]` cal yr BP
```{r pet-ex2_fig, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(padul_pet_modern,
                     padul_pet_tmp[272][[1]],
                     padul_pet_tmp_cld[272][[1]]),
               var = rep(c("[CRU TS 4.04]",
                           "Tmp only",
                           "Tmp + cld "),
                         each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::scale_colour_brewer(name = "Anomalies", palette = "Set1") + 
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_bottom_legend
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ## Re-calculate corrected precipitation -->

```{r, echo = FALSE}
padul_est_pr_tmp_cld <- purrr::map_dbl(seq_along(padul_pet_tmp_cld),
                                         ~sum(padul_pet_tmp_cld[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
```

```{r, echo = FALSE}
# padul2 %>%
#   dplyr::mutate(est_Pann = padul_est_pr_tmp_cld) %>%
#   dplyr::slice(c(1:5), 162:172, c(272:280)) %>%
#   knitr::kable("pandoc")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```


## PET with orbital parameters
### Find orbital parameters

Selected samples and their orbital parameters:
```{r orbital-params, echo = FALSE, message = FALSE, fig.height = 10}
padul_years <- as.integer(padul$age_cal_yr_BP)
# Find orbital parameters
# padul_orb_params <- padul_years %>%
#   purrr::map_df(palinsol::astro, solution = palinsol::ber78, degree = TRUE)
# 
# # Append the years to the table with the orbital parameters
# padul_orb_params <- padul_orb_params %>%
#   dplyr::mutate(year = padul_years, .before = 1)

padul_orb_params <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/padul-orbital-params.csv")

# Print table with the first 10 rows
padul_orb_params %>%
  dplyr::slice(1:4, 113, 169, 272, 438) %>%
  knitr::kable()

padul_orb_params %>%
  tidyr::pivot_longer(cols = c(eps, ecc, varpi, epsp),
                      names_to = "var") %>%
  ggplot2::ggplot(ggplot2::aes(year / 1000, value)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::scale_x_reverse(breaks = seq(0, 200, 10),
                              labels = seq(0, 200, 10)) +
                              # scales::pretty_breaks(20)) +
  ggplot2::labs(x = "Age [kcal yrs BP]") +
  ggplot2::facet_wrap(facets = ~var, 
                      scales = "free",
                      labeller = ggplot2::labeller(var = c("ecc" = "Eccentricity (ecc)",
                                                           "eps" = "Obliquity (eps)",
                                                           "varpi" = "True Solar Longitude of the Perihelion (varpi)",
                                                           "epsp" = "(epsp)"))) +
  theme_bottom_legend
```

```{r, cache = FALSE, echo = FALSE, eval = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet_orb_params <- seq_along(padul_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = padul_elv,
                                             y = padul_years[k],
                                             sf = padul_sf[i],
                                             tc = padul_tmp[i],
                                             ke = padul_orb_params$ecc[k],
                                             keps = padul_orb_params$eps[k],
                                             komega = padul_orb_params$varpi[k])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)

padul_est_pr_orb_params <- 
  purrr::map_dbl(seq_along(padul_pet_orb_params),
                 ~sum(padul_pet_orb_params[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r pet-ultimate, cache = FALSE, echo = FALSE, eval = TRUE}
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_cld_corr_mi))
padul_pet_ultimate <- 
  seq_along(padul_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf2[k],
                                             tc = padul_tmp[i] +
                                               padul_anomalies[k][[1]][i],
                                             ke = padul_orb_params$ecc[k],
                                             keps = padul_orb_params$eps[k],
                                             komega = padul_orb_params$varpi[k])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)

padul_est_pr_ultimate <- purrr::map_dbl(seq_along(padul_pet_ultimate),
                                     ~sum(padul_pet_ultimate[.x][[1]], na.rm = TRUE) * padul2$corr_mi[.x])
```

<!-- Padul: PET for age = `r padul[169, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 5),
#                y = c(padul_pet_modern,
#                      padul_pet_tmp[169][[1]],
#                      padul_pet_tmp_cld[169][[1]],
#                      padul_pet_orb_params[169][[1]],
#                      padul_pet_ultimate[169][[1]]),
#                var = rep(c("[CRU TS 4.04]",
#                            "Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters",
#                            "Tmp + Cld anomalies & orbital params"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters",
#                                    "[CRU TS 4.04]",
#                                    "Tmp + Cld anomalies & orbital params"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   # ggsci::scale_colour_locuszoom(name = "") +
#   ggplot2::scale_colour_brewer(name = "", palette = "Set1") +
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_bottom_legend
#   # ggplot2::theme_bw()
``` 

<!-- Padul: PET for age = `r padul[272, 1]` cal yr BP -->
```{r, echo = FALSE}
# tibble::tibble(x = rep(seq_len(365), 5),
#                y = c(padul_pet_modern,
#                      padul_pet_tmp[272][[1]],
#                      padul_pet_tmp_cld[272][[1]],
#                      padul_pet_orb_params[272][[1]],
#                      padul_pet_ultimate[272][[1]]),
#                var = rep(c("[CRU TS 4.04]",
#                            "Tmp anomalies",
#                            "Tmp + Cld anomalies",
#                            "Only orbital parameters",
#                            "Tmp + Cld anomalies & orbital params"),
#                          each = 365) %>%
#                  factor(levels = c("Tmp anomalies", 
#                                    "Tmp + Cld anomalies", 
#                                    "Only orbital parameters",
#                                    "[CRU TS 4.04]",
#                                    "Tmp + Cld anomalies & orbital params"))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   # ggsci::scale_colour_locuszoom(name = "") +
#   ggplot2::scale_colour_brewer(name = "", palette = "Set1") +
#   ggplot2::geom_line() +
#   ggplot2::labs(x = "[days]",
#                 y = "PET [mm/day]") +
#   ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
#   theme_bottom_legend
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots
### Modern PET
Obtained from CRU TS 4.04
```{r modern-pet-cru-ts_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = seq_len(365),
               y = padul_pet_modern) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_bottom_legend
```

### PET changes
Padul: PET for age = `r padul[1, 1]` cal yr BP
```{r pet-change-ex1_fig, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 5),
               y = c(padul_pet_tmp[1][[1]] - padul_pet_modern,
                     padul_pet_cld[1][[1]] - padul_pet_modern,
                     padul_pet_tmp_cld[1][[1]] - padul_pet_modern,
                     padul_pet_orb_params[1][[1]] - padul_pet_modern,
                     padul_pet_ultimate[1][[1]] - padul_pet_modern),
               var = rep(c("Tmp anomalies",
                           "Cld anomalies",
                           "Tmp + Cld anomalies",
                           "Orbital parameters",
                           "Tmp + Cld anomalies & orbital params"),
                         each = 365) %>%
                 factor(levels = c("Tmp anomalies", 
                                   "Cld anomalies",
                                   "Orbital parameters",
                                   "Tmp + Cld anomalies", 
                                   "Tmp + Cld anomalies & orbital params"))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  # ggsci::scale_colour_locuszoom(name = "") +
  ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_bottom_legend
  # ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: PET for age = `r padul[169, 1]` cal yr BP
```{r pet-change-ex2_fig, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 5),
               y = c(padul_pet_tmp[169][[1]] - padul_pet_modern,
                     padul_pet_cld[169][[1]] - padul_pet_modern,
                     padul_pet_tmp_cld[169][[1]] - padul_pet_modern,
                     padul_pet_orb_params[169][[1]] - padul_pet_modern,
                     padul_pet_ultimate[169][[1]] - padul_pet_modern),
               var = rep(c("Tmp anomalies",
                           "Cld anomalies",
                           "Tmp + Cld anomalies",
                           "Orbital parameters",
                           "Tmp + Cld anomalies & orbital params"),
                         each = 365) %>%
                 factor(levels = c("Tmp anomalies", 
                                   "Cld anomalies",
                                   "Orbital parameters",
                                   "Tmp + Cld anomalies", 
                                   "Tmp + Cld anomalies & orbital params"))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  # ggsci::scale_colour_locuszoom(name = "") +
  ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_bottom_legend
  # ggplot2::theme_bw()
```

Padul: PET for age = `r padul[272, 1]` cal yr BP
```{r pet-change-ex3_fig, echo = FALSE}
tibble::tibble(x = rep(seq_len(365), 5),
               y = c(padul_pet_tmp[272][[1]] - padul_pet_modern,
                     padul_pet_cld[272][[1]] - padul_pet_modern,
                     padul_pet_tmp_cld[272][[1]] - padul_pet_modern,
                     padul_pet_orb_params[272][[1]] - padul_pet_modern,
                     padul_pet_ultimate[272][[1]] - padul_pet_modern),
               var = rep(c("Tmp anomalies",
                           "Cld anomalies",
                           "Tmp + Cld anomalies",
                           "Orbital parameters",
                           "Tmp + Cld anomalies & orbital params"),
                         each = 365) %>%
                 factor(levels = c("Tmp anomalies", 
                                   "Cld anomalies",
                                   "Orbital parameters",
                                   "Tmp + Cld anomalies", 
                                   "Tmp + Cld anomalies & orbital params"))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  # ggsci::scale_colour_locuszoom(name = "") +
  ggplot2::scale_colour_brewer(name = "Change with", palette = "Set1") +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  theme_bottom_legend
``` 

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `MI`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r mi-comparison_fig, echo = FALSE}
modern_mi <- sum(padul_pre) / sum(padul_pet_modern)
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi, 
                     padul2$corr_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(padul2))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  # ggplot2::geom_point(ggplot2::aes(0, modern_mi, colour = "Modern"),
  #                     size = 3) +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
  # ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(1, 0, 1),
  #                                                                    shape = c(NA, 19, NA)))) +
  theme_bottom_legend
```

- `age < 22k`
```{r mi-comparison-22k-zoom_fig, echo = FALSE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi, 
                     padul2$corr_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(padul2))) %>%
  .[.$x < 22000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
    theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r mi-comparison-with-co2-tmp_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corr_mi),
               co2 = rep(padul2$palaeo_co2 / 100, 2),
               palaeo_MGS_temp = rep(padul2$palaeo_MGS_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  theme_bottom_legend
```

- `age < 5k`

```{r mi-comparison-with-co2-tmp-5k-zoom_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul2$age_calBP, 2),
               y = c(padul2$recon_mi,
                     padul2$corr_mi),
               co2 = rep(padul2$palaeo_co2 / 100, 2),
               palaeo_MGS_temp = rep(padul2$palaeo_MGS_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(padul2))) %>%
  .[.$x < 5000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `P_ann`

<!-- ##### With MI ratio -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r pann-mi-ratio_fig, echo = FALSE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul2$est_Pann),
#                var = rep(c("Reconstructed", 
#                            "Corrected"), 
#                          each = nrow(padul2))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "P_ann", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", 
#                   y = "Annual precipitation [mm/year]") +
#     theme_bottom_legend
```

<!-- - `age < 22k` -->

```{r pann-mi-ratio-22k-zoom_fig, echo = FALSE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul2$est_Pann),
#                var = rep(c("Reconstructed", 
#                            "Corrected"), 
#                          each = nrow(padul2))) %>%
#   .[.$x < 22000, ] %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "P_ann", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", 
#                   y = "Annual precipitation [mm/year]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ##### With temperature anomalies -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r pann-tmp-anomalies_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr),
#                var = rep(c("recon. P_ann", 
#                            "With Tmp anomalies"), 
#                          each = nrow(padul))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend
```

<!-- ### `age < 22k` -->

```{r pann-tmp-anomalies-22k-zoom_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr),
#                var = rep(c("recon. P_ann", 
#                            "With Tmp anomalies"), 
#                          each = nrow(padul))) %>%
#   dplyr::filter(x < 22000) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ##### With cloud coverage anomalies -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r pann-cld-anomalies_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr_cld),
#                var = rep(c("recon. P_ann", 
#                            "With Cld anomalies"), 
#                          each = nrow(padul))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend
```

<!-- ### `age < 22k` -->

```{r pann-cld-anomalies-22k-zoom_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr_cld),
#                var = rep(c("recon. P_ann", 
#                            "With Cld anomalies"), 
#                          each = nrow(padul))) %>%
#   dplyr::filter(x < 22000) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ##### With orbital parameters -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r pann-orb-params_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr_orb_params),
#                var = rep(c("recon. P_ann", 
#                            "With orbital params"), 
#                          each = nrow(padul))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend
```

<!-- ### `age < 22k` -->

```{r pann-orb-params-22k-zoom_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr_orb_params),
#                var = rep(c("recon. P_ann", 
#                            "With orbital params"), 
#                          each = nrow(padul))) %>%
#   dplyr::filter(x < 22000) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ##### With temperature and cloud coverage anomalies -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r pann-tmp-cld-anomalies_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr_tmp_cld),
#                var = rep(c("recon. P_ann", 
#                            "With Tmp + Cld anomalies"), 
#                          each = nrow(padul))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend
```

<!-- ### `age < 22k` -->

```{r pann-tmp-cld-anomalies-22k-zoom_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
#                y = c(padul2$recon_Pann, 
#                      padul_est_pr_tmp_cld),
#                var = rep(c("recon. P_ann", 
#                            "With Tmp + Cld anomalies"), 
#                          each = nrow(padul))) %>%
#   dplyr::filter(x < 22000) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ##### With temperature and cloud coverage anomalies and orbital parameters -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r pann-all_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
               y = c(padul2$recon_Pann, 
                     padul_est_pr_ultimate),
               var = rep(c("recon. P_ann", 
                           "With Tmp and Cld anomalies and orbital params"), 
                         each = nrow(padul))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_bottom_legend
```

### `age < 22k`

```{r pann-all-22k-zoom_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(padul$age_cal_yr_BP, 2),
               y = c(padul2$recon_Pann, 
                     padul_est_pr_ultimate),
               var = rep(c("recon. P_ann", 
                           "With Tmp and Cld anomalies and orbital params"),
                         each = nrow(padul))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_bottom_legend
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ##### All the approaches -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = FALSE}
# tibble::tibble(age_cal_yr_BP = padul$age_cal_yr_BP,
#                palaeo_MGS_temp = padul2$palaeo_MGS_temp,
#                palaeo_co2 = padul2$palaeo_co2,
#                modern_co2 = padul2$modern_co2,
#                modern_MGS_temp = padul2$modern_MGS_temp,
#                recon_mi = padul2$recon_mi,
#                corr_mi = padul2$corr_mi,
#                recon_P_ann = padul2$recon_Pann,
#                est_Pann_MI_ratio = padul2$est_Pann,
#                est_Pann_Tmp_anomalies = padul_est_pr,
#                est_Pann_Cld_anomalies = padul_est_pr_cld,
#                est_Pann_Orbital_params = padul_est_pr_orb_params,
#                est_Pann_Tmp_Cld_anomalies = padul_est_pr_tmp_cld,
#                est_Pann_All = padul_est_pr_ultimate) %>%
#   readr::write_excel_csv("padul-corrections-2021-06.csv", na = "")
tibble::tibble(age_cal_yr_BP = padul$age_cal_yr_BP,
               palaeo_MGS_temp = padul2$palaeo_MGS_temp,
               palaeo_co2 = padul2$palaeo_co2,
               modern_co2 = padul2$modern_co2,
               modern_MGS_temp = padul2$modern_MGS_temp,
               recon_mi = padul2$recon_mi,
               corr_mi = padul2$corr_mi,
               recon_Pann = padul2$recon_Pann,
               est_Pann = padul_est_pr_ultimate) %>%
  readr::write_excel_csv("laguna-de-padul-corrections-2021-06.csv", na = "")
```

```{r pann-comparison_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 7),
#                y = c(padul2$recon_Pann, 
#                      padul2$est_Pann,
#                      padul_est_pr,
#                      padul_est_pr_cld,
#                      padul_est_pr_tmp_cld,
#                      padul_est_pr_orb_params,
#                      padul_est_pr_ultimate),
#                var = factor(rep(c("reconstructed",
#                                  "MI ratio",
#                                  "With Tmp anomalies",
#                                  "With Cld anomalies",
#                                  "With Tmp + Cld anomalies",
#                                  "With orbital parameters",
#                                  "With Tmp + Cld anomalies and orbital params"), 
#                          each = nrow(padul)),
#                          levels = c("reconstructed",
#                                     "MI ratio",
#                                     "With Tmp anomalies",
#                                     "With Cld anomalies",
#                                     "With orbital parameters",
#                                     "With Tmp + Cld anomalies",
#                                     "With Tmp + Cld anomalies and orbital params"))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
#   ggsci::scale_colour_locuszoom(name = "Precipitation") +
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend_black
```

<!-- ### `age < 22k` -->

```{r pann-comparison-22k-zoom_fig, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 7),
#                y = c(padul2$recon_Pann, 
#                      padul2$est_Pann,
#                      padul_est_pr,
#                      padul_est_pr_cld,
#                      padul_est_pr_tmp_cld,
#                      padul_est_pr_orb_params,
#                      padul_est_pr_ultimate),
#                var = factor(rep(c("reconstructed",
#                                  "MI ratio",
#                                  "With Tmp anomalies",
#                                  "With Cld anomalies",
#                                  "With Tmp + Cld anomalies",
#                                  "With orbital parameters",
#                                  "With Tmp + Cld anomalies and orbital params"), 
#                          each = nrow(padul)),
#                          levels = c("reconstructed",
#                                     "MI ratio",
#                                     "With Tmp anomalies",
#                                     "With Cld anomalies",
#                                     "With orbital parameters",
#                                     "With Tmp + Cld anomalies",
#                                     "With Tmp + Cld anomalies and orbital params"))) %>%
#   dplyr::filter(x < 22000) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
#     ggsci::scale_colour_locuszoom(name = "Precipitation") +
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend_black
```

```{r, echo = FALSE}
# tibble::tibble(x = rep(padul$age_cal_yr_BP, 6),
#                y = c(padul2$recon_Pann, 
#                      padul2$est_Pann,
#                      padul_est_pr,
#                      padul_est_pr_tmp_cld,
#                      padul_est_pr_orb_params,
#                      padul_est_pr_ultimate),
#                var = factor(rep(c("reconstructed",
#                            "MI ratio",
#                            "With Tmp anomalies",
#                            "With Tmp + cld anomalies",
#                            "With orbital parameters",
#                            "With Tmp + cld anomalies and orbital params"), 
#                          each = nrow(padul)),
#                          levels = c("reconstructed",
#                                     "MI ratio",
#                                     "With Tmp anomalies",
#                                     "With Tmp + cld anomalies",
#                                     "With orbital parameters",
#                                     "With Tmp + cld anomalies and orbital params"))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   # ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Set1") + 
#   ggsci::scale_colour_locuszoom(name = "Precipitation") +
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   ggplot2::theme_bw()
```

# References

[1] Bereiter, B., Eggleston, S., Schmitt, J., Nehrbass‐Ahles, C., Stocker, T. F.,
Fischer, H., Kipfstuhl, S., and Chappellaz, J. (2015), Revision of the EPICA
Dome C CO2 record from 800 to 600 kyr before present, Geophys. Res. Lett., 
42, 542– 549, <doi:10.1002/2014GL061957>.

# Appendix

<!-- ## A1. Find reconstructed `MI` using `loess` -->

```{r, echo = FALSE}
# palaeo_co2_loess <- function(age_calBP, ref = codos::ice_core) {
#   # Extract the reference age and co2
#   ref_age <- purrr::pluck(ref, 1)
#   ref_co2 <- purrr::pluck(ref, 2)
#   if (age_calBP < min(ref_age))
#     return(ref_co2[which.min(ref_age)])
#   
#   if (age_calBP > max(ref_age))
#     return(ref_co2[which.max(ref_age)])
#   loessMod10 <- loess(co2 ~ age_calBP,
#                       tibble::tibble(age_calBP = ref_age,
#                                      co2 = ref_co2), span = 0.1)
#   return(predict(loessMod10, age_calBP))
# }
# 
# padul2$palaeo_co2_loess <- purrr::map_dbl(padul2$age_calBP, 
#                                         palaeo_co2_loess)
# padul2$corr_mi_loess <- codos::corrected_mi(padul2$modern_MGS_temp,
#                                                  padul2$palaeo_MGS_temp,
#                                                  padul2$recon_mi,
#                                                  padul2$modern_co2,
#                                                  padul2$palaeo_co2_loess)
# 
# head(padul2, 10) %>%
#   dplyr::select(-c(palaeo_co2, corr_mi, est_Pann)) %>%
#   knitr::kable() %>%
#   kableExtra::kable_styling()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ## A2. Plot reconstructed vs corrected `MI` both approaches -->

```{r, echo = FALSE}
# tibble::tibble(x = rep(padul2$age_calBP, 3),
#                y = c(padul2$recon_mi, 
#                      padul2$corr_mi, 
#                      padul2$corr_mi_loess),
#                var = rep(c("reconstructed", 
#                            "corrected (mean)", 
#                            "corrected (loess)"), 
#                          each = nrow(padul2))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
#     ggplot2::theme_bw()
```

<!-- - `age < 5k` -->

```{r, echo = FALSE}
# tibble::tibble(x = rep(padul2$age_calBP, 3),
#                y = c(padul2$recon_mi, 
#                      padul2$corr_mi, 
#                      padul2$corr_mi_loess),
#                var = rep(c("reconstructed", 
#                            "corrected (mean)", 
#                            "corrected (loess)"), 
#                          each = nrow(padul2))) %>%
#   .[.$x < 5000, ] %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
#     ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ## A3. Reconstructed vs corrected `MI`: Past CO2 calculated using `loess` -->
<!-- #### Include past CO2 and Temperature -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                y = c(padul2$recon_mi,
#                      padul2$corr_mi_loess),
#                co2 = rep(padul2$palaeo_co2_loess / 100, 2),
#                palaeo_MGS_temp = rep(padul2$palaeo_MGS_temp / 5, 2),
#                var = rep(c("MI: reconstructed",
#                            "MI: corrected"),
#                         each = nrow(padul2))) %>%
#   ggplot2::ggplot() +
#   ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
#   ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Temp")) +
#   ggplot2::scale_colour_manual(name = NULL, 
#                              values = c("past CO2 [1/100]" = "gold",
#                                         "Temp" = "black",
#                                         "MI: reconstructed" = "#E41A1C",
#                                         "MI: corrected" = "#377EB8")) +
#   # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
#                               sec.axis = ggplot2::sec_axis(~.*5,
#                                                            name = "Temp [°C]",
#                                                            breaks = scales::pretty_breaks(15))
#   ) +
#   ggplot2::labs(x = "Age [cal yrs BP]",
#   # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
#   y = "MI [-] and CO2 [1/100 ppm]") +
#   ggplot2::theme_bw()
```

<!-- - `age < 5k` -->

```{r, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                y = c(padul2$recon_mi,
#                      padul2$corr_mi_loess),
#                co2 = rep(padul2$palaeo_co2_loess / 100, 2),
#                palaeo_MGS_temp = rep(padul2$palaeo_MGS_temp / 5, 2),
#                var = rep(c("MI: reconstructed",
#                            "MI: corrected"),
#                         each = nrow(padul2))) %>%
#   .[.$x < 5000, ] %>%
#   ggplot2::ggplot() +
#   ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
#   ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Temp")) +
#   ggplot2::scale_colour_manual(name = NULL, 
#                              values = c("past CO2 [1/100]" = "gold",
#                                         "Temp" = "black",
#                                         "MI: reconstructed" = "#E41A1C",
#                                         "MI: corrected" = "#377EB8")) +
#   # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
#                               sec.axis = ggplot2::sec_axis(~.*5,
#                                                            name = "Temp [°C]",
#                                                            breaks = scales::pretty_breaks(15))
#   ) +
#   ggplot2::labs(x = "Age [cal yrs BP]",
#   # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
#   y = "MI [-] and CO2 [1/100 ppm]") +
#   ggplot2::theme_bw()
```

<!-- ## A4. Compare  `codos::ice_core` vs past CO2 calculate using `mean` and `loess` -->

```{r, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                y = c(padul2$palaeo_co2,
#                      padul2$palaeo_co2_loess),
#                var = rep(c("Mean", 
#                            "LOESS (span = 0.1)"), 
#                          each = nrow(padul2))) %>%
#   ggplot2::ggplot() +
#     ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= max(padul2$age_calBP), ],
#                        ggplot2::aes(age_gas_calBP, 
#                                     co2_ppm, 
#                                     colour = "ice-core")) +
#     ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
#     # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
#     ggplot2::scale_colour_manual(name = "past CO2", 
#                                  values = c("Gold", "#E41A1C", "#377EB8")) +
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(10)) +
#     ggplot2::labs(x = "Age [cal yrs BP]",
#                   y = "CO2 [ppm]") +
#     ggplot2::theme_bw()
```

<!-- - `age < 5k` -->

```{r, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                      y = c(padul2$palaeo_co2,
#                            padul2$palaeo_co2_loess),
#                      var = rep(c("Mean", 
#                                  "LOESS (span = 0.1)"), 
#                                each = nrow(padul2))) %>%
#   
#   .[.$x < 5000, ] %>%
#   ggplot2::ggplot() +
#     ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 5000, ],
#                        ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
#     ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
#     # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
#     ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]",
#                   y = "CO2 [ppm]") +
#     ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- - `age < 500` -->

```{r, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(padul2$age_calBP, 2),
#                      y = c(padul2$palaeo_co2,
#                            padul2$palaeo_co2_loess),
#                      var = rep(c("Mean", 
#                                  "LOESS (span = 0.1)"), 
#                                each = nrow(padul2))) %>%
#   
#   .[.$x < 500, ] %>%
#   ggplot2::ggplot() +
#     ggplot2::geom_line(data = codos::ice_core[codos::ice_core$age_gas_calBP <= 500, ],
#                        ggplot2::aes(age_gas_calBP, co2_ppm, colour = "ice-core")) +
#     ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
#     # ggplot2::scale_colour_brewer(name = "past CO2", palette = "Set1") +
#     ggplot2::scale_colour_manual(name = "past CO2", values = c("Gold", "#E41A1C", "#377EB8")) +
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]",
#                   y = "CO2 [ppm]") +
#     ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ## A5. Padul Data -->
## A1. Laguna de Padul Data
<!-- Download the CSV file: [padul-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/padul-with-corrected-mi.csv) -->

```{r, echo = FALSE}
padul2 <- padul2 %>%
  dplyr::mutate(est_Pann = padul_est_pr_ultimate)

padul2 %>% 
  readr::write_excel_csv(file = "laguna-de-padul-with-corr-mi-and-est-pann.csv", 
                         na = "")

padul2 %>%
  dplyr::select(-dplyr::ends_with(("loess"))) %>%
  knitr::kable(longtable = TRUE,
               col.names = c("age [cal yr BP]",
                             "palaeo CO2 [umol/mol]",
                             "palaeo MGS temp [°C]",
                             "modern CO2 [umol/mol]",
                             "modern MGS temp [°C]",
                             "recon. MI [-]",
                             "recon. Pann [mm/day]",
                             "corrected MI [-]",
                             "estimated Pann [mm/day]"))
# padul2 %>%
#   dplyr::select(-dplyr::ends_with(("loess"))) %>%
#   knitr::kable(longtable = TRUE)
```
