---
title: "Padul Data: MI and Precip. corrections"
output: 
  pdf_document:
    extra_dependencies: ["float", "longtable"]
    latex_engine: xelatex
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500, 
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/padul-step-by-step-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H", 
  out.extra = ""
)

options(knitr.kable.NA = '',
        knitr.kable.format = "pandoc")

# options(knitr.table.format = function() {
#   if (knitr::is_latex_output()) 'latex' else 'pandoc'
# })

# Set path to working directory
# path <- "~/Desktop/iCloud/UoR/Data/CRU/4.04/"
path <- "~/OneDrive - University of Reading/UoR/Data/CRU/4.04/"

# Load padul data
# padul <- readr::read_csv("~/Desktop/iCloud/UoR/Data/padul.csv")
padul <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/padul.csv")

`%>%` <- magrittr::`%>%`
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

# New corrections

## Calculate temperature anomalies

Using both $T_\text{djf}$ and $T_\text{jja}$ for each record, a sinusoidal curve
was fitted using the `int_sin` function.

```{r, echo = TRUE}
padul <- padul %>%
  dplyr::mutate(Tmean = (T_jja + T_djf) / 2,
                Tmax = Tmean + (T_jja - Tmean) / 0.9,
                Tmin = Tmean + (T_djf - Tmean) / 0.9)
```

```{r, echo = FALSE, fig.height = 5}
codos::int_sin(padul$Tmin[1], padul$Tmax[1]) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[1]),
                          ggplot2::aes(x, y, colour = "T_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[1]),
                          ggplot2::aes(x, y, colour = "T_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = paste0(padul$`Age (cal yr BP)`[1], " cal yr BP")) +
      ggplot2::theme_bw()
```

Row 1 was used as the baseline to calculate the temperature anomalies.

```{r}
padul %>%
  dplyr::slice(1) %>%
  knitr::kable()
```

where
$$T_\text{mean} = (T_\text{jja} + T_\text{djf}) / 2$$
$$T_\text{max} = T_\text{mean} + (T_\text{jja} - T_\text{mean}) / 0.9$$
$$T_\text{min} = T_\text{mean} + (T_\text{djf} - T_\text{mean}) / 0.9$$

```{r, echo = TRUE}
padul_anomalies <- seq_len(nrow(padul)) %>%
  purrr::map(~codos::int_sin(padul$Tmin[.x] - padul$Tmin[1],
                             padul$Tmax[.x] - padul$Tmax[1]))
```                         

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: Anomaly for age = `r padul[179, 1]` cal yr BP

```{r, echo = FALSE}
padul %>%
  dplyr::slice(1, 179) %>%
  rbind(c(NA, NA, NA, diff(.$T_djf), diff(.$T_jja), diff(.$Tmean), diff(.$Tmax), diff(.$Tmin))) %>%
  knitr::kable()
```

```{r, fig.height = 5, echo = FALSE}
codos::int_sin(padul$Tmin[179] - padul$Tmin[1], 
               padul$Tmax[179] - padul$Tmax[1]) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[179] - padul$T_djf[1]),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[179] - padul$T_jja[1]),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = paste0(padul$`Age (cal yr BP)`[179], " cal yr BP")) +
      ggplot2::theme_bw()
```

Padul: Anomaly for age = `r padul[274, 1]` cal yr BP

```{r, echo = FALSE}
padul %>%
  dplyr::slice(1, 274) %>%
  rbind(c(NA, NA, NA, diff(.$T_djf), diff(.$T_jja), diff(.$Tmean), diff(.$Tmax), diff(.$Tmin))) %>%
  knitr::kable()
```

```{r, fig.height = 5, echo = FALSE}
codos::int_sin(padul$Tmin[274] - padul$Tmin[1], 
               padul$Tmax[274] - padul$Tmax[1]) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = padul$T_djf[274] - padul$T_djf[1]),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = padul$T_jja[274] - padul$T_jja[1]),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = paste0(padul$`Age (cal yr BP)`[274], " cal yr BP")) +
      ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate potential evapotranspiration (PET)

Padul location: 37.0108, -3.6039

```{r, echo = FALSE}
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), 
                          "elv")
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), 
                          "cld")$data
tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.daily.tmp.nc"), 
                          "tmp")$data
sf <- 1 - cld / 100

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - 37.0108))
idx_x <- which.min(abs(codos::lon$data + 3.6039))

# Extract elevation subset
padul_elv <- elv$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(padul_elv) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_elv) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_elv <- mean(padul_elv)

# Extract sunshine fraction subset
padul_sf <- sf[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_sf) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_sf) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_sf <- colMeans(padul_sf, dims = 2)

# Extract cloud coverage subset
padul_cld <- cld[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_cld) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_cld) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_cld <- colMeans(padul_cld, dims = 2)

# Extract temperature subset
padul_tmp <- tmp[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(padul_tmp) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(padul_tmp) <- codos::lon$data[c(idx_x, idx_x + 1)]
padul_tmp <- colMeans(padul_tmp, dims = 2)
```

```{r, echo = FALSE}
# Delete large objects from the environment
rm(elv, cld, sf, tmp)
```

```{r, cache = TRUE, echo = FALSE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
padul_pet <- c(1, 179, 247) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf[i],
                                             tc = padul_tmp[i] + 
                                               padul_anomalies[[k]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

```{r, cache = TRUE, echo = FALSE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(padul_anomalies))
tmp_anomalies <- padul_anomalies %>%
  .[c(1, 179, 247)]
padul_pet2 <- c(1, 179, 247) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = 37.0108,
                                             n = i,
                                             elv = padul_elv,
                                             y = year,
                                             sf = padul_sf[i],
                                             tc = padul$Tmean[k] + 
                                               padul_anomalies[[k]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

##### Padul PET: Anomaly for age = `r padul[179, 1]` cal yr BP

##### Params (`splash::calc_daily_evap`)

- Latitude: `37.0108`
- Elevation: `r padul_elv`
- Year: `1961`
- Sunshine fraction: [`CRU TS 4.04`]
<!-- - Temperature: [`CRU TS 4.04`] $+ T_\text{anomalies}$ -->
- Temperature: $T_\text{mean, i}$ (`r padul[179, "Tmean"]`) $+ T_\text{anomalies, i, day}$

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(seq_len(365), 2),
               y = c(padul_pet[2][[1]],
                     padul_pet2[2][[1]]),
               Tmp = rep(c("modern [CRU TS]", 
                           "T_mean"), 
                       each = 365)) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line(ggplot2::aes(colour = Tmp)) +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

```{r, echo = FALSE}
tibble::tibble(x = seq_len(365),
               y = padul_cld) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "Modern Cloud coverage [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(12)) +
  ggplot2::theme_bw()
```

```{r, echo = FALSE}
tibble::tibble(day = seq_len(365),
               sf = padul_sf,
               Tmean = padul$Tmean[179] + padul_anomalies[[179]],
               `PET with Tmean` = padul_pet2[2][[1]],
               Tcru = padul_tmp + padul_anomalies[[179]],
               `PET with CRU TS` = padul_pet[2][[1]]) %>%
  dplyr::slice(1:5, 100:105, 200:205, 300:305) %>%
  knitr::kable(col.names = c("day", 
                             "sunshine fraction", 
                             "Temp",
                             "PET", 
                             "Temp",
                             "PET")) %>%
  kableExtra::add_header_above(c(" " = 2, 
                                 "[(T_djf + T_jja) / 2]" = 2,
                                 "CRU TS 4.04" = 2))# %>%
  # kableExtra::column_spec(c(1, 2), border_left = TRUE)
```

## Calculate corrected Precipitation

<!-- Using corrected MI and PET (calculated from modern temperature [CRU TS 4.04] and Padul temperature anomalies). -->

$$\text{corrected P}_\text{ann} = \text{MI} \times \text{PET}_\text{ann}$$

```{r, echo = FALSE}
padul2 <- tibble::tibble(age_calBP = padul$`Age (cal yr BP)`,
                         past_temp = rowMeans(padul[, c("T_djf", "T_jja")]),
                         past_co2 = padul$`Age (cal yr BP)` %>%
                           purrr::map_dbl(codos::past_co2),
                         modern_co2 = tibble::tibble(age = 1950 - c(1961:1990),
                                                     co2 = age %>% 
                                                       purrr::map_dbl(codos::past_co2)) %>%
                           .$co2 %>%
                           mean(), # 340,
                         present_t = rowMeans(padul[, c("T_djf", "T_jja")]), # modern_tmp, 
                         recon_mi = padul$MI)
padul2$corrected_mi <- codos::corrected_mi(padul2$present_t,
                                           padul2$past_temp,
                                           padul2$recon_mi,
                                           padul2$modern_co2,
                                           padul2$past_co2)
padul_corrected_pr <- purrr::map_dbl(seq_along(padul_pet2),
                                     ~sum(padul_pet2[.x][[1]], na.rm = TRUE) * padul2$corrected_mi[.x])
```

```{r, echo = FALSE}
padul2 %>%
  dplyr::slice(1, 179, 247) %>%
  dplyr::mutate(corrected_P_ann = padul_corrected_pr) %>%
  knitr::kable("pandoc")
```
