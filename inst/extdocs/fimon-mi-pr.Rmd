---
title: "Lago di Fimon Data: MI and Pann corrections"
subtitle: "(45.469951, 11.543468)"
output:
  pdf_document:
    extra_dependencies: ["float", "longtable"]
    latex_engine: xelatex
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500,
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/lago-di-fimon-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H",
  out.extra = ""
)

options(knitr.kable.NA = '',
        knitr.kable.format = "pandoc")

# Set path to working directory
path <- "~/OneDrive - University of Reading/UoR/Data/CRU/4.04/"

`%>%` <- magrittr::`%>%`
`%$%` <- magrittr::`%$%`

month_breaks <- c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)

# Load fimon data
fimon <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/fimon.csv", skip = 2) %>%
  magrittr::set_colnames(colnames(.) %>%
                           stringr::str_remove_all("_MAT_wm$") %>%
                           stringr::str_replace_all("k5", "ssse") %>%
                           stringr::str_replace_all("age_chron21", "age_cal_yr_BP") %>%
                           # stringr::str_replace_all("Pann", "Pann") %>%
                           # stringr::str_replace_all("Tjan", "Tjan") %>%
                           stringr::str_replace_all("Tjuly", "Tjul")) %>%
  dplyr::select(-dplyr::starts_with("ATR"),
                -dplyr::ends_with("ssse"),
                -depth_cm) %>%
  dplyr::mutate(Tmean = (Tjul + Tjan) / 2,
                Tmax = Tmean + (Tjul - Tmean) / 0.9,
                Tmin = Tmean + (Tjan - Tmean) / 0.9,
                Tgs = list(Tmin, Tmax) %>%
                  purrr::pmap_dbl(function(Tmin, Tmax) {
                    aux <- codos::int_sin(Tmin, Tmax)
                    mean(aux[aux > 0])
                  })
                # Tgs = seq_len(nrow(fimon)) %>%
                #   purrr::map_dbl(function(i) {
                #     aux <- codos::int_sin(fimon$Tmin[i], fimon$Tmax[i])
                #     mean(aux[aux > 0])
                #   })
                # Tgs = seq_len(nrow(fimon)) %>%
                #   purrr::map_dbl(function(i) {
                #     aux <- codos::int_sin(fimon$Tjan[i], fimon$Tjul[i])
                #     mean(aux[aux > 0])
                #   })
                )
head(fimon)

ref_idx <- 5:9 # -40 < age < -10
LAT <- 45.469951
LON <- 11.543468

theme_bottom_legend <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey20"),
                 panel.grid = ggplot2::element_line(colour = "grey92"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey85",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "white", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")

theme_bottom_legend_black <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey2"),
                 panel.grid = ggplot2::element_line(colour = "grey20"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "grey2", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

## Obtain palaeo (past) CO2 from (Bereiter et al. 2015)

```{r obtain-palaeo-co2}
palaeo_co2 <- fimon %$%
  purrr::map_dbl(age_cal_yr_BP, codos::past_co2)
```

## Obtain modern CO2 from (Bereiter et al. 2015)

```{r obtain-modern-co2-20th}
modern_co2 <- tibble::tibble(age = 1950 - c(1901:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %$%
  median(co2)
```

## Read "modern" data - Quinto Vicentino station
```{r read-modern-data, eval = FALSE}
quinto_vicentino_tmin <- readr::read_csv("/path/to/fimon-lake/quinto_vicentino_tmin.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
quinto_vicentino_tmax <- readr::read_csv("/path/to/fimon-lake/quinto_vicentino_tmax.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
```

```{r read-modern-data-hidden, echo = FALSE, message = FALSE}
quinto_vicentino_tmin <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/quinto_vicentino_tmin.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
quinto_vicentino_tmax <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/quinto_vicentino_tmax.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))

# Find mean temperature
quinto_vicentino_tmean <- (quinto_vicentino_tmax + quinto_vicentino_tmin) / 2
quinto_vicentino_tmp_clim <- quinto_vicentino_tmean %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean, na.rm = TRUE)) %>%
  dplyr::mutate(Tjan = jan,
                Tjul = jul) %>%
  dplyr::mutate(Tmean = (Tjul + Tjan) / 2) %>%
  dplyr::mutate(Tmax = Tmean + (Tjul - Tmean) / 0.9) %>%
  dplyr::mutate(Tmin = Tmean + (Tjan - Tmean) / 0.9)
quinto_vicentino_tmp <- with(quinto_vicentino_tmp_clim, codos::int_sin(Tjan, Tjul))

# Modern precipitation
quinto_vicentino_pann_clim <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/quinto_vicentino_precip.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.))) %>%
  dplyr::select(-year) %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean, na.rm = TRUE))

quinto_vicentino_pann <- quinto_vicentino_pann_clim %>%
  dplyr::summarise(sum(jan:dic)) %>%
  purrr::flatten_dbl()
```

Fit a sinusoidal curve between the mean value for the coldest month, `T_jan =` `r round(quinto_vicentino_tmp_clim$Tjan, 4)`, and the warmest month, `T_jul =` `r round(quinto_vicentino_tmp_clim$Tjul, 4)`.

```{r modern-temp_fig, echo = FALSE, fig.height = 5}
codos::int_sin(quinto_vicentino_tmp_clim$Tmin, quinto_vicentino_tmp_clim$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = quinto_vicentino_tmp_clim$Tjan),
                          ggplot2::aes(x, y, colour = "Tjan")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = quinto_vicentino_tmp_clim$Tjul),
                          ggplot2::aes(x, y, colour = "Tjul")) +
      ggplot2::scale_colour_manual(name = "Temp.",
                                   values = c("#0080ff","#ff3333")) +
  
      ggplot2::scale_x_continuous(breaks = month_breaks) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = "'Modern' Lago di Fimon [avg. for 1994 < year < 2018]") +
      ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r temp-comparison_fig, echo = FALSE}
tibble::tibble(x = rep(fimon$age_cal_yr_BP, 3),
               y = c(fimon$Tjan,
                     fimon$Tjul,
                     fimon$Tgs),
                     # rep(mean(quinto_vicentino_tmp), nrow(fimon))),
               var = rep(c("Tjan", 
                           "Tjul", 
                           "Palaeo Mean Growing Season"), 
                           # "Modern Mean Growing Season"), 
                         each = nrow(fimon))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::geom_point(ggplot2::aes(12000, 
                                   mean(quinto_vicentino_tmp), 
                                   colour = "Modern Mean Growing Season"),
                      size = 3) +
  ggsci::scale_color_jco(name = "") +
  # ggplot2::scale_colour_brewer(name = "", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", 
                y = "Temperature [°C]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1),
                                                                    shape = c(19, NA, NA, NA)))) +
  theme_bottom_legend
```

## Assemble the _Lago di Fimon_ data

```{r assemble-data-set}
fimon2 <- tibble::tibble(age_calBP = fimon$age_cal_yr_BP,
                         palaeo_co2 = palaeo_co2,
                         palaeo_MGS_temp = fimon$Tgs,
                         modern_co2 = modern_co2,
                         modern_MGS_temp = mean(quinto_vicentino_tmp),
                         recon_mi = fimon$MI,
                         recon_Pann = fimon$Pann)
```

## Find the corrected `MI`
```{r find-corrected-mi}
corr_mi <- fimon2 %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)
fimon2 <- fimon2 %>%
  dplyr::mutate(corr_mi = corr_mi)
```

Records for which the corrected MI is smaller than reconstructed MI
```{r, echo = FALSE}
# Find years for which the corrected MI is smaller than reconstructed
idx <- which(corr_mi - fimon$MI < 0)

fimon2 %>%
  dplyr::slice(c(idx)) %>%
  knitr::kable(col.names = c("age cal yr BP",
                             "palaeo co2",
                             "palaeo MGS temp",
                             "modern co2",
                             "modern MGS temp",
                             "recon. MI",
                             "recon. Pann",
                             "corr. MI"))
```

```{r plot-of-anomalous-records_fig, echo = FALSE}
aux <- fimon2[idx, ] %>%
  dplyr::mutate(palaeo_MGS_temp2 = palaeo_MGS_temp + 1,
                palaeo_MGS_temp3 = palaeo_MGS_temp - 1)

corr_mi2 <- aux %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp2,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)
corr_mi3 <- aux %$%
  codos::corrected_mi(Tc0 = modern_MGS_temp,
                      Tc1 = palaeo_MGS_temp3,
                      MI = recon_mi,
                      ca0 = modern_co2,
                      ca1 = palaeo_co2)

aux_long <- aux %>%
  dplyr::select(-palaeo_MGS_temp2,
                -palaeo_MGS_temp3) %>%
  dplyr::mutate(corr_mi_Tmp_plus_1 = corr_mi2,
                corr_mi_Tmp_minus_1 = corr_mi3) %$% 
  tibble::tibble(age_calBP = rep(age_calBP, 3),
                 palaeo_co2 = rep(palaeo_co2, 3),
                 palaeo_MGS_temp = c(palaeo_MGS_temp,
                                     palaeo_MGS_temp + 1,
                                     palaeo_MGS_temp - 1),
                 modern_co2 = rep(modern_co2, 3),
                 modern_MGS_temp = rep(modern_MGS_temp, 3),
                 recon_mi = rep(recon_mi, 3),
                 corr_mi = c(corr_mi,
                               corr_mi_Tmp_plus_1,
                               corr_mi_Tmp_minus_1),
                 cat = rep(c("0", "+1", "-1"), each = 3))


aux_long %$%
  tibble::tibble(x = rep(age_calBP, 2),
                 y = c(recon_mi,
                       corr_mi),
                 co2 = rep(palaeo_co2 / 100, 2),
                 palaeo_MGS_temp = rep(palaeo_MGS_temp / 5, 2),
                 Temperature = rep(cat, 2),
                 var = rep(c("MI: reconstructed",
                             "MI: corrected"),
                           each = length(corr_mi))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var, linetype = Temperature)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(14500, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

```{r head-of-data-set, echo = FALSE, eval = FALSE}
# Small subset
knitr::kable(head(fimon2, 5),
             col.names = c("age cal yr BP",
                           "palaeo co2",
                           "palaeo MGS temp",
                           "modern co2",
                           "modern MGS temp",
                           "recon. MI",
                           "recon. Pann",
                           "corr. MI"))
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ## Find the corrected Annual Precipitation, `Pann` -->

<!-- Approximated as the ratio -->

<!-- $$\text{MI}_\text{ratio}= \frac{\text{corrected}}{\text{reconstructed}}$$ -->
<!-- multiplied by reconstructed `Pann`. -->

```{r find-corrected-pann-as-mi-ratio, echo = FALSE}
# mi_ratio <- fimon2$corr_mi / fimon2$recon_mi
# # fimon2$recon_Pann <- fimon$Pann
# fimon2$est_Pann <- fimon2$recon_Pann * mi_ratio
```

```{r show-results-after-corr-pann, echo = FALSE}
# Small subset
# knitr::kable(head(fimon2, 20),
#              col.names = c("age cal yr BP",
#                            "palaeo co2",
#                            "palaeo temp",
#                            "modern co2",
#                            "modern temp",
#                            "recon. MI",
#                            "recon. Pann",
#                            "corr. MI",
#                            "corr. Pann"))
```

<!-- Check out and download the entire dataset in [Appendix A1](#a1-lago-di-fimon-data). -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r load-cru-ts-ref-data, echo = FALSE}
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), 
                          "elv")
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), 
                          "cld")$data
tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.daily.tmp.nc"),
                          "tmp")$data
sf <- 1 - cld / 100

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - LAT))
idx_x <- which.min(abs(codos::lon$data - LON))

# Extract elevation subset
fimon_elv <- elv$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(fimon_elv) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_elv) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_elv <- mean(fimon_elv)

# Extract sunshine fraction subset
fimon_sf_cru_ts <- sf[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(fimon_sf_cru_ts) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_sf_cru_ts) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_sf_cru_ts <- colMeans(fimon_sf_cru_ts, dims = 2)

# Extract cloud coverage subset
fimon_cld_cru_ts <- cld[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(fimon_cld_cru_ts) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_cld_cru_ts) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_cld_cru_ts <- colMeans(fimon_cld_cru_ts, dims = 2)

# Extract temperature subset
fimon_tmp_cru_ts <- tmp[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(fimon_tmp_cru_ts) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_tmp_cru_ts) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_tmp_cru_ts <- colMeans(fimon_tmp_cru_ts, dims = 2)
```

```{r delete-large-objects, echo = FALSE}
# Delete large objects from the environment
rm(elv, cld, sf, tmp)
```

```{r calculate-modern-pet, echo = FALSE}
year <- 1961
fimon_pet_modern <- seq_len(365) %>%
  purrr::map_dbl(function(i) {
    splash::calc_daily_evap(lat = LAT,
                            n = i,
                            elv = fimon_elv,
                            y = year,
                            sf = fimon_sf_cru_ts[i],
                            tc = quinto_vicentino_tmp[i])$pet_mm#fimon_tmp_cru_ts[i])$pet_mm
 })
```

<!-- Modern MI: `r quinto_vicentino_pann / sum(fimon_pet_modern)` -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

# New corrections
## Find anomalies (`Tmp` and `cld`)
```{r find-cld-from-corr-mi, echo = FALSE}
fimon_cld_corr_mi <- fimon2$corr_mi %>%
  purrr::map_dbl(codos::cld)

# ref_cld_corr_mi <- fimon_cld_corr_mi %>%
#   mean()
ref_cld_corr_mi <- mean(fimon_cld_cru_ts)
fimon_modern <- quinto_vicentino_tmp_clim
```

Data from the weather station Quinto Vicentino was used as the baseline to calculate the temperature anomalies and data from the CRU TS 4.04 dataset for the baseline cloud coverage, `r ref_cld_corr_mi`.

#### Cloud coverage from corrected MI

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r cld-comparison_fig, echo = FALSE, fig.height = 4.5}
tibble::tibble(x = fimon2$age_calBP,
               y = fimon_cld_corr_mi) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = "recon Cld")) +
  ggplot2::geom_line() +
  ggplot2::geom_point(ggplot2::aes(12000, 
                                   ref_cld_corr_mi, 
                                   colour = "ref Cld [CRU TS 4.04]"),
                      size = 3) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                y = "Cld [%]") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(10)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(10)) +
  # ggplot2::geom_hline(ggplot2::aes(yintercept = ref_cld_corr_mi,
  #                                  )) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("ref Cld [CRU TS 4.04]" = "#E41A1C",
                                          "recon Cld" = "#377EB8")) +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1),
                                                                     shape = c(19, NA)))) +
  theme_bottom_legend
```

```{r find-anomalies, echo = TRUE}
fimon_tmp_anomalies <- seq_len(nrow(fimon)) %>%
  purrr::map(~codos::int_sin(fimon$Tmin[.x] - fimon_modern$Tmin,
                             fimon$Tmax[.x] - fimon_modern$Tmax))

fimon_cld_anomalies <- seq_len(nrow(fimon)) %>%
  purrr::map_dbl(~fimon_cld_corr_mi[.x] - ref_cld_corr_mi)
fimon_sf_anomalies <- 1 - (fimon_cld_corr_mi + fimon_cld_anomalies) / 100
```                         

#### Temperature anomalies

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

Lago di Fimon: Anomalies for age = `r fimon[1, 1]` cal yr BP
```{r anomaly-ex1_fig, fig.height = 4.5, echo = FALSE}
codos::int_sin(fimon$Tmin[1] - fimon_modern$Tmin,
               fimon$Tmax[1] - fimon_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      # ggplot2::geom_point(data = tibble::tibble(x = 1, y = fimon$Tjan[1] - fimon_modern$Tjan),
      #                     ggplot2::aes(x, y, colour = "dTjan")) +
      # ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = fimon$Tjul[1] - fimon_modern$Tjul),
      #                     ggplot2::aes(x, y, colour = "dTjul")) +
      # ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
      #                              values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      ggplot2::theme_bw()
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- Lago di Fimon: Anomalies for age = `r fimon[59, 1]` cal yr BP -->
```{r anomaly-ex2_fig, fig.height = 5, echo = FALSE}
# codos::int_sin(fimon$Tmin[59] - fimon_modern$Tmin,
#                fimon$Tmax[59] - fimon_modern$Tmax) %>%
#   tibble::tibble(x = seq_len(365), y = .) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y)) +
#       ggplot2::geom_line() +
#       ggplot2::geom_point(data = tibble::tibble(x = 1, y = fimon$Tjan[59] - fimon_modern$Tjan),
#                           ggplot2::aes(x, y, colour = "dTjan")) +
#       ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = fimon$Tjul[59] - fimon_modern$Tjul),
#                           ggplot2::aes(x, y, colour = "dTjul")) +
#       ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
#                                    values = c("#0080ff","#ff3333")) +
#       ggplot2::labs(x = "[days]",
#                     y = "Temp [°C]") +
#       ggplot2::theme_bw()
```

<!-- Lago di Fimon: Anomalies for age = `r fimon[140, 1]` cal yr BP -->
```{r anomaly-ex3_fig, fig.height = 5, echo = FALSE}
# codos::int_sin(fimon$Tmin[140] - fimon_modern$Tmin,
#                fimon$Tmax[140] - fimon_modern$Tmax) %>%
#   tibble::tibble(x = seq_len(365), y = .) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y)) +
#       ggplot2::geom_line() +
#       ggplot2::geom_point(data = tibble::tibble(x = 1, y = fimon$Tjan[140] - fimon_modern$Tjan),
#                           ggplot2::aes(x, y, colour = "dTjan")) +
#       ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = fimon$Tjul[140] - fimon_modern$Tjul),
#                           ggplot2::aes(x, y, colour = "dTjul")) +
#       ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
#                                    values = c("#0080ff","#ff3333")) +
#       ggplot2::labs(x = "[days]",
#                     y = "Temp [°C]") +
#       ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

## Find orbital parameters

Selected samples and their orbital parameters:
```{r orbital-params_fig, echo = FALSE, message = FALSE, fig.height = 10}
fimon_years <- as.integer(fimon$age_cal_yr_BP)
# Find orbital parameters
fimon_orb_params <- -fimon_years %>%
  purrr::map_df(palinsol::astro, solution = palinsol::ber78, degree = TRUE)

# Append the years to the table with the orbital parameters
fimon_orb_params <- fimon_orb_params %>%
  dplyr::mutate(year = fimon_years, .before = 1)

# fimon_orb_params <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-orbital-params.csv")

# Print table with the first 10 rows
fimon_orb_params %>%
  dplyr::slice(1:4, 59, 169, 146) %>%
  knitr::kable()

fimon_orb_params %>%
  tidyr::pivot_longer(cols = c(eps, ecc, varpi, epsp),
                      names_to = "var") %>%
  ggplot2::ggplot(ggplot2::aes(year / 1000, value)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::scale_x_reverse(breaks = seq(0, 200, 10),
                              labels = seq(0, 200, 10)) +
                              # scales::pretty_breaks(20)) +
  ggplot2::labs(x = "Age [kcal yrs BP]") +
  ggplot2::facet_wrap(facets = ~var,
                      scales = "free",
                      labeller = ggplot2::labeller(var = c("ecc" = "Eccentricity (ecc)",
                                                           "eps" = "Obliquity (eps)",
                                                           "varpi" = "True Solar Longitude of the Perihelion (varpi)",
                                                           "epsp" = "(epsp)"))) +
  ggplot2::theme_bw()
```

<!-- where -->
<!-- $$T_\text{mean} = (T_\text{jja} + T_\text{djf}) / 2$$ -->
<!-- $$T_\text{max} = T_\text{mean} + (T_\text{jja} - T_\text{mean}) / 0.9$$ -->

<!-- $$T_\text{min} = T_\text{mean} + (T_\text{djf} - T_\text{mean}) / 0.9$$ -->

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = TRUE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate potential evapotranspiration (PET)

```{r pet-w-tmp-anomalies, echo = FALSE, eval = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(fimon_tmp_anomalies))
fimon_pet_ultimate <- seq_along(fimon_tmp_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = fimon_elv,
                                             y = year,
                                             sf = fimon_sf_anomalies[k],
                                             tc = quinto_vicentino_tmp[i] + 
                                               fimon_tmp_anomalies[[k]][i],
                                             ke = fimon_orb_params$ecc[k],
                                             keps = fimon_orb_params$eps[k],
                                             komega = fimon_orb_params$varpi[k])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

##### Params (`splash::calc_daily_evap`)

- Latitude: `r LAT`
- Elevation: `r fimon_elv`
<!-- - Year: `1961` -->
- Sunshine fraction: [`CRU TS 4.04`] $+ \text{Cld}_\text{anomalies}$ 
- Temperature:  [`Quinto Vicentino station`] $+ \text{Tmp}_\text{anomalies}$

```{r pet-comparison_fig, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(fimon_pet_ultimate[[1]],
                     fimon_pet_ultimate[[59]],
                     fimon_pet_modern),
               age = rep(c(fimon$age_cal_yr_BP[1], 
                           fimon$age_cal_yr_BP[59],
                           "[Modern, 1994 - 2018]"),
                         each = 365) %>%
                 as.factor()) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line(ggplot2::aes(colour = age)) +
  ggplot2::scale_colour_brewer("Age (cal yr BP)", palette = "Set1") +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  theme_bottom_legend
``` 

## Calculate estimated Precipitation

$$\text{estimated P}_\text{ann} = \text{MI} \times \text{PET}_\text{ann}$$

```{r, echo = FALSE}
fimon_estimated_pr <- purrr::map_dbl(seq_along(fimon_pet_ultimate),
                                     ~sum(fimon_pet_ultimate[.x][[1]], na.rm = TRUE) * fimon2$corr_mi[.x])
# fimon_estimated_pr_ultimate <- fimon_estimated_pr
fimon_estimated_pr_ultimate <- purrr::map_dbl(seq_along(fimon_pet_ultimate),
                                     ~sum(fimon_pet_ultimate[.x][[1]], na.rm = TRUE) * fimon2$corr_mi[.x])
```

```{r, echo = FALSE}
fimon %>%
  dplyr::select(1:3) %>%
  dplyr::mutate(`corr. MI` = fimon2$corr_mi,
                # `corr Pann (MI ratio)` = fimon2$est_Pann,
                `est. Pann (Tmp + Cld anomalies & Orb. Par.)` = fimon_estimated_pr) %>%
  dplyr::slice(1:11) %>%
  knitr::kable(col.names = c("age [cal yrs BP]",
                             "recon. MI",
                             "recon. Pann",
                             "corrected MI", 
                             "estimated Pann (Tmp + Cld anomalies & Orb. Par.)"))
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots

#### Reconstructed vs corrected `MI`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r recon-vs-corr-mi, echo = FALSE}
modern_mi <- quinto_vicentino_pann / sum(fimon_pet_modern)
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi, 
                     fimon2$corr_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(fimon2))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::geom_point(ggplot2::aes(12000, modern_mi, colour = "Modern"),
                      size = 3) +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(1, 0, 1),
                                                                     shape = c(NA, 19, NA)))) +
  theme_bottom_legend
```

- `age < 22k`
```{r recon-vs-corr-mi-22k-zoom, echo = FALSE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi, 
                     fimon2$corr_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(fimon2))) %>%
  .[.$x < 22000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
  ggplot2::geom_point(ggplot2::aes(12000, modern_mi, colour = "Modern"),
                      size = 3) +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
    ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(1, 0, 1),
                                                                       shape = c(NA, 19, NA)))) +
    theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r recon-vs-corr-mi-with-co2-tmp, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi,
                     fimon2$corr_mi),
               co2 = rep(fimon2$palaeo_co2 / 100, 2),
               palaeo_MGS_temp = rep(fimon2$palaeo_MGS_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(fimon2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(12000, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

- `age < 22k`

```{r recon-vs-corr-mi-with-co2-tmp-22k-zoom, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi,
                     fimon2$corr_mi),
               co2 = rep(fimon2$palaeo_co2 / 100, 2),
               palaeo_MGS_temp = rep(fimon2$palaeo_MGS_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(fimon2))) %>%
  .[.$x < 22000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "Palaeo CO2 [1/100]")) +
  ggplot2::geom_point(ggplot2::aes(12000, modern_co2 / 100, 
                                   colour = "Modern CO2 [1/100]"),
                      size = 2) +
  ggplot2::geom_line(ggplot2::aes(x, palaeo_MGS_temp, colour = "Palaeo MGS Temperature")) +
  ggplot2::scale_colour_manual(name = NULL, 
                               values = c("Palaeo CO2 [1/100]" = "gold",
                                          "Palaeo MGS Temperature" = "black",
                                          "MI: reconstructed" = "#E41A1C",
                                          "MI: corrected" = "#377EB8",
                                          "Modern CO2 [1/100]" = "#09BA00")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Palaeo MGS Temperature [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
                # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
                y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::guides(colour = ggplot2::guide_legend(override.aes = list(linetype = c(0, 1, 1, 1, 0),
                                                                     shape = c(19, NA, NA, NA, 19)))) +
  theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs estimated `Pann`

<!-- ##### With MI ratio -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r recon-vs-corr-pann-mi-ratio, echo = FALSE}
# tibble::tibble(x = rep(fimon2$age_calBP, 2),
#                y = c(fimon$Pann, 
#                      fimon2$est_Pann),
#                var = rep(c("Reconstructed", 
#                            "Corrected"), 
#                          each = nrow(fimon2))) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Pann", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     # ggplot2::geom_hline(yintercept = ref_cld_corr_mi)
#     ggplot2::labs(x = "Age [cal yrs BP]", 
#                   y = "Annual precipitation [mm/year]") +
#     theme_bottom_legend
```

<!-- - `age < 22k` -->

```{r recon-vs-corr-pann-mi-ratio-22k-zoom, echo = FALSE}
# tibble::tibble(x = rep(fimon2$age_calBP, 2),
#                y = c(fimon$Pann, 
#                      fimon2$est_Pann),
#                var = rep(c("Reconstructed", 
#                            "Corrected"), 
#                          each = nrow(fimon2))) %>%
#   .[.$x < 22000, ] %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Pann", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", 
#                   y = "Annual precipitation [mm/year]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```

<!-- ##### With temperature and cloud coverage anomalies and orbital parameters -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r recon-vs-corr-pann-all, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(fimon$age_cal_yr_BP, 2),
               y = c(fimon$Pann, 
                     fimon_estimated_pr_ultimate),
               var = rep(c("recon. Pann", 
                           "With Tmp and Cld anomalies and orbital params"), 
                         each = nrow(fimon))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
  theme_bottom_legend
```

### `age < 22k`

```{r recon-vs-corr-pann-all-22k-zoom, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(fimon$age_cal_yr_BP, 2),
               y = c(fimon$Pann, 
                     fimon_estimated_pr_ultimate),
               var = rep(c("recon. Pann", 
                           "With Tmp and Cld anomalies and orbital params"),
                         each = nrow(fimon))) %>%
  dplyr::filter(x < 22000) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
    theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

<!-- ##### All the approaches -->

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r recon-vs-corr-pann-comparison, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(fimon$age_cal_yr_BP, 3),
#                y = c(fimon$Pann, 
#                      fimon2$est_Pann,
#                      fimon_estimated_pr_ultimate),
#                var = factor(rep(c("recon. Pann", 
#                                   "MI ratio",
#                                   "With Tmp and Cld anomalies and orbital params"), 
#                                 each = nrow(fimon)),
#                             levels = c("recon. Pann",
#                                        "With Tmp and Cld anomalies and orbital params",
#                                        "MI ratio"))) %>%
# ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#   ggplot2::geom_line() +
#   ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#   ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#   ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#   theme_bottom_legend
```

<!-- ### `age < 22k` -->

```{r recon-vs-corr-pann-comparison-22k-zoom, echo = FALSE, eval = TRUE}
# tibble::tibble(x = rep(fimon$age_cal_yr_BP, 3),
#                y = c(fimon$Pann, 
#                      fimon2$est_Pann,
#                      fimon_estimated_pr_ultimate),
#                var = factor(rep(c("recon. Pann", 
#                                   "MI ratio",
#                                   "With Tmp and Cld anomalies and orbital params"), 
#                                 each = nrow(fimon)),
#                             levels = c("recon. Pann",
#                                        "With Tmp and Cld anomalies and orbital params",
#                                        "MI ratio"))) %>%
#   dplyr::filter(x < 22000) %>%
#   ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
#     ggplot2::geom_line() +
#     ggplot2::scale_colour_brewer(name = "Precipitation", palette = "Dark2") + 
#     ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
#     ggplot2::labs(x = "Age [cal yrs BP]", y = "Precip [mm/day]") +
#     theme_bottom_legend
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
# knitr::asis_output('\n\n\\newpage')
```
# Appendix

## A1. Lago di Fimon Data
<!-- Download the CSV file: [fimon-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/fimon-with-corrected-mi.csv) -->

```{r, echo = FALSE}
# fimon2$est_Pann <- fimon2$recon_Pann * mi_ratio
fimon2$est_Pann <- fimon_estimated_pr_ultimate
fimon2 %>% 
  readr::write_excel_csv(file = "lago-di-fimon-with-corr-mi-and-est-pann.csv", 
                         na = "")

fimon2 %>%
  dplyr::select(-dplyr::ends_with(("loess"))) %>%
  knitr::kable(longtable = TRUE,
               col.names = c("age [cal yr BP]",
                             "palaeo co2 [umol/mol]",
                             "palaeo MGS temp [°C]",
                             "modern co2 [umol/mol]",
                             "modern MGS temp [°C]",
                             "recon. MI [-]",
                             "recon. Pann [mm/day]",
                             "corr. MI [-]",
                             "est. Pann [mm/day]"))
```
