---
title: "Lago di Fimon Data: MI and P_ann corrections"
subtitle: "(45.469951, 11.543468)"
output:
  pdf_document:
    extra_dependencies: ["float", "longtable"]
    latex_engine: xelatex
  github_document:
    pandoc_args: --webtex
    always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  dpi = 500,
  out.width = "100%",
  comment = "#>",
  fig.path = "man/figures/fimon-mi-pr-",
  fig.width = 12,
  fig.height = 6,
  fig.pos = "!H",
  out.extra = ""
)

options(knitr.kable.NA = '',
        knitr.kable.format = "pandoc")

# Set path to working directory
path <- "~/OneDrive - University of Reading/UoR/Data/CRU/4.04/"

`%>%` <- magrittr::`%>%`
`%$%` <- magrittr::`%$%`

# Load fimon data
fimon <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/fimon.csv", skip = 2) %>%
  magrittr::set_colnames(colnames(.) %>%
                           stringr::str_remove_all("_MAT_wm$") %>%
                           stringr::str_replace_all("k5", "ssse") %>%
                           stringr::str_replace_all("age_chron21", "age_cal_yr_BP") %>%
                           stringr::str_replace_all("Pann", "P_ann") %>%
                           stringr::str_replace_all("Tjan", "T_djf") %>%
                           stringr::str_replace_all("Tjuly", "T_jja")) %>%
  dplyr::select(-dplyr::starts_with("ATR"),
                -dplyr::ends_with("ssse"),
                -depth_cm)
head(fimon)

ref_idx <- 5:9 # -40 < age < -10
LAT <- 45.469951
LON <- 11.543468

theme_pet <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "white",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey20"),
                 panel.grid = ggplot2::element_line(colour = "grey92"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey85",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "white", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")

theme_pet_black <- 
  ggplot2::theme(panel.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = NA),
                 panel.border = ggplot2::element_rect(fill = NA,
                                                      colour = "grey2"),
                 panel.grid = ggplot2::element_line(colour = "grey20"),
                 panel.grid.minor = ggplot2::element_line(size = ggplot2::rel(0.5)),
                 strip.background = ggplot2::element_rect(fill = "grey2",
                                                          colour = "grey20"),
                 legend.key = ggplot2::element_rect(fill = "grey2", 
                                                    colour = NA),
                 complete = TRUE,
                 legend.position = "bottom")
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\renewcommand{\\arraystretch}{1.5}')
```

#### Calculate daily mean temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r}
fimon_tmp <- rowMeans(fimon[, c("T_djf", "T_jja")])
```

## Obtain past CO2 from (Bereiter et al. 2015)

```{r}
past_co2 <- fimon %>%
  .$age_cal_yr_BP %>%
  purrr::map_dbl(codos::past_co2)
```

## Obtain modern CO2 from (Bereiter et al. 2015)

```{r modern_co2_20th}
modern_co2 <- tibble::tibble(age = 1950 - c(1901:1990),
                             co2 = purrr::map_dbl(age, codos::past_co2)) %>%
  .$co2 %>%
  median()
```

## Assemble the _Lago di Fimon_ data
```{r}
fimon2 <- tibble::tibble(age_calBP = fimon$age_cal_yr_BP,
                         past_temp = fimon_tmp,
                         past_co2 = past_co2,
                         modern_co2 = modern_co2,
                         present_t = fimon_tmp,
                         recon_mi = fimon$MI)
```

## Find the corrected `MI`
```{r}
fimon2$corr_mi <- codos::corrected_mi(fimon2$present_t,
                                      fimon2$past_temp,
                                      fimon2$recon_mi,
                                      fimon2$modern_co2,
                                      fimon2$past_co2)
```

```{r, echo = FALSE}
# Small subset
knitr::kable(head(fimon2, 4),
             col.names = c("age cal yr BP",
                           "past temp",
                           "past co2",
                           "modern co2",
                           "present temp",
                           "recon. MI",
                           "corr. MI"))
```


## Read "modern" data - Quinto Vicentino
```{r, eval = FALSE}
quinto_vicentino_precip <- readr::read_csv("/path/to/fimon-lake/quinto_vicentino_precip.csv", 
                                           na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
quinto_vicentino_tmin <- readr::read_csv("/path/to/fimon-lake/quinto_vicentino_tmin.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
quinto_vicentino_tmax <- readr::read_csv("/path/to/fimon-lake/quinto_vicentino_tmax.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
```


```{r, echo = FALSE, message = FALSE}
quinto_vicentino_precip <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/quinto_vicentino_precip.csv", 
                                           na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
quinto_vicentino_tmin <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/quinto_vicentino_tmin.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
quinto_vicentino_tmax <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-lake/quinto_vicentino_tmax.csv", 
                                         na = ">>") %>%
  magrittr::set_names(tolower(colnames(.)))
```

##### P_ann
```{r, echo = FALSE}
quinto_vicentino_precip %>%
  knitr::kable()
```

##### Tmin
```{r, echo = FALSE}
quinto_vicentino_tmin %>%
  knitr::kable()
```

#### Tmax
```{r, echo = FALSE}
quinto_vicentino_tmin %>%
  knitr::kable()
```

#### Summary
```{r, echo = FALSE, message = FALSE}
quinto_vicentino_precip_long <- quinto_vicentino_precip %>%
  tidyr::pivot_longer(2:13, names_to = "month", values_to = "P_ann")
quinto_vicentino_tmin_long <- quinto_vicentino_tmin %>%
  tidyr::pivot_longer(2:13, names_to = "month", values_to = "Tmin")
quinto_vicentino_tmax_long <- quinto_vicentino_tmax %>%
  tidyr::pivot_longer(2:13, names_to = "month", values_to = "Tmax")

quinto_vicentino_all <- quinto_vicentino_precip_long %>%
  dplyr::left_join(quinto_vicentino_tmin_long, by = c("year", "month")) %>%
  dplyr::left_join(quinto_vicentino_tmax_long, by = c("year", "month")) %>%
  # dplyr::mutate(Tmean = mean(Tmin, Tmax, na.rm = TRUE))
  dplyr::mutate(Tmean = (Tmin + Tmax) / 2)

quinto_vicentino_all %>%
  dplyr::mutate(season = dplyr::case_when(month %in% c("dic", "jan", "feb") ~ "djf",
                                          month %in% c("jun", "jul", "aug") ~ "jja",
                                          TRUE ~ NA_character_)) %>%
                                          # month %in% c("mar", "apr", "may") ~ "mam",
                                          # TRUE ~ as.character("son"))) %>%
  dplyr::filter(season %in% c("djf", "jja")) %>%
  dplyr::group_by(year, season) %>%
  dplyr::summarise(P_ann = mean(P_ann),
                   Tmin = mean(Tmin, na.rm = TRUE),
                   Tmax = mean(Tmax, na.rm = TRUE)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_longer(3:5) %>%
  dplyr::arrange(year, name, season) %>%
  dplyr::mutate(var = stringr::str_c(name, "_", season)) %>%
  dplyr::select(-season, -name) %>%
  tidyr::pivot_wider(names_from = var, values_from = value) %>%
  knitr::kable()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Find the corrected Annual Precipitation, `P_ann`

Approximated as the ratio

$$\text{MI}_\text{ratio}= \frac{\text{corrected}}{\text{reconstructed}}$$
multiplied by reconstructed `P_ann`.

```{r}
mi_ratio <- fimon2$corr_mi / fimon2$recon_mi
fimon2$corr_P_ann <- fimon$P_ann * mi_ratio
```

```{r, echo = TRUE}
fimon2 %>% 
  write.csv(file = "fimon-with-corrected-mi.csv",
            row.names = FALSE)

# Small subset
knitr::kable(head(fimon2, 13),
             col.names = c("age cal yr BP",
                           "past temp",
                           "past co2",
                           "modern co2",
                           "present temp",
                           "recon. MI",
                           "corr. MI",
                           "corr. Pann"))
```

Check out and download the entire dataset in [Appendix A1](#a1-lago-di-fimon-data).

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

```{r, echo = FALSE}
elv <- codos:::nc_var_get(file.path(path, "halfdeg.elv.nc"), 
                          "elv")
cld <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc"), 
                          "cld")$data
tmp <- codos:::nc_var_get(file.path(path, "cru_ts4.04.1901.2019.daily.tmp.nc"),
                          "tmp")$data
sf <- 1 - cld / 100

# Extract the nearest 4 grid cells
idx_y <- which.min(abs(codos::lat$data - LAT))
idx_x <- which.min(abs(codos::lon$data - LON))

# Extract elevation subset
fimon_elv <- elv$data[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y)]
rownames(fimon_elv) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_elv) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_elv <- mean(fimon_elv)

# Extract sunshine fraction subset
fimon_sf <- sf[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(fimon_sf) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_sf) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_sf <- colMeans(fimon_sf, dims = 2)

# Extract cloud coverage subset
fimon_cld <- cld[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(fimon_cld) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_cld) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_cld <- colMeans(fimon_cld, dims = 2)

# Extract temperature subset
fimon_tmp <- tmp[c(idx_x, idx_x + 1), c(idx_y - 1, idx_y), ]
rownames(fimon_tmp) <- codos::lat$data[c(idx_y, idx_y - 1)]
colnames(fimon_tmp) <- codos::lon$data[c(idx_x, idx_x + 1)]
fimon_tmp <- colMeans(fimon_tmp, dims = 2)
```

```{r, echo = FALSE}
# Delete large objects from the environment
rm(elv, cld, sf, tmp)
```

```{r, echo = FALSE}
year <- 1961
fimon_pet_modern <- seq_len(365) %>%
  purrr::map_dbl(function(i) {
    splash::calc_daily_evap(lat = LAT,
                            n = i,
                            elv = fimon_elv,
                            y = year,
                            sf = fimon_sf[i],
                            tc = fimon_tmp[i])$pet_mm
 })
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = TRUE}
knitr::asis_output('\n\n\\newpage')
```

# New corrections

## Calculate temperature anomalies

Using both $T_\text{djf}$ and $T_\text{jja}$ for each record, a sinusoidal curve
was fitted using the `int_sin` function.

```{r, echo = TRUE}
fimon <- fimon %>%
  dplyr::mutate(Tmean = (T_jja + T_djf) / 2) %>%
  dplyr::mutate(Tmax = Tmean + (T_jja - Tmean) / 0.9) %>%
  dplyr::mutate(Tmin = Tmean + (T_djf - Tmean) / 0.9)
```

```{r, echo = FALSE}
fimon_modern <- quinto_vicentino_all %>%
  dplyr::mutate(season = dplyr::case_when(month %in% c("dec", "jan", "feb") ~ "djf",
                                          month %in% c("mar", "apr", "may") ~ "mam",
                                          month %in% c("jun", "jul", "aug") ~ "jja",
                                          TRUE ~ as.character("son"))) %>%
  dplyr::select(-month) %>%
  dplyr::group_by(year, season) %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean, na.rm = TRUE)) %>%
  # dplyr::summarise(P_ann = mean(P_ann, na.rm = TRUE),
  #                  Tmin = mean(Tmin, na.rm = TRUE),
  #                  Tmax = mean(Tmax, na.rm = TRUE)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(season %in% c("djf", "jja")) %>%
  tidyr::pivot_longer(3:6) %>%
  dplyr::arrange(year, name, season) %>%
  dplyr::mutate(var = stringr::str_c(name, "_", season)) %>%
  dplyr::select(-season, -name) %>%
  tidyr::pivot_wider(names_from = var, values_from = value) %>%
  dplyr::select(-1) %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean, na.rm = TRUE)) %>%
  dplyr::mutate(P_ann = (P_ann_djf + P_ann_djf) / 2,
                T_djf = (Tmax_djf + Tmin_djf) / 2,
                T_jja = (Tmax_jja + Tmin_jja) / 2) %>%
  dplyr::mutate(Tmean = (T_jja + T_djf) / 2) %>%
  dplyr::mutate(Tmax = Tmean + (T_jja - Tmean) / 0.9) %>%
  dplyr::mutate(Tmin = Tmean + (T_djf - Tmean) / 0.9)
```

```{r, echo = FALSE, fig.height = 5}
codos::int_sin(fimon_modern$Tmin, fimon_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = fimon_modern$T_djf),
                          ggplot2::aes(x, y, colour = "T_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = fimon_modern$T_jja),
                          ggplot2::aes(x, y, colour = "T_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]",
                    title = "'Modern' Lago di Fimon") +
      ggplot2::theme_bw()
```

Data from the weather station Quinto Vicentino was used as the baseline to calculate the temperature anomalies.

```{r, echo = FALSE}
quinto_vicentino_all %>%
  dplyr::select(-month) %>%
  dplyr::group_by(year) %>%
  dplyr::summarise(dplyr::across(dplyr::everything(), mean, na.rm = TRUE)) %>%
  rbind(c(NA, mean(.$P_ann, na.rm = TRUE), mean(.$Tmean, na.rm = TRUE), mean(.$Tmax, na.rm = TRUE), mean(.$Tmin, na.rm = TRUE))) %>%
  knitr::kable()
```

where
$$T_\text{mean} = (T_\text{jja} + T_\text{djf}) / 2$$
$$T_\text{max} = T_\text{mean} + (T_\text{jja} - T_\text{mean}) / 0.9$$

$$T_\text{min} = T_\text{mean} + (T_\text{djf} - T_\text{mean}) / 0.9$$

```{r, echo = TRUE}
fimon_anomalies <- seq_len(nrow(fimon)) %>%
  purrr::map(~codos::int_sin(fimon$Tmin[.x] - fimon_modern$Tmin,
                             fimon$Tmax[.x] - fimon_modern$Tmax))
```                         

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

Padul: Anomaly for age = `r fimon[1, 1]` cal yr BP
```{r, fig.height = 5, echo = FALSE}
codos::int_sin(fimon$Tmin[1] - fimon_modern$Tmin, 
               fimon$Tmax[1] - fimon_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = fimon$T_djf[1] - fimon_modern$T_djf),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = fimon$T_jja[1] - fimon_modern$T_jja),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      ggplot2::theme_bw()
```

Padul: Anomaly for age = `r fimon[59, 1]` cal yr BP
```{r, fig.height = 5, echo = FALSE}
codos::int_sin(fimon$Tmin[59] - fimon_modern$Tmin, 
               fimon$Tmax[59] - fimon_modern$Tmax) %>%
  tibble::tibble(x = seq_len(365), y = .) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
      ggplot2::geom_line() +
      ggplot2::geom_point(data = tibble::tibble(x = 1, y = fimon$T_djf[59] - fimon_modern$T_djf),
                          ggplot2::aes(x, y, colour = "dT_djf")) +
      ggplot2::geom_point(data = tibble::tibble(x = 365 / 2, y = fimon$T_jja[59] - fimon_modern$T_jja),
                          ggplot2::aes(x, y, colour = "dT_jja")) +
      ggplot2::scale_colour_manual(name = "Recon. \nTemp.",
                                   values = c("#0080ff","#ff3333")) +
      ggplot2::labs(x = "[days]",
                    y = "Temp [°C]") +
      ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Calculate potential evapotranspiration (PET)

```{r pet-w-tmp-anomalies, cache = TRUE, echo = FALSE, eval = TRUE}
year <- 1961
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(fimon_anomalies))
fimon_pet_tmp <- seq_along(fimon_anomalies) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = fimon_elv,
                                             y = year,
                                             sf = fimon_sf[i],
                                             tc = fimon_tmp[i] + fimon_anomalies[[k]][i])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)
```

##### Params (`splash::calc_daily_evap`)

- Latitude: `r LAT`
- Elevation: `r fimon_elv`
- Year: `1961`
- Sunshine fraction: [`CRU TS 4.04`]
- Temperature:  [`CRU TS 4.04`] $+ T_\text{anomalies}$

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(seq_len(365), 3),
               y = c(fimon_pet_tmp[1][[1]],
                     fimon_pet_tmp[59][[1]],
                     fimon_pet_modern),
               age = rep(c(fimon$age_cal_yr_BP[1], 
                           fimon$age_cal_yr_BP[59],
                           "[CRU TS 4.04]"),
                         each = 365) %>%
                 as.factor()) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line(ggplot2::aes(colour = age)) +
  ggplot2::scale_colour_brewer("Age (cal yr BP)", palette = "Set1") +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::theme_bw()
``` 

## Calculate corrected Precipitation

Using corrected MI and PET (calculated from modern temperature [CRU TS 4.04] and Padul temperature anomalies).

$$\text{corrected P}_\text{ann} = \text{MI} \times \text{PET}_\text{ann}$$

```{r, echo = FALSE}
fimon_corrected_pr <- purrr::map_dbl(seq_along(fimon_pet_tmp),
                                     ~sum(fimon_pet_tmp[.x][[1]], na.rm = TRUE) * fimon2$corr_mi[.x])
```

```{r, echo = FALSE}
fimon %>%
  dplyr::select(1:3) %>%
  dplyr::mutate(corr_mi = fimon2$corr_mi,
                `corr_P_ann (MI ratio)` = fimon2$corr_P_ann,
                `corr_P_ann (Tmp anomalies)` = fimon_corrected_pr) %>%
  dplyr::slice(1:20) %>%
  knitr::kable() # "pandoc", col.names = c(names(.)[1:5], "corrected MI", "corrected P_ann (MI ratio)", "corrected P_ann (Tmp anomalies)"))
```

<!-- ## Find orbital parameters -->

<!-- Selected samples and their orbital parameters: -->
```{r orbital-params, echo = FALSE, message = FALSE, fig.height = 10}
# fimon_years <- as.integer(fimon$age_cal_yr_BP)
# # Find orbital parameters
# fimon_orb_params <- fimon_years %>%
#   purrr::map_df(palinsol::astro, solution = palinsol::ber78, degree = TRUE)
# 
# # Append the years to the table with the orbital parameters
# fimon_orb_params <- fimon_orb_params %>%
#   dplyr::mutate(year = fimon_years, .before = 1)

fimon_orb_params <- readr::read_csv("~/OneDrive - University of Reading/UoR/Data/fimon-orbital-params.csv")

# # Print table with the first 10 rows
# fimon_orb_params %>%
#   dplyr::slice(1:4, 59, 169, 146) %>%
#   knitr::kable()

# fimon_orb_params %>%
#   tidyr::pivot_longer(cols = c(eps, ecc, varpi, epsp),
#                       names_to = "var") %>%
#   ggplot2::ggplot(ggplot2::aes(year / 1000, value)) +
#   ggplot2::geom_point() +
#   ggplot2::geom_line() +
#   ggplot2::scale_x_reverse(breaks = seq(0, 200, 10),
#                               labels = seq(0, 200, 10)) +
#                               # scales::pretty_breaks(20)) +
#   ggplot2::labs(x = "Age [kcal yrs BP]") +
#   ggplot2::facet_wrap(facets = ~var, 
#                       scales = "free",
#                       labeller = ggplot2::labeller(var = c("ecc" = "Eccentricity (ecc)",
#                                                            "eps" = "Obliquity (eps)",
#                                                            "varpi" = "True Solar Longitude of the Perihelion (varpi)",
#                                                            "epsp" = "(epsp)"))) +
#   ggplot2::theme_bw()
```

```{r pet-ultimate, cache = TRUE, echo = FALSE, eval = FALSE}
oplan <- future::plan(future::multisession, workers = 8)
{p <- progressr::progressor(steps = length(fimon_cld_corr_mi))
fimon_pet_ultimate <- 
  seq_along(fimon_sf2) %>%
  furrr::future_map(function(k) {
    p()
    purrr::map_dbl(seq_len(365),
                   function(i) {
                     splash::calc_daily_evap(lat = LAT,
                                             n = i,
                                             elv = fimon_elv,
                                             y = year,
                                             sf = fimon_sf2[k],
                                             tc = fimon_tmp[i] +
                                               fimon_anomalies[k][[1]][i],
                                             ke = fimon_orb_params$ecc[k],
                                             keps = fimon_orb_params$eps[k],
                                             komega = fimon_orb_params$varpi[k])$pet_mm
                   })
  })} %>% 
  progressr::with_progress()
future::plan(oplan)

fimon_corrected_pr_ultimate <- purrr::map_dbl(seq_along(fimon_pet_ultimate),
                                     ~sum(fimon_pet_ultimate[.x][[1]], na.rm = TRUE) * fimon2$corr_mi[.x])
```


```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

## Plots
<!-- ### Modern PET -->
<!-- Obtained from CRU TS 4.04 -->
```{r, echo = FALSE, eval = FALSE}
tibble::tibble(x = seq_len(365),
               y = fimon_pet_modern) %>%
  ggplot2::ggplot(ggplot2::aes(x, y)) +
  ggplot2::geom_line() +
  ggplot2::labs(x = "[days]",
                y = "PET [mm/day]") +
  ggplot2::scale_x_continuous(breaks = c(1, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365)) +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE, eval = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `MI`: Past CO2 calculated using `mean`

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi, 
                     fimon2$corr_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(fimon2))) %>%
ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_line() +
  ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
  ggplot2::theme_bw()
```

- `age < 22k`
```{r, echo = FALSE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi, 
                     fimon2$corr_mi),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(fimon2))) %>%
  .[.$x < 22000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", y = "MI [-]") +
    ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

##### Include past CO2 and Temperature

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi,
                     fimon2$corr_mi),
               co2 = rep(fimon2$past_co2 / 100, 2),
               past_temp = rep(fimon2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(fimon2))) %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

- `age < 22k`

```{r, echo = FALSE, eval = TRUE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon2$recon_mi,
                     fimon2$corr_mi),
               co2 = rep(fimon2$past_co2 / 100, 2),
               past_temp = rep(fimon2$past_temp / 5, 2),
               var = rep(c("MI: reconstructed",
                           "MI: corrected"),
                        each = nrow(fimon2))) %>%
  .[.$x < 22000, ] %>%
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x, y, colour = var)) +
  ggplot2::geom_point(ggplot2::aes(x, co2, colour = "past CO2 [1/100]")) +
  ggplot2::geom_line(ggplot2::aes(x, past_temp, colour = "Temp")) +
  ggplot2::scale_colour_manual(name = NULL, 
                             values = c("past CO2 [1/100]" = "gold",
                                        "Temp" = "black",
                                        "MI: reconstructed" = "#E41A1C",
                                        "MI: corrected" = "#377EB8")) +
  # ggplot2::scale_colour_brewer(name = "MI", palette = "Set1") +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15),
                              sec.axis = ggplot2::sec_axis(~.*5,
                                                           name = "Temp [°C]",
                                                           breaks = scales::pretty_breaks(15))
  ) +
  ggplot2::labs(x = "Age [cal yrs BP]",
  # title = "CO2 [1/100 ppm] (gold dots) and Temp [°C] (black line)",
  y = "MI [-] and CO2 [1/100 ppm]") +
  ggplot2::theme_bw()
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

#### Reconstructed vs corrected `P_ann`: Past CO2 calculated using `mean`

##### With MI ratio

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\hfill\\break')
```

```{r, echo = FALSE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon$P_ann, 
                     fimon2$corr_P_ann),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(fimon2))) %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", 
                  y = "Annual precipitation [mm/year]") +
    theme_pet
```

- `age < 22k`

```{r, echo = FALSE}
tibble::tibble(x = rep(fimon2$age_calBP, 2),
               y = c(fimon$P_ann, 
                     fimon2$corr_P_ann),
               var = rep(c("Reconstructed", 
                           "Corrected"), 
                         each = nrow(fimon2))) %>%
  .[.$x < 22000, ] %>%
  ggplot2::ggplot(ggplot2::aes(x, y, colour = var)) +
    ggplot2::geom_line() +
    ggplot2::scale_colour_brewer(name = "P_ann", palette = "Dark2") + 
    ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(15)) +
    ggplot2::labs(x = "Age [cal yrs BP]", 
                  y = "Annual precipitation [mm/year]") +
    theme_pet
```

```{r, include=knitr::is_latex_output(), echo = FALSE}
knitr::asis_output('\n\n\\newpage')
```

# Appendix

## A1. Lago di Fimon Data
Download the CSV file: [fimon-with-corrected-mi.csv](https://raw.githubusercontent.com/special-uor/codos/main/inst/extdocs/fimon-with-corrected-mi.csv)

```{r, echo = FALSE}
fimon2 %>%
  dplyr::select(-dplyr::ends_with(("loess"))) %>%
  knitr::kable(longtable = TRUE)
```
