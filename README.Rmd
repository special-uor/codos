---
output: 
  github_document:
    pandoc_args: --webtex
# ='https://latex.codecogs.com/png.latex?%5Cdpi{300}'
bibliography: inst/references/references.bib
cls: inst/references/proceedings-of-the-royal-society-a.csl
---
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dpi = 700
)
```

# CO<sub>dos</sub>: CO<sub>2</sub> Correction Tools 
<!-- <img src="inst/images/logo.png" alt="logo" align="right" height=200px/> -->

<!-- badges: start -->
`r badger::badge_devel("special-uor/codos", "yellow")`
`r badger::badge_cran_release("codos", "black")`
`r badger::badge_github_actions("special-uor/codos")`
<!-- badges: end -->

## Installation

You can install the released version of codos from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("codos")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("special-uor/codos", "dev")
```
<!-- ## Example -->

<!-- - CRU TS 4.04: [inst/extdocs/cru-ts-4.04.md](inst/extdocs/cru-ts-4.04.md) -->

## Background:

### Vapour-pressure deficit (`vpd`)
`vpd` is given by mean daily growing season temperature, `tmp` [Â°C] and moisture index, `mi` [-]. Using the CRU TS 4.04 dataset [@cru404] we found the following relation:

$$
vpd = 4.589 \times \exp(0.0611 \times tmp - 0.87 \times mi)
$$

The steps performed were:

1. Generate a monthly climatology for the period between 1961 and 1990 (inclusive). Variables used: `cld`, `pre`, `tmn`, `tmx`, `vap`.
  
  ```{r, eval = FALSE, echo = TRUE}
  # Monthly climatology for `tmn`
  codos::monthly_clim("cru_ts4.04.1901.2019.tmn.dat.nc", "tmn", 1961, 1990)
  ```

2. Interpolate the monthly data to daily. Variables used: `cld`, `pre`, `tmn`, `tmx`, `vap`.

  ```{r, eval = FALSE, echo = TRUE}
  # Monthly to daily interpolation for `tmn`
  codos::nc_int("cru_ts4.04.1901.2019.tmn.dat-clim-1961-1990.nc", "tmn")
  ```
  
3. Calculate daily temperature. Variables used: `tmn` and `tmx`.

  ```{r, eval = FALSE, echo = TRUE}
  codos::daily_temp(tmin = list(filename = "cru_ts4.04.1901.2019.tmn.dat-clim-1961-1990-int.nc",
                                id = "tmn"),
                    tmax = list(filename = "cru_ts4.04.1901.2019.tmx.dat-clim-1961-1990-int.nc", 
                                id = "tmx"),
                    output_filename = "cru_ts4.04-clim-1961-1990-daily.tmp.nc")
  ```
  
4. Calculate mean growing season for daily temperature

  ```{r, eval = FALSE, echo = TRUE}
  codos::nc_gs("cru_ts4.04-clim-1961-1990-daily.tmp.nc", "tmp", thr = 0)
  ```
  
5. Calculate potential evapotranspiration (`pet`)

  ```{r, eval = FALSE, echo = TRUE}
  elv <- codos:::nc_var_get("halfdeg.elv.nc", "elv")$data
  tmp <- codos:::nc_var_get("cru_ts4.04.1901.2019.daily.tmp.nc", "tmp")$data
  cld <- codos:::nc_var_get("cru_ts4.04.1901.2019.cld.dat-clim-1961-1990-int.nc", "cld")$data
  
  codos::splash_evap(output_filename = "cru_ts4.04-clim-1961-1990-pet.nc", 
                     elv, # Elevation, 720x360 grid 
                     sf = 1 - cld / 100, 
                     tmp, 
                     year = 1961, # Reference year 
                     lat = codos::lat, 
                     lon = codos::lon)
  ```

6. Calculate moisture index (`mi`)

$$MI_{i,j} = \frac{\text{Total precipitation}}{\text{Total PET}}$$

  ```{r, eval = FALSE, echo = TRUE}
  pet <- codos:::nc_var_get("cru_ts4.04-clim-1961-1990-pet.nc", "pet")$data
  pre <- codos:::nc_var_get("cru_ts4.04.1901.2019.pre.dat-new-clim-1961-1990-int.nc", "pre")$data
  codos::nc_mi(output_filename = "cru_ts4.04-clim-1961-1990-mi.nc", 
               pet, # potential evapotranspiration
               pre) # precipitation
  ```

# References

<!-- [1] University of East Anglia Climatic Research Unit; Harris, I.C.; Jones, P.D.;  -->
<!-- Osborn, T. (2020): CRU TS4.04: Climatic Research Unit (CRU) Time-Series (TS) -->
<!-- version 4.04 of high-resolution gridded data of month-by-month variation in -->
<!-- climate (Jan. 1901- Dec. 2019). Centre for Environmental Data Analysis. -->
<!-- <https://catalogue.ceda.ac.uk/uuid/89e1e34ec3554dc98594a5732622bce9> -->
